# run.py 스크립트 구조 상세 요약

> MJ경매 이미지 등록(캡처) 자동화 스크립트. 추가/수정 시 이 문서를 참고하세요.

---

## 1. 상단: 출력문·임포트

| 항목 | 내용 |
|------|------|
| **출력** | `"📢 MJ경매 최종 완결 (법원명수정 + 공매강제 + 괄호인식 + 합체캡처)..."` |
| **표준/시스템** | `base64`, `time`, `os`, `re`, `traceback`, `datetime` |
| **Selenium** | `webdriver`, `By`, `Keys`, `Service`, `ChromeDriverManager`, `WebDriverWait`, `EC` |

---

## 2. 설정 블록

### 2-1. 계정·경로

| 변수 | 용도 |
|------|------|
| `ACCOUNTS` | 로그인 계정 리스트 `[{"id","pw"}, ...]` (2개) |
| `BASE_SAVE_DIR` | 캡처 PNG 저장 경로 (G드라이브) |

### 2-2. 법원 매핑

| 변수 | 용도 |
|------|------|
| `COURT_MAP` | 지역/주소 키워드 → 법원명(서울중앙, 수원 등) 매핑. 공백 포함 키워드는 먼저 매칭 |

### 2-3. 셀렉터 (로그인·공매)

| 변수 | 대상 |
|------|------|
| `SELECTOR_ID` | 로그인 ID 입력창 `client_id` |
| `SELECTOR_PW_DUMMY` | 더미 비밀번호 필드 `pw_Dummy` |
| `SELECTOR_PW_REAL` | 실제 비밀번호 필드 `passwd` |
| `SELECTOR_LOGIN_BTN` | 로그인 버튼 (div 내 a 또는 login 이미지 버튼) |
| `SELECTOR_RADIO_GONGMAE` | 공매 라디오 `#itype2` |
| `SELECTOR_SEARCH_BTN` | 검색 버튼 `#btnSrch` |

### 2-4. 스킵 키워드

| 변수 | 용도 |
|------|------|
| `SKIP_KEYWORDS` | 테이블 텍스트에 포함되면 **물건 테이블 후보에서 제외** ("나의 분류관리", "엑셀저장", "매각기일 변경공지", "정렬/보기", "검색") |

---

## 3. [함수 1] 법원명 매칭 — `get_court_from_text(text)`

- **입력**: 물건/헤더에서 추출한 텍스트.
- **동작**:
  1. `COURT_MAP`을 순회하며 **공백이 포함된 키워드**가 텍스트에 있으면 해당 법원명 반환.
  2. 없으면 **나머지 키워드**로 매칭.
  3. 매칭 실패 시 `"기타"` 반환.
- **용도**: 파일명의 법원명 부분 결정 (경매만 사용, 공매는 `"공매"` 고정).

---

## 4. [함수 2] 팝업 제거 — `remove_popups_css(driver)` (상세)

- **목적**: 페이지 위에 떠 있는 레이어/팝업을 **CSS로 숨겨** 클릭·캡처 방해를 제거.

### 4-1. 대상 요소 (CSS 선택자)

| 선택자 | 의미 |
|--------|------|
| `#inter_popup` | ID가 `inter_popup`인 요소 (사이트 공통 팝업으로 추정) |
| `.layer` | 클래스에 `layer` 포함 (레이어 팝업) |
| `.popup` | 클래스에 `popup` 포함 |
| `div[id^='layer']` | id가 `layer`로 **시작**하는 div |
| `div[class*='popup']` | class에 `popup` **포함**하는 div |
| `#div_pop_back` | 배경 딤(뒷배경) 영역 |

### 4-2. 적용 스타일

- `display: none !important`
- `visibility: hidden !important`
- `opacity: 0 !important`
- `pointer-events: none !important` — 클릭 불가로 처리
- `z-index: -9999 !important` — 뒤로 보냄

### 4-3. 구현 방식

- **방식**: `<style>` 태그를 동적으로 만들어 `document.head`에 추가.
- **실행**: `driver.execute_script(...)` 로 페이지 내 JavaScript 실행.
- **예외**: `try/except`로 감싸 실패 시 `pass` (스크립트 중단 없음).
- **대기**: 적용 후 `time.sleep(0.5)`.

### 4-4. 호출 시점 (현재)

1. **로그인 페이지 로드 직후** — `driver.get(login_box.php)` 다음.
2. **리스트 페이지 처리 시작 시** — `process_list_page()` **맨 앞**에서 1회.

### 4-5. 추가 시 고려할 점

- **새 팝업 ID/클래스**: 사이트가 바뀌면 선택자에 `#새ID`, `.새클래스` 추가.
- **특정 팝업만 닫기**: 닫기 버튼 클릭이 필요하면 `remove_popups_css` 외에 `driver.find_element(...).click()` 로직 추가.
- **반복 제거**: 페이지 전환·스크롤 후에도 팝업이 다시 뜨면 `process_list_page` 내부나 캡처 직전 등에서 `remove_popups_css(driver)` 한 번 더 호출.

---

## 4-2. [함수 2-1] 정렬/개수/검색 — `apply_list_options_and_search(driver)` (캡처 직전)

- **목적**: 캡처 전에 리스트를 **등록일↓** 정렬, **20개** 단위로 보기, **검색** 실행.
- **동작**:
  1. `#order_type` Select → `select_by_value("idx desc")` (등록일↓).
  2. `#list_scale` Select → `select_by_value("20")` (20개).
  3. `#btnSrch` 클릭 후 2초 대기.
- **호출 시점**: 경매·공매 모두 **관심물건 진입 → 팝업 제거 → apply_list_options_and_search → process_list_page(캡처)**.

---

## 5. [함수 3] 헤더+테이블 합체 캡처 — `capture_combined_element(driver, header_element, table_element, file_path)`

- **목적**: 헤더 요소와 테이블 요소를 **한 번에 이어 붙인 영역**만 잘라 PNG로 저장.

### 5-1. 단계

1. **스크롤**: 헤더를 뷰포트 중앙으로 `scrollIntoView({block: 'center'})`, 0.2초 대기.
2. **좌표**:  
   - 헤더/테이블 각각 `getBoundingClientRect()`  
   - `pageXOffset` / `pageYOffset` 로 스크롤 보정  
   - x = 테이블 left + scrollX, y = 헤더 top + scrollY  
   - width = 테이블 width  
   - height = (테이블 top + height) - 헤더 top
3. **유효성**: width/height ≤ 0 이면 `False` 반환.
4. **캡처**: CDP `Page.captureScreenshot` with `clip`, `captureBeyondViewport: true`, `format: "png"`.
5. **저장**: 기존 파일 있으면 삭제 후 base64 디코딩하여 `file_path`에 저장, 성공 시 `True`.

### 5-2. 실패 시

- 예외 또는 잘못된 영역이면 `False` 반환, 상위에서 "캡처 실패" 처리.

---

## 6. [함수 4] 날짜 추출 — `extract_smart_date(header_text, type_prefix)`

- **입력**: 헤더 텍스트, 구분(`"경매"` / `"공매"`).
- **출력**: 6자리 문자열 `YYMMDD` (예: `250130`), 실패 시 `"000000"`.

### 6-1. 공매 (`type_prefix == "공매"`)

- 패턴: `(\d{1,2})[./](\d{1,2})\s+(\d{1,2}):(\d{1,2})` (예: `12/23 10:00`).
- 연도: **현재 연도** 사용 → `str(today_year)[2:]` + month + day.

### 6-2. 경매

- 패턴: `(20\d{2})[.-](\d{1,2})[.-](\d{1,2})` (예: `2025.02.14`).
- 연도: 매칭된 연도 2자리 사용.

---

## 7. [함수 5] 리스트 처리 — `process_list_page(driver, save_dir, type_prefix)`

- **역할**: 현재 페이지에서 "물건 테이블"만 골라, **메모 있는 것만** 합체 캡처 후 저장.

### 7-1. 흐름 요약

1. **팝업 제거**: `remove_popups_css(driver)` 호출.
2. **테이블 대기**: `WebDriverWait`로 `table` 등장 대기, 2초 추가 대기.
3. **후보 수집**:  
   - 모든 `table` 중  
   - 높이 > 100  
   - 텍스트에 `SKIP_KEYWORDS` 없음  
   - `("사건번호" or "관리번호") and "감정가"` → `candidates`에 추가.
4. **후보 없음**: 메시지 출력 후 return.
5. **후보별 처리**:
   - **메모 체크**: "메모" 줄에 콜론/라벨 제거 후 공백 아닌 내용이 있으면 메모 있음. 없으면 스킵.
   - **헤더**: 테이블의 `preceding-sibling::*[1]` 또는 자기 자신.
   - **사건번호**: 정규식 `20\d{2}-\d+[\d-]*(?:\(\d+\))?` (괄호 번호 포함). 경매는 `-` → `타경` 변환 등.
   - **날짜**: `extract_smart_date(header_text, type_prefix)`.
   - **법원**: 공매면 `"공매"`, 경매면 `get_court_from_text(full_text)`.
   - **파일명**: `{사건번호}_{날짜}_{법원}.png`, 파일명에 사용 불가 문자 제거.
   - **캡처**: `capture_combined_element(driver, header_element, item, file_path)` 호출 후 성공 시 로그.
6. **마무리**: 저장 건수·메모 없음 제외 건수 출력.

---

## 8. 메인 실행부 — `run_macro(account)`

### 8-1. 초기화

- `save_dir = BASE_SAVE_DIR`, `os.makedirs(save_dir, exist_ok=True)`.
- Chrome 옵션: 1920x1080, scale 1, disable-gpu, detach.
- `WebDriverWait(driver, 15)`.

### 8-2. 로그인

1. `driver.get("https://www.auction1.co.kr/common/login_box.php")`.
2. **팝업 제거** `remove_popups_css(driver)`.
3. ID 요소 대기 후, JS로 ID/PW 입력 (dummy 숨기고 real에 비밀번호).
4. 로그인: `SELECTOR_LOGIN_BTN` 클릭 시도, 실패 시 PW 필드에 Enter.
5. 2초 대기.

### 8-3. 경매 리스트 (TOBE: 관심물건 진입 → 팝업 제거 → 정렬/개수/검색 → 캡처)

1. `driver.get("https://www.auction1.co.kr/member/inter_list.php")`.
2. `remove_popups_css(driver)`, 1초 대기.
3. `apply_list_options_and_search(driver)` — 정렬 등록일↓, 개수 20, 검색 클릭.
4. `process_list_page(driver, save_dir, "경매")`.

### 8-4. 공매 전환 및 리스트

1. `#itype2` JS 클릭, 1초 대기.
2. `remove_popups_css(driver)`.
3. `apply_list_options_and_search(driver)` — 정렬 등록일↓, 개수 20, 검색 클릭.
4. `process_list_page(driver, save_dir, "공매")`.
5. 예외 시 메시지 출력만 하고 계속.

### 8-5. 정리

- 예외 시 `traceback.print_exc()`.
- `finally`에서 계정명 출력 후 `driver.quit()`.

---

## 9. 진입점 — `if __name__ == "__main__"`

- `ACCOUNTS`를 순회하며 `run_macro(acc)` 호출.
- 계정 간 3초 대기.
- 마지막에 `"🎉 모든 작업 완료!"` 출력.

---

## 10. 추가/개선 시 참고 체크리스트

| 구분 | 현재 상태 | 추가 시 참고 |
|------|-----------|--------------|
| **팝업 제거** | 로그인 직후 + 리스트 분석 시작 시 1회 | 새 팝업 선택자 추가, 필요 시 캡처 직전 재호출 |
| **팝업 닫기 버튼** | 없음 (CSS 숨김만) | 특정 팝업은 `find_element` + `click()` 추가 |
| **저장 경로** | 단일 폴더 | 법원/날짜별 하위 폴더 생성 로직 추가 가능 |
| **재시도** | 없음 | 로그인/페이지 로드 실패 시 재시도 루프 |
| **로그** | print만 | 파일 로깅 또는 레벨(INFO/ERROR) 분리 |
| **에러 알림** | traceback만 | 메일/슬랙 등 알림 연동 |
| **헤더/테이블 셀렉터** | 태그+형제 관계 의존 | 사이트 변경 시 셀렉터 상수화 및 조정 |
| **계정 실패** | 다음 계정으로 진행 | 계정별 성공/실패 집계 후 보고 |

이 문서는 `run.py`와 함께 두고, 수정·추가 시 위 구조와 호출 시점을 맞추면 됩니다.
