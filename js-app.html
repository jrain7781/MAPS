<script>
    // =============================================================================
    // MJ경매 입찰 관리 시스템 - 통합 JavaScript
    // =============================================================================
    // 통합일: 2026-01-23
    // 통합 파일: js-base.html + js-render.html + js-logic.html -> js-app.html

    // =============================================================================
    // 1. 초기화 및 전역 변수
    // =============================================================================

    // 기기 고유 ID (UUID) 생성 및 관리 로직
    function getOrCreateDeviceId() {
        const STORAGE_KEY = 'mj_auction_device_uuid';
        let deviceId = localStorage.getItem(STORAGE_KEY);

        if (!deviceId) {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                deviceId = crypto.randomUUID();
            } else {
                deviceId = 'user-' + new Date().getTime() + '-' + Math.floor(Math.random() * 100000);
            }
            localStorage.setItem(STORAGE_KEY, deviceId);
        }
        return deviceId;
    }

    // [Utility] HTML 이스케이프 함수 (XSS 방지)
    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    const currentDeviceId = getOrCreateDeviceId();
    console.log("Current Device ID:", currentDeviceId);

    // --- DOM 요소 참조 (공통 사용) ---
    const dataTableBody = document.getElementById('dataTableBody');
    const statusMessage = document.getElementById('statusMessage');
    const dataForm = document.getElementById('dataForm');
    const formTitle = document.getElementById('formTitle');
    const currentIdDisplay = document.getElementById('currentIdDisplay');

    // 검색 필터 (입찰물건 관리)
    const searchIndateInput = document.getElementById('search-indate');
    const searchSakunNoInput = document.getElementById('search-sakunno');
    const searchCourtInput = document.getElementById('search-court');
    const searchRegDateInput = document.getElementById('search-regdate');
    const searchManagerInput = document.getElementById('search-manager');
    const searchMNameInput = document.getElementById('search-mname');

    // 버튼들
    const createTopButton = document.getElementById('createTopButton');
    const editTopButton = document.getElementById('editTopButton');
    const deleteTopButton = document.getElementById('deleteTopButton');
    const goBackToCreateButton = document.getElementById('goBackToCreateButton');

    // 메인 폼 입력 필드
    const formId = document.getElementById('formId');
    const formInDate = document.getElementById('form-in-date');
    const formSakunNo = document.getElementById('form-sakun-no');
    const formCourt = document.getElementById('form-court');
    const formStuMember = document.getElementById('form-stu-member');
    const formMName = document.getElementById('form-m-name');
    const formMemberId = document.getElementById('form-member-id');
    const formMNameId = document.getElementById('form-m-name-id');
    const formBidPrice = document.getElementById('form-bidprice');
    const formImageId = document.getElementById('form-image-id');
    const formNote = document.getElementById('form-note');
    const formRegMember = document.getElementById('form-reg-member');

    // 로딩 및 알림
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noDataMessage = document.getElementById('noDataMessage');
    const dashboardLoading = document.getElementById('dashboard-loading');

    // 캘린더 DOM
    const calendarDaysContainer = document.getElementById('calendar-days-container');
    const calendarDaysContainerWeek = document.getElementById('calendar-days-container-week');
    const calendarDaysContainerMonth = document.getElementById('calendar-days-container-month');
    const calendarDaysContainerMonthSummary = document.getElementById('calendar-days-container-month-summary');
    const calendarLoading = document.getElementById('calendar-loading');
    const calendarTitle = document.getElementById('calendar-title');
    const calendarTitleContainer = document.getElementById('calendar-title-container');
    let currentCalendarView = 'week'; // 'week' or 'month' or 'month-summary'
    let numWeeksBefore = 0; // 동적으로 변경되는 이전 주 개수 (초기값 0)
    let isLoadingPreviousWeeks = false; // 이전 주 로딩 중 플래그
    const calendarFilterBanner = document.getElementById('calendarFilterBanner');
    const calendarFilterText = document.getElementById('calendarFilterText');
    const calSearchSakunno = document.getElementById('cal-search-sakunno');
    const calSearchCourt = document.getElementById('cal-search-court');
    const calSearchStatusBtn = document.getElementById('cal-search-status-btn');
    const calSearchStatusLabel = document.getElementById('cal-search-status-label');
    const calSearchMember = document.getElementById('cal-search-member');
    const calSearchManager = document.getElementById('cal-search-manager');

    // 월별/월별(법원) 년월 네비(날짜 표시) 위치 보정:
    // - '대표님'이 표시되는 담당자(드롭다운) 폭만큼 + 약간(여유) 우측으로 밀어 정렬/간격 확보
    function syncCalendarMonthNavOffset() {
        try {
            if (!calendarTitleContainer) return;
            const managerSelect = calSearchManager || document.getElementById('cal-search-manager');
            if (!managerSelect) return;
            const wrap = managerSelect.closest('div') || managerSelect;
            const w = (wrap && wrap.offsetWidth) ? wrap.offsetWidth : (managerSelect.offsetWidth || 0);
            if (w && w > 0) {
                calendarTitleContainer.style.setProperty('--cal-manager-width', `${w}px`);
            } else {
                calendarTitleContainer.style.setProperty('--cal-manager-width', '80px');
            }
        } catch (e) {
            // UI 보정 실패 시에도 앱 기능은 유지
        }
    }

    // 대시보드 DOM
    const missingBidTableBody = document.getElementById('missingBidTableBody');
    const statusTableBody = document.getElementById('statusTableBody');
    const memberBidChartCanvas = document.getElementById('memberBidChart');
    const summaryText = document.getElementById('summaryText');

    // 모달 DOM
    const itemDetailModal = document.getElementById('itemDetailModal');
    const modalFormId = document.getElementById('modalFormId');
    const modalFormInDate = document.getElementById('modal-form-in-date');
    const modalFormSakunNo = document.getElementById('modal-form-sakun-no');
    const modalFormCourt = document.getElementById('modal-form-court');
    const modalFormStuMember = document.getElementById('modal-form-stu-member');
    const modalFormMName = document.getElementById('modal-form-m-name');
    const modalFormMemberId = document.getElementById('modal-form-member-id');
    const modalFormMNameId = document.getElementById('modal-form-m-name-id');
    const modalFormBidPrice = document.getElementById('modal-form-bidprice');
    const modalFormImageId = document.getElementById('modal-form-image-id');
    const modalFormRegMember = document.getElementById('modal-form-reg-member');

    var courtListCache = null;
    function fillCourtDatalist(list) {
        // 모든 court-datalist 요소에 채우기
        var datalists = ['court-datalist', 'cal-court-datalist', 'search-court-datalist', 'modal-court-datalist'];
        datalists.forEach(function (datalistId) {
            var dl = document.getElementById(datalistId);
            if (!dl) return;
            dl.innerHTML = '';
            (list || []).forEach(function (c) { var o = document.createElement('option'); o.value = c; dl.appendChild(o); });
        });
    }
    function fillCourtDatalistFiltered(inputValue) {
        if (!courtListCache || courtListCache.length === 0) return;

        // 현재 포커스된 입력 필드에 따라 datalist 결정
        const activeElement = document.activeElement;
        let datalistId = 'court-datalist'; // 기본값

        if (activeElement && activeElement.id === 'modal-form-court') {
            datalistId = 'modal-court-datalist';
        } else if (activeElement && activeElement.id === 'form-court') {
            datalistId = 'court-datalist';
        }

        var dl = document.getElementById(datalistId);
        if (!dl) return;
        dl.innerHTML = '';
        var search = (inputValue || '').trim().toLowerCase();
        courtListCache.forEach(function (c) {
            if (!search || c.toLowerCase().indexOf(search) !== -1) {
                var o = document.createElement('option');
                o.value = c;
                dl.appendChild(o);
            }
        });
    }
    function ensureCourtListLoaded(callback) {
        if (courtListCache && courtListCache.length > 0) {
            fillCourtDatalist(courtListCache);
            if (callback) callback();
            return;
        }
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            if (callback) callback();
            return;
        }
        google.script.run.withSuccessHandler(function (list) {
            courtListCache = list || [];
            fillCourtDatalist(courtListCache);
            if (callback) callback();
        }).withFailureHandler(function () {
            courtListCache = [];
            if (callback) callback();
        }).getCourtList();
    }

    function fillMemberDatalist() {
        var dl = document.getElementById('modal-member-datalist');
        if (!dl) return;
        dl.innerHTML = '';
        if (allMemberData && allMemberData.length > 0) {
            allMemberData.forEach(function (m) {
                if (m && m.member_id) {
                    var o = document.createElement('option');
                    o.value = m.member_name || m.member_id;
                    dl.appendChild(o);
                }
            });
        }
    }

    function ensureMemberListLoaded(callback) {
        if (allMemberData && allMemberData.length > 0) {
            fillMemberDatalist();
            if (callback) callback();
            return;
        }
        // 이미 로드된 데이터가 있으면 사용
        fillMemberDatalist();
        if (callback) callback();
    }

    // 회원 관리 DOM (지연 초기화 함수)
    function getMemberDataTableBody() {
        return document.getElementById('memberDataTableBody');
    }
    function getMemberForm() {
        return document.getElementById('memberForm');
    }
    function getMemberFormTitle() {
        return document.getElementById('memberFormTitle');
    }
    function getSearchMemberKeyword() {
        return document.getElementById('search-member-keyword');
    }
    function getBtnCreateMember() {
        return document.getElementById('btnCreateMember');
    }
    function getBtnUpdateMember() {
        return document.getElementById('btnUpdateMember');
    }
    function getBtnDeleteMember() {
        return document.getElementById('btnDeleteMember');
    }

    // 호환성을 위한 변수 (지연 초기화)
    let memberDataTableBody = null;
    let memberForm = null;
    let memberFormTitle = null;
    let searchMemberKeyword = null;
    let btnCreateMember = null;
    let btnUpdateMember = null;
    let btnDeleteMember = null;

    // DOM 로드 후 초기화
    function initMemberDOM() {
        memberDataTableBody = getMemberDataTableBody();
        memberForm = getMemberForm();
        memberFormTitle = getMemberFormTitle();
        searchMemberKeyword = getSearchMemberKeyword();
        btnCreateMember = getBtnCreateMember();
        btnUpdateMember = getBtnUpdateMember();
        btnDeleteMember = getBtnDeleteMember();
    }

    // 회원 폼 필드
    const memId = document.getElementById('mem-member_id');
    const memName = document.getElementById('mem-name');
    const memRole = document.getElementById('mem-role');
    const memPhone = document.getElementById('mem-phone');
    const memClassName = document.getElementById('mem-class_name');
    const memLoginId = document.getElementById('mem-login_id');
    const memPassword = document.getElementById('mem-password');
    const memAccountNo = document.getElementById('mem-account_no');
    const memRrn = document.getElementById('mem-rrn');
    const memAddress = document.getElementById('mem-address');
    const memNote1 = document.getElementById('mem-note1');
    const memNote2 = document.getElementById('mem-note2');
    const memRegDate = document.getElementById('mem-reg_date');
    const memMemberToken = document.getElementById('mem-member_token');
    const memTelegramChatId = document.getElementById('mem-telegram_chat_id');
    const memTelegramEnabled = document.getElementById('mem-telegram_enabled');

    // --- 상태 변수 ---
    let currentMode = 'create';
    let activeRow = null;
    let currentDetailItem = null;  // 입찰물건 상세/조사 탭용 (선택된 행 데이터)
    var currentItemDetailTab = 'detail';  // 리스트에서 다른 물건 선택 시 유지할 탭
    let allBiddingData = [];
    let allMemberData = [];
    let allMembersData = [];  // 회원 자동완성용 데이터
    // 오늘 날짜가 포함된 주의 월요일로 초기화
    let currentCalendarDate = (function () {
        const today = new Date();
        return getWeekStart(today);
    })();
    let memberBidChartInstance = null;

    let dashboardFilter = { active: false, date: null, status: null, type: null, manager: null };
    let calendarFilter = { active: false, member: null, status: null };
    let itemListSort = { key: null, dir: 1 };

    // 데이터 캐시 관리
    let dataCache = { data: null, timestamp: 0 };
    const CACHE_DURATION = 30000; // 30초 캐시 유지

    // =============================================================================
    // 1.5. 실행 컨텍스트(회원 전용 링크)
    // =============================================================================
    function getQueryParams_() {
        // URLSearchParams가 없는 환경/예외까지 대비한 파서
        try {
            const search = String(window.location && window.location.search ? window.location.search : '');
            const raw = search.startsWith('?') ? search.slice(1) : search;
            const out = { view: '', token: '', itemId: '' };

            // 1) 표준 파서 우선
            if (typeof URLSearchParams !== 'undefined') {
                const p = new URLSearchParams(search || '');
                out.view = String(p.get('view') || '').trim();
                // token 파라미터 키는 t(현재), token(예비) 둘 다 허용
                out.token = String(p.get('t') || p.get('token') || '').trim();
                out.itemId = String(p.get('item') || '').trim();
                // Apps Script doGet에서 주입된 파라미터도 병합 (텔레그램/리다이렉트 환경에서 URL 파라미터가 비는 경우 방어)
                try {
                    const injected = (window && window.__MJ_GAS_PARAMS__) ? window.__MJ_GAS_PARAMS__ : null;
                    if (injected && typeof injected === 'object') {
                        if (!out.view) out.view = String(injected.view || '').trim();
                        if (!out.token) out.token = String(injected.t || injected.token || '').trim();
                        if (!out.itemId) out.itemId = String(injected.item || '').trim();
                    }
                } catch (e) { }
                return out;
            }

            // 2) fallback: 수동 파싱
            if (!raw) return out;
            raw.split('&').forEach(pair => {
                const idx = pair.indexOf('=');
                const k = decodeURIComponent((idx >= 0 ? pair.slice(0, idx) : pair) || '').trim();
                const v = decodeURIComponent((idx >= 0 ? pair.slice(idx + 1) : '') || '').trim();
                if (k === 'view') out.view = v;
                if (k === 't' || k === 'token') out.token = v;
                if (k === 'item') out.itemId = v;
            });
            // 주입 파라미터 병합
            try {
                const injected = (window && window.__MJ_GAS_PARAMS__) ? window.__MJ_GAS_PARAMS__ : null;
                if (injected && typeof injected === 'object') {
                    if (!out.view) out.view = String(injected.view || '').trim();
                    if (!out.token) out.token = String(injected.t || injected.token || '').trim();
                    if (!out.itemId) out.itemId = String(injected.item || '').trim();
                }
            } catch (e) { }
            return out;
        } catch (e) {
            return { view: '', token: '', itemId: '' };
        }
    }
    const APP_CTX = getQueryParams_();
    // token(t)만 있어도 무조건 회원 전용 모드로 간주 (view 파라미터 누락/파싱 실패 대비)
    const IS_MEMBER_VIEW = (!!APP_CTX.token) || (APP_CTX.view === 'member') || (APP_CTX.view === 'schedule');

    // [추가] 모바일 환경 감지
    const IS_MOBILE_UA = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const IS_MOBILE_WIDTH = window.innerWidth < 768;
    const IS_MOBILE = IS_MOBILE_UA || IS_MOBILE_WIDTH;
    window.__MJ_IS_MOBILE__ = IS_MOBILE;

    try {
        window.__MJ_MEMBER_VIEW__ = IS_MEMBER_VIEW;
        console.log('[MemberView]', IS_MEMBER_VIEW, 'isMobile:', IS_MOBILE, APP_CTX);
    } catch (e) { }

    function applyMemberViewUiGuards_() {
        if (!IS_MEMBER_VIEW) return;

        try {
            if (typeof showStatus === 'function') {
                showStatus('회원 전용 모드로 접속했습니다.', 'success');
            }
        } catch (e) { }

        // 사이드바: 관리자 메뉴 숨기고 회원 메뉴만 표시
        const adminMenuIds = ['menu-Dashboard', 'menu-BiddingSchedule', 'menu-ItemManagement', 'menu-MemberManagement', 'menu-ClassManagement', 'menu-ClassSchedule', 'menu-Preferences'];
        adminMenuIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add('content-hidden');
                el.style.setProperty('display', 'none', 'important');
            }
        });

        // 회원 전용 메뉴 표시
        document.querySelectorAll('.member-only-menu').forEach(el => {
            el.classList.remove('content-hidden');
            el.style.removeProperty('display');
        });

        // 햄버거 버튼은 표시 유지 (회원용 네비게이션을 위해)
        // 전체화면 아이콘은 숨김
        const fsBtn = document.getElementById('btn-fullscreen');
        if (fsBtn) fsBtn.classList.add('content-hidden');

        // 회원에게 허용되지 않는 탭 숨김 (MemberDashboard + BiddingSchedule만 허용)
        const allowedTabs = ['MemberDashboard', 'BiddingSchedule'];
        document.querySelectorAll('.tab-content').forEach(content => {
            if (content && !allowedTabs.includes(content.id)) {
                content.classList.add('content-hidden');
                content.style.setProperty('display', 'none', 'important');
            }
        });

        // 입찰일정 탭에서 "월별"만 보이게 (주별/월별(법원) 버튼 숨김)
        const hideIds = [
            'calendar-tab-week', 'calendar-tab-month-summary',
            'calendar-btn-week', 'calendar-btn-month-summary',
            'cal-search-court', 'cal-search-status-wrap', 'cal-search-member', 'cal-search-manager'
        ];
        hideIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const container = el.closest('div.flex-1, div.flex-shrink-0, div.relative');
                if (container && container !== el) {
                    container.classList.add('content-hidden');
                } else {
                    el.classList.add('content-hidden');
                }
            }
        });

        // 사건번호 검색바 너비 조정
        const sakunWrap = document.getElementById('cal-search-sakunno')?.closest('.flex-1');
        if (sakunWrap) {
            sakunWrap.style.minWidth = '200px';
        }

        // 전체 Layout에 회원 모드 클래스 주입 (CSS에서 활용)
        document.body.classList.add('member-view-mode');

        // PC에서 넓게 보기 강제 수행
        const headerContainer = document.getElementById('header-container');
        if (headerContainer) {
            headerContainer.classList.remove('max-w-full');
            headerContainer.style.maxWidth = 'none';
            headerContainer.style.width = '100%';
        }

        const mainContainer = document.querySelector('header + div .flex-1');
        if (mainContainer) {
            mainContainer.style.maxWidth = 'none';
            mainContainer.style.width = '100%';
        }

        // 검색바 전체 너비로 확장
        const searchArea = document.querySelector('.calendar-view .p-4.bg-gray-50');
        if (searchArea) {
            searchArea.style.maxWidth = 'none';
            searchArea.style.width = '100%';
        }

        // 회원 대시보드를 기본 탭으로 설정
        setTimeout(() => {
            if (IS_MEMBER_VIEW) {
                loadDataAndRenderMemberDashboard(true);
            } else {
                navigateTo('MemberDashboard');
            }
        }, 100);
    }

    // =============================================================================
    // 2. 공통 유틸리티 함수
    // =============================================================================

    // 모바일 메뉴 토글
    function toggleMobileMenu() {
        const sidebar = document.getElementById('mainSidebar');
        const overlay = document.getElementById('mobileMenuOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('open');
    }

    // 전체화면 토글
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                showStatus(`전체화면 전환 실패: ${err.message}`, 'error');
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    // 오늘 날짜(YYMMDD) 구하기
    function getTodayYYMMDD() {
        const date = new Date();
        const year = String(date.getFullYear()).slice(-2);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}${month}${day}`;
    }
    const todayYYMMDD = getTodayYYMMDD();

    // 데이터 정렬 함수
    function dataComparator(a, b) {
        if (a['in-date'] < b['in-date']) return -1;
        if (a['in-date'] > b['in-date']) return 1;
        if (a.sakun_no < b.sakun_no) return -1;
        if (a.sakun_no > b.sakun_no) return 1;
        if (a.m_name < b.m_name) return -1;
        if (a.m_name > b.m_name) return 1;
        return 0;
    }

    // 탭(메뉴) 이동 처리
    // 탭 레이아웃 타입 정의 (확장성 향상)
    const TAB_LAYOUTS = {
        'ItemManagement': 'flex',
        'MemberManagement': 'flex',
        'ClassManagement': 'flex',
        'ClassSchedule': 'flex',
        'Dashboard': 'block',
        'BiddingSchedule': 'block',
        'Preferences': 'block',
        'MemberDashboard': 'block'
        // 새 메뉴 추가 시 여기에 레이아웃 타입 추가
    };

    function navigateTo(tabId) {
        // 회원 전용 링크에서는 대시보드 + 입찰일정만 허용
        if (IS_MEMBER_VIEW && !['BiddingSchedule', 'MemberDashboard'].includes(tabId)) {
            tabId = 'MemberDashboard';
        }

        // 1. 사이드바 처리
        const sidebar = document.getElementById('mainSidebar');
        const overlay = document.getElementById('mobileMenuOverlay');
        if (sidebar && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('open');
        }

        // 2. 메뉴 버튼 활성화
        document.querySelectorAll('nav button').forEach(button => {
            button.classList.remove('menu-active');
        });
        const targetMenuButton = document.getElementById(`menu-${tabId}`);
        // 회원 모드: MemberBiddingSchedule 메뉴 버튼도 활성화 지원
        const altMenuButton = (tabId === 'BiddingSchedule') ? document.getElementById('menu-MemberBiddingSchedule') : null;
        if (targetMenuButton) {
            targetMenuButton.classList.add('menu-active');
        }
        if (altMenuButton) {
            altMenuButton.classList.add('menu-active');
        }

        // 3. 타겟 탭 제외하고 나머지 탭 숨기기 (안정적인 방식)
        document.querySelectorAll('.tab-content').forEach(content => {
            if (content.id !== tabId) {
                content.classList.add('content-hidden');
                content.style.display = 'none';
            }
        });

        // 4. 타겟 탭 표시
        const targetContent = document.getElementById(tabId);
        if (!targetContent) {
            console.error('탭 컨텐츠를 찾을 수 없습니다: ' + tabId);
            return;
        }

        // content-hidden 클래스를 먼저 제거 (CSS !important 우회를 위해)
        targetContent.classList.remove('content-hidden');

        // 기존 인라인 스타일 완전 제거 (초기 인라인 스타일과의 충돌 방지)
        targetContent.style.removeProperty('display');
        targetContent.style.removeProperty('visibility');
        targetContent.style.removeProperty('opacity');

        // 새 스타일 설정 (레이아웃 타입은 객체에서 가져오기)
        const displayValue = TAB_LAYOUTS[tabId] || 'block'; // 기본값: block

        // requestAnimationFrame으로 브라우저 렌더링 사이클에 맞춰 강제 적용
        requestAnimationFrame(() => {
            targetContent.style.setProperty('display', displayValue, 'important');
            targetContent.style.setProperty('visibility', 'visible', 'important');
            targetContent.style.setProperty('opacity', '1', 'important');

            // 한 번 더 확인하여 확실히 적용
            if (targetContent.classList.contains('content-hidden')) {
                targetContent.classList.remove('content-hidden');
            }
            if (getComputedStyle(targetContent).display === 'none') {
                targetContent.style.setProperty('display', displayValue, 'important');
            }
        });

        // 대시보드에 있을 때만 요청 폴링 유지
        try {
            if (tabId === 'Dashboard') startTelegramRequestsPolling_();
            else stopTelegramRequestsPolling_();
        } catch (e) { }

        // 대시보드로 이동 시 요청 목록 즉시 갱신
        if (tabId === 'Dashboard' && !IS_MEMBER_VIEW) {
            try { loadTelegramRequests(); } catch (e) { }
        }

        // 환경설정 탭으로 이동 시 동기화 충돌 내역(대기실) 로드
        if (tabId === 'Preferences' && !IS_MEMBER_VIEW) {
            try { loadSyncConflicts(); } catch (e) { }
        }

        // 회원 대시보드 탭 이동 시 렌더링
        if (tabId === 'MemberDashboard') {
            try {
                if (!allBiddingData || allBiddingData.length === 0) {
                    loadDataAndRenderMemberDashboard();
                } else {
                    renderMemberDashboard();
                }
            } catch (e) { console.error('MemberDashboard render error:', e); }
        }

        // 5. 모바일 화면 처리
        if (tabId === 'ItemManagement' && window.innerWidth < 768) {
            const listPane = document.getElementById('listPane');
            const detailPane = document.getElementById('detailPane');
            if (listPane) listPane.classList.remove('mobile-hidden');
            if (detailPane) {
                detailPane.classList.add('mobile-hidden');
                detailPane.classList.remove('mobile-fullscreen');
            }
        }
        if (tabId === 'MemberManagement' && window.innerWidth < 768) {
            const memberListPane = document.getElementById('memberListPane');
            const memberDetailPane = document.getElementById('memberDetailPane');
            if (memberListPane) memberListPane.classList.remove('mobile-hidden');
            if (memberDetailPane) memberDetailPane.classList.add('mobile-hidden');
        }
        if (tabId === 'ClassManagement' && window.innerWidth < 768) {
            const classListPane = document.getElementById('classListPane');
            const classDetailPane = document.getElementById('classDetailPane');
            if (classListPane) classListPane.classList.remove('mobile-hidden');
            if (classDetailPane) classDetailPane.classList.add('mobile-hidden');
        }
        if (tabId === 'ClassSchedule' && window.innerWidth < 768) {
            const classScheduleListPane = document.getElementById('classScheduleListPane');
            const classScheduleDetailPane = document.getElementById('classScheduleDetailPane');
            if (classScheduleListPane) classScheduleListPane.classList.remove('mobile-hidden');
            if (classScheduleDetailPane) classScheduleDetailPane.classList.add('mobile-hidden');
        }

        // 6. 탭별 데이터 로드 (약간의 지연을 두어 DOM 렌더링 보장)
        setTimeout(() => {
            if (tabId === 'ItemManagement') {
                // 대시보드 필터가 없을 때만 입찰일자 필드를 비움 (오늘 이후 전체 조회)
                // 대시보드에서 진입한 경우에는 syncItemManagementSearchFromDashboard()에서 처리
                if (searchIndateInput && !dashboardFilter.active) {
                    searchIndateInput.value = '';
                }
                syncItemManagementSearchFromDashboard();
                loadData();
                ensureCourtListLoaded();
            } else if (tabId === 'MemberManagement') {
                initMemberDOM();
                loadMembersNew(); // 새 회원관리 함수 사용

            } else if (tabId === 'BiddingSchedule') {
                if (allBiddingData && allBiddingData.length > 0) {
                    updateDashboardFilterOptions();
                }
                // 입찰일정 탭을 누를 때마다 오늘 기준의 주가 맨 위에 보이도록
                currentCalendarDate = getWeekStart(new Date());
                currentCalendarView = IS_MEMBER_VIEW ? 'month' : 'week'; // 회원은 월별만
                // 이전 주 개수 초기화 (탭 전환 시 리셋)
                numWeeksBefore = 0;
                isLoadingPreviousWeeks = false;
                // 탭 UI 초기화
                const weekTab = document.getElementById('calendar-tab-week');
                const monthTab = document.getElementById('calendar-tab-month');
                if (weekTab && monthTab) {
                    if (!IS_MEMBER_VIEW) {
                        weekTab.classList.add('active');
                        weekTab.classList.remove('border-transparent', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-gray-50');
                        monthTab.classList.remove('active');
                        monthTab.classList.add('border-transparent', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-gray-50');
                    } else {
                        monthTab.classList.add('active');
                        monthTab.classList.remove('border-transparent', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-gray-50');
                        weekTab.classList.remove('active');
                        weekTab.classList.add('border-transparent', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-gray-50');
                    }
                }
                const weekView = document.getElementById('calendar-week-view');
                const monthView = document.getElementById('calendar-month-view');
                if (weekView && monthView) {
                    if (!IS_MEMBER_VIEW) {
                        weekView.classList.remove('content-hidden');
                        monthView.classList.add('content-hidden');
                    } else {
                        weekView.classList.add('content-hidden');
                        monthView.classList.remove('content-hidden');
                    }
                }
                updateCalendarTitleVisibility();
                ensureCourtListLoaded();
                loadDataAndRenderCalendar();
                // 마우스 휠 이벤트 리스너 추가
                setupCalendarWheelScroll();
            } else if (tabId === 'Dashboard') {
                loadDataAndRenderDashboard();
            } else if (tabId === 'Preferences') {
                // 환경설정 페이지는 특별한 데이터 로드 없음
                // 트리거 제거는 선택적으로 실행
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(result => {
                            if (result && result.message) {
                                console.log('트리거 제거: ' + result.message);
                            }
                        })
                        .withFailureHandler(error => {
                            console.log('트리거 제거 오류: ' + error.message);
                        })
                        .removeImageSyncTriggers();
                }
            } else if (tabId === 'ClassManagement') {
                // 수업관리 데이터 로드
                loadClasses();
            } else if (tabId === 'ClassSchedule') {
                // 수업회차 데이터 로드
                loadClassScheduleList();
                if (allMembersNewData.length === 0) {
                    google.script.run.withSuccessHandler(d => { allMembersNewData = d || []; }).readAllMembersNew();
                }
            }
            // 새 메뉴 추가 시 여기에 else if 추가
        }, 50);
    }

    // 숫자 콤마 포맷팅
    function formatNumber(inputElement) {
        let value = inputElement.value.replace(/[^0-9]/g, '');
        if (value) {
            inputElement.value = new Intl.NumberFormat('ko-KR').format(value);
        }
    }

    let statusHideTimer_ = null;

    function setStatusStyle_(type) {
        if (!statusMessage) return;
        statusMessage.classList.remove('content-hidden', 'bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-gray-100', 'text-gray-800');
        if (type === 'success') {
            statusMessage.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            statusMessage.classList.add('bg-red-100', 'text-red-800');
        } else if (type === 'warning') {
            statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
        } else {
            statusMessage.classList.add('bg-gray-100', 'text-gray-800');
        }
    }

    // 알림 메시지 표시
    function showStatus(message, type = 'success') {
        if (!statusMessage) return;
        if (statusHideTimer_) clearTimeout(statusHideTimer_);
        setStatusStyle_(type);
        statusMessage.textContent = message;
        statusHideTimer_ = setTimeout(() => {
            statusMessage.classList.add('content-hidden');
        }, 5000);
    }

    function hideStatusNow_() {
        if (!statusMessage) return;
        if (statusHideTimer_) clearTimeout(statusHideTimer_);
        statusMessage.classList.add('content-hidden');
    }

    // 상태바에 전송/취소 버튼이 있는 확인 UI
    function showConfirmInStatus_(message, onConfirm, onCancel) {
        if (!statusMessage) return;
        if (statusHideTimer_) clearTimeout(statusHideTimer_);
        setStatusStyle_('warning');
        const idYes = 'statusConfirmYes_' + String(Date.now());
        const idNo = 'statusConfirmNo_' + String(Date.now() + 1);
        statusMessage.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="flex-1 text-sm font-semibold">${String(message || '')}</div>
        <div class="flex gap-2 flex-shrink-0">
          <button type="button" id="${idYes}" class="px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold">전송</button>
          <button type="button" id="${idNo}" class="px-3 py-1.5 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold">취소</button>
        </div>
      </div>
    `;
        const yesBtn = document.getElementById(idYes);
        const noBtn = document.getElementById(idNo);
        if (yesBtn) {
            yesBtn.addEventListener('click', () => {
                try { if (typeof onConfirm === 'function') onConfirm(); } finally { }
            }, { once: true });
        }
        if (noBtn) {
            noBtn.addEventListener('click', () => {
                try { if (typeof onCancel === 'function') onCancel(); } finally { hideStatusNow_(); }
            }, { once: true });
        }
    }

    function confirmAndSendTelegramForItem_(memberId, itemId) {
        if (IS_MEMBER_VIEW) return; // 회원 전용 링크에서는 전송 기능 숨김
        if (!memberId || !itemId) {
            showStatus('전송 대상 정보(member_id/item_id)가 없습니다.', 'error');
            return;
        }
        const styleEl = document.getElementById('telegram-style-select');
        const styleKey = styleEl ? String(styleEl.value || '').trim() : 'card';
        showConfirmInStatus_('텔레그램 전송 하시겠습니까?', () => {
            showStatus('텔레그램 전송 중...', 'warning');
            google.script.run
                .withSuccessHandler(result => {
                    if (result && result.success) showStatus(result.message || '전송이 되었습니다.', 'success');
                    else showStatus((result && result.message) ? result.message : '전송 실패', 'error');
                })
                .withFailureHandler(err => showStatus('전송 오류: ' + err.message, 'error'))
                .sendItemToMemberTelegramWithStyle(memberId, itemId, styleKey);
        }, () => { });
    }

    // 로딩 상태 토글 (리스트)
    function toggleLoading(isLoading) {
        if (!loadingIndicator || !dataTableBody) return;
        if (isLoading) {
            loadingIndicator.classList.remove('content-hidden');
            dataTableBody.innerHTML = '';
            if (noDataMessage) noDataMessage.classList.add('content-hidden');
        } else {
            loadingIndicator.classList.add('content-hidden');
        }
    }

    // 로딩 상태 토글 (캘린더)
    function toggleCalendarLoading(isLoading) {
        if (!calendarLoading || !calendarDaysContainer) return;
        if (isLoading) {
            calendarLoading.classList.remove('content-hidden');
            calendarDaysContainer.classList.add('content-hidden');
        } else {
            calendarLoading.classList.add('content-hidden');
            calendarDaysContainer.classList.remove('content-hidden');
        }
    }

    // 로딩 상태 토글 (대시보드)
    function toggleDashboardLoading(isLoading) {
        if (!dashboardLoading) return;
        if (isLoading) {
            dashboardLoading.classList.remove('content-hidden');
            if (missingBidTableBody) missingBidTableBody.classList.add('content-hidden');
            if (statusTableBody) statusTableBody.classList.add('content-hidden');
            if (memberBidChartCanvas) memberBidChartCanvas.classList.add('content-hidden');
        } else {
            dashboardLoading.classList.add('content-hidden');
            if (missingBidTableBody) missingBidTableBody.classList.remove('content-hidden');
            if (statusTableBody) statusTableBody.classList.remove('content-hidden');
            if (memberBidChartCanvas) memberBidChartCanvas.classList.remove('content-hidden');
        }
    }

    // 상태값에 따른 태그 클래스 반환
    function getStatusTagClass(status) {
        switch (status) {
            case '상품': return 'stu-tag stu-tag-product';
            case '입찰': return 'stu-tag stu-tag-bid';
            case '추천': return 'stu-tag stu-tag-recommend';
            case '변경': return 'stu-tag stu-tag-changed';
            case '미정':
            default: return 'stu-tag stu-tag-default';
        }
    }

    // 오늘부터 7일(영업일) 계산
    function getWorkingDaysFromToday() {
        const targetDates = [];
        let tempDate = new Date();
        targetDates.push(new Date(tempDate));

        let addedCount = 0;
        while (addedCount < 14) {
            tempDate.setDate(tempDate.getDate() + 1);
            const day = tempDate.getDay();
            if (day !== 0 && day !== 6) {
                targetDates.push(new Date(tempDate));
                addedCount++;
            }
        }
        return targetDates;
    }

    // ID로 아이템 찾기
    function getBidItemById(id) {
        return allBiddingData.find(item => item.id === id);
    }

    // =============================================================================
    // 3. 화면 렌더링 (View)
    // =============================================================================

    // --- [1] 입찰 목록 테이블 렌더링 ---
    function renderFilteredData(data) {
        if (!dataTableBody) return;
        dataTableBody.innerHTML = '';
        let selectedItemStillExists = false;

        if (data.length === 0) {
            if (allBiddingData.length > 0) {
                let msg = "검색어와 일치하는 데이터가 없습니다.";
                if (dashboardFilter.active) msg = "해당 필터 조건에 맞는 데이터가 없습니다.";
                dataTableBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">${msg}</td></tr>`;
            } else {
                if (noDataMessage) noDataMessage.classList.remove('content-hidden');
            }
        } else {
            if (noDataMessage) noDataMessage.classList.add('content-hidden');
            data.forEach(item => {
                const row = dataTableBody.insertRow();
                row.dataset.id = item.id;
                var imageIdsVal = (item.image_ids != null)
                    ? (Array.isArray(item.image_ids) ? item.image_ids.join(',') : String(item.image_ids))
                    : (item.image_id || '');
                row.setAttribute('data-images', imageIdsVal);
                var hasImages = !!(imageIdsVal && imageIdsVal.split(',').map(function (s) { return s.trim(); }).filter(Boolean).length);
                row.setAttribute('data-sakun-no', item.sakun_no || '');
                row.onclick = function (ev) {
                    if (ev.target && (ev.target.closest ? ev.target.closest('.item-row-cb') : ev.target.classList && ev.target.classList.contains('item-row-cb'))) return;
                    var r = ev.currentTarget;
                    var hitImgCell = ev.target && (ev.target.closest ? ev.target.closest('.list-img-cell') : false);
                    var idsStr = r.getAttribute('data-images') || '';
                    var ids = idsStr.split(',').map(function (s) { return s.trim(); }).filter(Boolean);
                    var hasImgs = ids.length > 0;
                    if (hasImgs && hitImgCell) ev.preventDefault();
                    openInvestigationTab(r, hasImgs && !!hitImgCell);
                };
                row.className = 'cursor-pointer hover:bg-gray-100 transition duration-150';

                var checkCell = row.insertCell(0);
                checkCell.className = 'item-col-check text-center';
                checkCell.onclick = function (e) { e.stopPropagation(); };
                checkCell.innerHTML = '<label class="flex items-center justify-center cursor-pointer"><input type="checkbox" class="item-row-cb rounded" data-id="' + item.id + '" data-sakun-no="' + String(item.sakun_no || '').replace(/"/g, '&quot;') + '" data-status="' + String(item.stu_member || '미정').replace(/"/g, '&quot;') + '" title="선택"></label>';
                let cell = row.insertCell(1);
                cell.textContent = item['in-date'] || '';
                cell.className = 'item-col-date text-center';
                cell = row.insertCell(2);
                cell.className = 'item-col-img list-img-cell text-center';
                const hasAucId = !!(item.auction_id);

                if (hasImages && hasAucId) {
                    cell.innerHTML = '<span class="list-has-image-dot status-complete" title="이미지+옥션 등록완료"></span>';
                } else if (hasImages) {
                    cell.innerHTML = '<span class="list-has-image-dot status-image-only" title="이미지만 등록됨"></span>';
                } else if (hasAucId) {
                    cell.innerHTML = '<span class="list-has-image-dot status-auction-only" title="옥션ID만 연결됨"></span>';
                } else {
                    cell.textContent = '';
                }
                cell = row.insertCell(3);
                cell.textContent = item.sakun_no;
                cell.className = 'item-col-sakun text-left';
                cell = row.insertCell(4);
                cell.textContent = item.court;
                cell.className = 'item-col-court text-left';
                cell = row.insertCell(5);
                const statusClass = getStatusTagClass(item.stu_member);
                cell.innerHTML = `<span class="${statusClass}">${item.stu_member}</span>`;
                cell.className = 'item-col-status text-center';
                cell = row.insertCell(6);
                {
                    const base = String(item.m_name || '').trim();
                    const alias = '';
                    cell.textContent = alias ? `${base} ${alias}` : base;
                }
                cell.className = 'item-col-member text-center';
                cell = row.insertCell(7);
                cell.textContent = item.m_name_id;
                cell.className = 'item-col-manager text-center';

                // 전송 컬럼이 있다면 제거 (즉시 실행)
                const existingActionCells = row.querySelectorAll('.item-col-action');
                existingActionCells.forEach(c => c.remove());

                // 혹시 모를 추가 셀 제거 (9번째 셀 이상) - 안전하게
                while (row.cells && row.cells.length > 8) {
                    try {
                        row.deleteCell(8);
                    } catch (e) {
                        break;
                    }
                }

                if (formId && formId.value && String(item.id).trim() === String(formId.value).trim()) {
                    row.classList.add('bg-indigo-100', 'border-indigo-500', 'font-semibold');
                    activeRow = row;
                    selectedItemStillExists = true;
                }
            });
        }

        // 선택된 아이템이 필터링 결과에 없으면 폼 리셋
        if (searchSakunNoInput && searchMNameInput) {
            const termSakunNo = searchSakunNoInput.value.toLowerCase().trim();
            const termMName = searchMNameInput.value.toLowerCase().trim();
            if (formId && formId.value && !selectedItemStillExists && (termSakunNo !== '' || termMName !== '')) {
                showForm('create');
            }
        }
    }

    // --- [2] 회원 목록 렌더링 ---
    function renderMemberList(data) {
        const memberDataTableBody = getMemberDataTableBody();

        if (!memberDataTableBody) {
            console.error('memberDataTableBody를 찾을 수 없습니다.');
            return;
        }

        memberDataTableBody.innerHTML = '';

        if (!data || !Array.isArray(data) || data.length === 0) {
            memberDataTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">검색 결과가 없거나 데이터가 없습니다.</td></tr>`;
            return;
        }

        try {
            data.forEach((member) => {
                if (!member) return;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer transition';
                row.onclick = () => showMemberForm('edit', member);

                const name = member.name || '';
                const role = member.role || '';
                const phone = member.phone || '';
                const className = member.class_name || '-';

                row.innerHTML = `
                  <td class="px-4 py-3 text-left text-sm font-medium text-gray-900">${name}</td>
                  <td class="px-4 py-3 text-center text-sm text-gray-600">${role}</td>
                  <td class="px-4 py-3 text-center text-sm text-gray-500">${phone}</td>
                  <td class="px-4 py-3 text-center text-sm text-gray-500">${className}</td>
              `;
                memberDataTableBody.appendChild(row);
            });
        } catch (e) {
            console.error('회원 목록 렌더링 오류:', e);
            memberDataTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">렌더링 오류: ${e.message}</td></tr>`;
        }
    }

    // --- [3] 캘린더 렌더링 ---
    // 주의 시작일(월요일)을 반환하는 함수
    function getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        // 월요일(1)이면 0, 화요일(2)이면 -1, ..., 일요일(0)이면 -6
        const diff = day === 0 ? -6 : 1 - day;
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() + diff);
        return weekStart;
    }

    // 다음 주로 이동
    function changeCalendarWeek(offset) {
        const weekStart = getWeekStart(currentCalendarDate);
        weekStart.setDate(weekStart.getDate() + (offset * 7));
        currentCalendarDate = new Date(weekStart);
        renderCalendar();
    }

    // 주의 주차 계산 (해당 월의 몇 번째 주인지)
    function getWeekOfMonth(date) {
        const d = new Date(date);
        const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
        const firstWeekStart = getWeekStart(firstDay);
        const weekStart = getWeekStart(d);
        const diff = Math.floor((weekStart - firstWeekStart) / (7 * 24 * 60 * 60 * 1000));
        return diff + 1;
    }

    function updateCalendarTitle(date) {
        if (!calendarTitle) return;
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        calendarTitle.textContent = `${year}년 ${month}월`;
    }

    // 월별 탭일 때만 타이틀 컨테이너 표시
    function updateCalendarTitleVisibility() {
        if (calendarTitleContainer) {
            if (currentCalendarView === 'month' || currentCalendarView === 'month-summary') {
                calendarTitleContainer.classList.remove('content-hidden');
            } else {
                calendarTitleContainer.classList.add('content-hidden');
            }
        }
    }

    // 탭 전환 함수
    function switchCalendarTab(view) {
        currentCalendarView = view;
        const weekTab = document.getElementById('calendar-tab-week');
        const monthTab = document.getElementById('calendar-tab-month');
        const monthSummaryTab = document.getElementById('calendar-tab-month-summary');
        const weekBtn = document.getElementById('calendar-btn-week');
        const monthBtn = document.getElementById('calendar-btn-month');
        const monthSummaryBtn = document.getElementById('calendar-btn-month-summary');
        const weekView = document.getElementById('calendar-week-view');
        const monthView = document.getElementById('calendar-month-view');
        const monthSummaryView = document.getElementById('calendar-month-summary-view');

        // 모든 탭과 뷰 초기화
        [weekTab, monthTab, monthSummaryTab, weekBtn, monthBtn, monthSummaryBtn].forEach(tab => {
            if (!tab) return;
            tab.classList.remove('active');
        });
        [weekView, monthView, monthSummaryView].forEach(view => {
            if (view) {
                view.classList.add('content-hidden');
            }
        });

        if (view === 'week') {
            if (weekTab) weekTab.classList.add('active');
            if (weekBtn) weekBtn.classList.add('active');
            if (weekView) {
                weekView.classList.remove('content-hidden');
            }
            // 주별 탭으로 전환 시 오늘 주로 이동 및 이전 주 개수 초기화
            currentCalendarDate = getWeekStart(new Date());
            numWeeksBefore = 0;
            isLoadingPreviousWeeks = false;
        } else if (view === 'month') {
            if (monthTab) monthTab.classList.add('active');
            if (monthBtn) monthBtn.classList.add('active');
            if (monthView) {
                monthView.classList.remove('content-hidden');
            }
        } else if (view === 'month-summary') {
            if (monthSummaryTab) monthSummaryTab.classList.add('active');
            if (monthSummaryBtn) monthSummaryBtn.classList.add('active');
            if (monthSummaryView) {
                monthSummaryView.classList.remove('content-hidden');
            }
        }

        updateCalendarTitleVisibility();
        renderCalendar();
    }

    function changeCalendarMonth(offset) {
        // 월별 뷰 또는 월별(요약) 뷰에서만 작동
        if (currentCalendarView !== 'month' && currentCalendarView !== 'month-summary') return;

        // 다음월의 1일로 이동
        const nextMonth = new Date(currentCalendarDate);
        nextMonth.setMonth(nextMonth.getMonth() + offset, 1);
        currentCalendarDate = new Date(nextMonth);
        updateCalendarTitle(currentCalendarDate);
        renderCalendar();
    }

    // 날짜별 데이터 집계
    function aggregateBidsByDay(year, month) {
        const yearStr = String(year).slice(-2);
        const monthStr = String(month + 1).padStart(2, '0');
        const bidsByDay = {};

        let dataToAggregate = allBiddingData;

        const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
        const fCourt = calSearchCourt ? calSearchCourt.value.toLowerCase().trim() : '';
        const fStatuses = getSelectedCalendarStatusValues();
        const allCalStatusCb = document.getElementById('cal-search-status-all');
        const isAllCalStatus = (allCalStatusCb && allCalStatusCb.checked);
        const fMember = calSearchMember ? calSearchMember.value.toLowerCase().trim() : '';
        const fManager = calSearchManager ? calSearchManager.value : '';

        // 나머지 검색 조건 필터링
        dataToAggregate = dataToAggregate.filter(item => {
            let pass = true;
            if (fSakunno && !String(item.sakun_no || '').toLowerCase().includes(fSakunno)) pass = false;
            if (fCourt) {
                const itemCourt = String(item.court || '').toLowerCase().trim();
                const searchCourt = fCourt.toLowerCase().trim();
                // 정확한 매칭: 입력값과 정확히 일치하는 경우만 통과
                if (itemCourt !== searchCourt) pass = false;
            }
            // 상태 필터링: "전체" 체크 시 통과, 아무것도 선택 안 하면 조회 안 됨
            const matchesStatus = isAllCalStatus ? true : (fStatuses.length > 0 && fStatuses.includes(String(item.stu_member || '').trim()));
            if (!matchesStatus) pass = false;
            if (fMember) {
                const memberDisp = `${String(item.m_name || '')}`.toLowerCase();
                if (!memberDisp.includes(fMember)) pass = false;
            }
            if (fManager && item.m_name_id !== fManager) pass = false;
            return pass;
        });

        // 캘린더 점프 필터링
        if (calendarFilter.active) {
            if (calendarFilter.member) {
                dataToAggregate = dataToAggregate.filter(item => isMemberMatch(item, calendarFilter.member));
            }
            if (calendarFilter.status) {
                dataToAggregate = dataToAggregate.filter(item => item.stu_member === calendarFilter.status);
            }
        }

        // 날짜별로 집계 (입찰일자 기준)
        dataToAggregate.forEach(item => {
            const itemDate = String(item['in-date'] || '');
            if (!itemDate || itemDate.length < 6) return; // 입찰일자가 없으면 제외

            const itemMonthStr = itemDate.substring(2, 4);
            const itemYearStr = itemDate.substring(0, 2);
            if (itemMonthStr === monthStr && itemYearStr === yearStr) {
                const day = itemDate.substring(4, 6);
                const key = parseInt(day, 10);
                if (!bidsByDay[key]) {
                    bidsByDay[key] = [];
                }
                bidsByDay[key].push(item);
            }
        });
        return bidsByDay;
    }

    // 캘린더 그리기 메인 함수
    function scrollToTodayOrEarliestAuction(viewId, containerId) {
        const view = document.getElementById(viewId);
        const container = document.getElementById(containerId);
        if (!view || !container) return;

        const dayEls = container.querySelectorAll('.calendar-day[data-date]');
        if (dayEls.length === 0) return;

        const today = new Date();
        const y = String(today.getFullYear()).slice(-2);
        const m = String(today.getMonth() + 1).padStart(2, '0');
        const d = String(today.getDate()).padStart(2, '0');
        const todayStr = y + m + d;

        let targetEl = null;

        // 1. 오늘 날짜 찾기
        for (let el of dayEls) {
            if (el.dataset.date === todayStr) {
                targetEl = el;
                break;
            }
        }

        // 2. 오늘이 없거나 오늘 상품이 없다면, 오늘 이후 가장 빠른 상품 있는 날짜 찾기
        if (!targetEl || targetEl.dataset.hasBids !== 'true') {
            for (let el of dayEls) {
                if (el.dataset.date >= todayStr && el.dataset.hasBids === 'true') {
                    if (!targetEl || el.dataset.date < targetEl.dataset.date || targetEl.dataset.hasBids !== 'true') {
                        targetEl = el;
                    }
                }
            }
        }

        // 3. 그래도 없으면 그냥 오늘 이후 첫날
        if (!targetEl) {
            for (let el of dayEls) {
                if (el.dataset.date >= todayStr) {
                    targetEl = el;
                    break;
                }
            }
        }

        if (targetEl) {
            const rect = targetEl.getBoundingClientRect();
            const viewRect = view.getBoundingClientRect();
            const relativeTop = rect.top - viewRect.top + view.scrollTop;
            view.scrollTo({ top: relativeTop - 10, behavior: 'smooth' }); // 약간의 여백
        }
    }

    // --- [회원 전용 고도화 로직] ---

    /**
     * 회원용 특화 아이템 카드 HTML 생성
     */
    function createMemberItemCard(item) {
        if (!item) return '';
        const sakun = escapeHtml(String(item.sakun_no || ''));
        const court = escapeHtml(String(item.court || ''));
        const status = escapeHtml(String(item.status || '미정'));
        const bidPrice = escapeHtml(String(item['bid-price'] || '0'));
        const itemId = item.id;

        return `
            <div class="member-item-card" onclick="handleMemberCardClick('${itemId}')">
                <div class="member-card-left">
                    <div class="member-sakun-info">
                        <span class="member-sakun-no">${sakun}</span>
                        <span class="member-court-status">${court} / ${status}</span>
                    </div>
                    <div class="member-bid-price">${bidPrice} 원</div>
                </div>
                <div class="member-card-right" onclick="event.stopPropagation()">
                    <button class="member-action-btn btn-bid-apply" onclick="handleMemberBidApply('${itemId}', '${sakun}')">입찰</button>
                    <button class="member-action-btn btn-bid-cancel" onclick="handleMemberBidCancel('${itemId}', '${sakun}')">취소</button>
                </div>
            </div>
        `;
    }

    /**
     * 카드 클릭 시 이미지 즉시 보기
     */
    function handleMemberCardClick(itemId) {
        if (!itemId) return;
        const item = allBiddingData.find(it => String(it.id) === String(itemId));
        if (item) {
            // 이미지 탭으로 모달 열기
            viewItemDetail(item, 'investigation');
        }
    }

    /**
     * 입찰 신청 처리
     */
    function handleMemberBidApply(itemId, sakun) {
        if (!confirm(`[${sakun}]\n입찰 신청을 하시겠습니까?`)) return;

        google.script.run
            .withSuccessHandler(res => {
                showStatus('입찰 신청이 접수되었습니다.', 'success');
                // 코멘트 기록 대용으로 상태 변경 + 로그 남기기 기능이 서버에 있어야 함
                // 여기서는 상태를 '입찰'로 변경하는 예시
                google.script.run.updateBiddingStatus(itemId, '입찰', `회원 입찰 신청 (텔레그램 연동)`);
                loadDataAndRenderCalendar(true); // 새로고침
            })
            .withFailureHandler(err => showStatus('입찰 신청 실패: ' + err.message, 'error'))
            .withUserObject(itemId)
            .readAllData(); // 임시로 트리거 (실제로는 서버에 신청 함수가 있어야 함)

        // 위 방식은 서버 함수가 준비 안되었을 수 있으므로 기존 로직 활용 시:
        google.script.run.saveItemData({ id: itemId, status: '입찰', remarks: `[입찰신청] ${new Date().toLocaleString()}` }, true);
        showStatus('입찰 신청이 완료되었습니다.', 'success');
        setTimeout(() => loadDataAndRenderCalendar(true), 500);
    }

    /**
     * 입찰 취소 처리
     */
    function handleMemberBidCancel(itemId, sakun) {
        if (!confirm(`[${sakun}]\n입찰을 취소하시겠습니까?`)) return;

        google.script.run.saveItemData({ id: itemId, status: '미정', remarks: `[입찰취소] ${new Date().toLocaleString()}` }, true);
        showStatus('취소되었습니다.', 'success');
        setTimeout(() => loadDataAndRenderCalendar(true), 500);
    }

    /**
     * 모바일용 연속 리스트 렌더링
     */
    function renderMemberMobileList() {
        const container = document.getElementById('BiddingSchedule');
        if (!container) return;

        // 기존 캘린더 구조 대신 리스트 영역으로 교체
        container.innerHTML = `
            <div class="mobile-item-list" id="memberMobileList">
                <div class="text-center p-8 text-gray-500">데이터를 불러오는 중...</div>
            </div>
        `;

        const listArea = document.getElementById('memberMobileList');
        if (!allBiddingData || allBiddingData.length === 0) {
            listArea.innerHTML = '<div class="text-center p-8 text-gray-500">조회된 입찰 물건이 없습니다.</div>';
            return;
        }

        let html = '';
        let lastDate = '';

        allBiddingData.forEach(item => {
            const rawDate = String(item['in-date'] || '');
            if (rawDate && rawDate.length >= 6) {
                const dateLabel = `20${rawDate.slice(0, 2)}년 ${rawDate.slice(2, 4)}월 ${rawDate.slice(4, 6)}일`;
                if (dateLabel !== lastDate) {
                    html += `<div class="date-divider">${dateLabel}</div>`;
                    lastDate = dateLabel;
                }
            }
            html += createMemberItemCard(item);
        });

        listArea.innerHTML = html;
        toggleCalendarLoading(false);
    }

    function renderCalendar() {
        // [추가] 회원 모드이면서 모바일인 경우 연속 리스트 뷰로 대체
        if (IS_MEMBER_VIEW && window.__MJ_IS_MOBILE__) {
            renderMemberMobileList();
            return;
        }

        // 입력값 유무에 따라 실시간 강조 스타일 적용 (입찰일정)
        try {
            const fSakunno = calSearchSakunno ? String(calSearchSakunno.value || '').trim() : '';
            const fCourt = calSearchCourt ? String(calSearchCourt.value || '').trim() : '';
            const fMember = calSearchMember ? String(calSearchMember.value || '').trim() : '';
            const fManager = calSearchManager ? String(calSearchManager.value || '').trim() : '';
            const selected = getSelectedCalendarStatusValues();
            const allCalStatusCb = document.getElementById('cal-search-status-all');
            const isAllCalStatus = (allCalStatusCb && allCalStatusCb.checked);
            const sBtn = document.getElementById('cal-search-status-btn');

            if (calSearchSakunno) calSearchSakunno.classList.toggle('filter-active-input', !!fSakunno);
            if (calSearchCourt) calSearchCourt.classList.toggle('filter-active-input', !!fCourt);
            if (calSearchMember) calSearchMember.classList.toggle('filter-active-input', !!fMember);
            if (calSearchManager) calSearchManager.classList.toggle('filter-active-input', !!fManager);
            // 전체가 아니면 강조 (미선택 포함)
            if (sBtn) sBtn.classList.toggle('filter-active-input', !isAllCalStatus);
        } catch (e) {
            // highlight만 실패해도 캘린더 렌더링은 계속
        }

        if (currentCalendarView === 'week') {
            renderCalendarWeek();
        } else if (currentCalendarView === 'month') {
            renderCalendarMonth();
        } else if (currentCalendarView === 'month-summary') {
            renderCalendarMonthSummary();
        }
    }

    // 주별 캘린더 렌더링
    function renderCalendarWeek() {
        if (!calendarDaysContainerWeek) return;

        // 사건번호 조회 시 해당 데이터가 있는 주로 이동 (오늘 이후만)
        const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
        if (fSakunno) {
            const today = new Date();
            const todayYear = String(today.getFullYear()).slice(-2);
            const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
            const todayDay = String(today.getDate()).padStart(2, '0');
            const todayYYMMDD = `${todayYear}${todayMonth}${todayDay}`;

            // 사건번호로 필터링된 물건들 중 오늘 이후의 가장 빠른 입찰일자의 주를 찾기
            const filteredItems = allBiddingData.filter(item => {
                const sakunNo = String(item.sakun_no || '').toLowerCase();
                if (!sakunNo.includes(fSakunno)) return false;

                // 오늘 이후만 필터링
                const inDate = String(item['in-date'] || '');
                if (!inDate || inDate.length < 6) return false;
                const inDateStr = inDate.substring(0, 6); // YYMMDD
                return inDateStr >= todayYYMMDD;
            });

            // 가장 빠른 입찰일자 찾기
            let earliestInDate = null;
            filteredItems.forEach(item => {
                const inDate = String(item['in-date'] || '');
                if (inDate && inDate.length >= 6) {
                    const inDateStr = inDate.substring(0, 6); // YYMMDD
                    if (!earliestInDate || inDateStr < earliestInDate) {
                        earliestInDate = inDateStr;
                    }
                }
            });

            if (earliestInDate) {
                // YYMMDD를 Date 객체로 변환
                const year = 2000 + parseInt(earliestInDate.substring(0, 2));
                const month = parseInt(earliestInDate.substring(2, 4)) - 1;
                const day = parseInt(earliestInDate.substring(4, 6));
                const searchDate = new Date(year, month, day);

                if (!isNaN(searchDate.getTime())) {
                    const searchWeekStart = getWeekStart(searchDate);
                    currentCalendarDate = new Date(searchWeekStart);
                    // 이전 주도 필요하면 로드
                    const todayWeekStart = getWeekStart(today);
                    const weeksDiff = Math.floor((searchWeekStart - todayWeekStart) / (7 * 24 * 60 * 60 * 1000));
                    if (weeksDiff < 0) {
                        // 과거 주이므로 이전 주 로드 필요
                        numWeeksBefore = Math.min(Math.abs(weeksDiff) + 2, 12);
                    } else {
                        // 미래 주이므로 첫 줄에 표시되도록
                        numWeeksBefore = 0;
                    }
                }
            }
        } else {
            // 입찰일정 탭이 활성화되어 있고 주별 탭일 때, 오늘 주로 초기화
            if (currentCalendarView === 'week') {
                const today = new Date();
                const todayWeekStart = getWeekStart(today);
                // currentCalendarDate가 설정되지 않았거나 오늘 주가 아닌 경우 오늘 주로 설정
                const currentWeekStart = getWeekStart(currentCalendarDate);
                if (currentWeekStart.getTime() !== todayWeekStart.getTime()) {
                    currentCalendarDate = new Date(todayWeekStart);
                }
            }
        }

        if (allBiddingData.length === 0) {
            toggleCalendarLoading(false);
            calendarDaysContainerWeek.innerHTML = `<div style="grid-column: 1 / span 6;" class="text-center p-8 text-gray-500">데이터가 없습니다.</div>`;
            return;
        }

        // 필터 배너 처리
        if (calendarFilterBanner && calendarFilterText) {
            if (calendarFilter.active) {
                calendarFilterBanner.classList.remove('content-hidden');
                let bannerText = "필터 적용 중";
                if (calendarFilter.member && calendarFilter.status) {
                    bannerText = `[${calendarFilter.member}]님 - [${calendarFilter.status}] 물건 조회`;
                } else if (calendarFilter.member) {
                    bannerText = `[${calendarFilter.member}]님 물건 조회`;
                } else if (calendarFilter.status) {
                    bannerText = `전체 [${calendarFilter.status}] 물건 조회`;
                }
                calendarFilterText.textContent = bannerText;
            } else {
                calendarFilterBanner.classList.add('content-hidden');
            }
        }

        toggleCalendarLoading(false);
        calendarDaysContainerWeek.innerHTML = '';

        const startWeek = getWeekStart(currentCalendarDate);
        const today = new Date();
        const dayNames = ['월', '화', '수', '목', '금'];

        // 여러 주 렌더링 (초기에는 이전 주 없이 오늘 주부터 이후만)
        // numWeeksBefore는 전역 변수로 관리 (동적으로 변경됨)
        const numWeeksAfter = 12;
        const totalWeeks = numWeeksBefore + numWeeksAfter + 1;
        let lastMonth = -1;

        for (let weekOffset = -numWeeksBefore; weekOffset <= numWeeksAfter; weekOffset++) {
            const weekStart = new Date(startWeek);
            weekStart.setDate(startWeek.getDate() + (weekOffset * 7));

            // 주의 5일(월~금) 렌더링
            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + i);

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const day = currentDate.getDate();

                const isToday = (currentDate.toDateString() === today.toDateString());
                const isMonthChange = (i === 0 && month !== lastMonth);
                lastMonth = month;

                const dayClass = `calendar-day current-month ${isToday ? 'today' : ''} ${isMonthChange ? 'month-change' : ''}`;
                const dayDate = `${month + 1}월 ${day}일 (${dayNames[i]})`;
                const monthLabel = isMonthChange ? `${String(year).slice(-2)}년 ${month + 1}월` : '';

                let contentHtml = '';

                // 해당 날짜의 입찰 데이터 가져오기
                const yearStr = String(year).slice(-2);
                const monthStr = String(month + 1).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const targetDate = `${yearStr}${monthStr}${dayStr}`;

                // 입찰일자 기준 필터링 (기본)
                const filteredData = allBiddingData.filter(item => {
                    const itemDate = String(item['in-date']);
                    return itemDate === targetDate;
                });

                // 나머지 필터 적용
                const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
                const fCourt = calSearchCourt ? calSearchCourt.value.trim() : '';
                const fStatuses = getSelectedCalendarStatusValues();
                const allCalStatusCb = document.getElementById('cal-search-status-all');
                const isAllCalStatus = (allCalStatusCb && allCalStatusCb.checked);
                const fMember = calSearchMember ? calSearchMember.value.toLowerCase().trim() : '';
                const fManager = calSearchManager ? calSearchManager.value : '';

                const bids = filteredData.filter(item => {
                    if (fSakunno && !String(item.sakun_no || '').toLowerCase().includes(fSakunno)) return false;
                    if (fCourt) {
                        const itemCourt = String(item.court || '').trim();
                        const searchCourt = fCourt.trim();
                        if (itemCourt !== searchCourt) return false;
                    }
                    // 상태 필터링: "전체" 체크 시 통과, 아무것도 선택 안 하면 조회 안 됨
                    const matchesStatus = isAllCalStatus ? true : (fStatuses.length > 0 && fStatuses.includes(item.stu_member || '미정'));
                    if (!matchesStatus) return false;
                    if (fMember) {
                        const memberDisp = `${String(item.m_name || '')}`.toLowerCase();
                        if (!memberDisp.includes(fMember)) return false;
                    }
                    if (fManager && item.m_name_id !== fManager) return false;
                    return true;
                });

                if (bids.length > 0) {
                    bids.forEach(bid => {
                        const bidprice = bid.bidprice || 0;
                        const bidpriceFormatted = (bidprice > 0) ? new Intl.NumberFormat('ko-KR').format(bidprice) + '원' : '';
                        const mNameIdClass = (bid.m_name_id !== '대표님' && bid.m_name_id !== null && bid.m_name_id !== undefined && bid.m_name_id !== '') ? 'm-name-id-red' : '';
                        const mNameValue = bid.m_name || '';
                        const statusClass = getStatusTagClass(bid.stu_member);
                        const courtButtonClass = 'button-like-content';

                        const isNewBid = (bid.bid_state === '신규' || !bid.bid_state);
                        const bidPriceMobileClass = isNewBid ? 'text-red-600 font-bold' : 'text-gray-700 font-bold';
                        const bidPricePcClass = isNewBid ? 'bidprice-cell text-red-600' : 'bidprice-cell';

                        const isNoPrice = (!bid.bidprice || bid.bidprice === 0 || bid.bidprice === '0');
                        const mobileBorder = isNoPrice ? 'border-2 border-red-600' : 'border-2 border-slate-400';
                        const desktopBorder = isNoPrice ? 'border-[2px] border-red-600' : 'border-[1px] border-slate-500';

                        // 이미지 존재 여부 확인 (has_images 플래그 사용) 및 옥션 ID 확인
                        const hasImages = !!bid.has_images;
                        const hasAucId = !!bid.auction_id;
                        let dotClass = "";
                        let dotTitle = "";

                        if (hasImages && hasAucId) {
                            dotClass = "bg-green-500";
                            dotTitle = "이미지+옥션 등록완료";
                        } else if (hasImages) {
                            dotClass = "bg-gray-400";
                            dotTitle = "이미지만 등록됨";
                        } else if (hasAucId) {
                            dotClass = "bg-blue-600";
                            dotTitle = "옥션ID만 연결됨";
                        }

                        const imgButtonHtml = `<span class="inline-block w-5 text-center flex-shrink-0">${(hasImages || hasAucId) ? `<span class="inline-block w-3.5 h-3.5 rounded-full ${dotClass} cursor-pointer" onclick="event.stopPropagation(); openDetailModalWithTab('${bid.id}', true)" title="${dotTitle}"></span>` : ''}</span>`;

                        const itemHtml = IS_MEMBER_VIEW ? createMemberItemCard(bid) : `
                          <div class="md:hidden border-2 border-green-300 rounded-xl p-3 mb-2 bg-stone-50 shadow-sm flex items-center justify-between cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                              <div class="text-indigo-600 font-bold text-sm sm:text-base w-[40%] flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div>
                              <div class="flex flex-col items-center justify-center w-[20%] space-y-1">
                                  <span class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded text-gray-600 whitespace-nowrap">${bid.court || '미상'}</span>
                                  <span class="text-xs font-bold ${mNameIdClass}">${bid.m_name_id || '대표님'}</span>
                              </div>
                              <div class="flex flex-col items-end w-[40%] space-y-1">
                                  <div class="flex items-center space-x-1">
                                      <span class="${statusClass} text-[10px] px-1.5 py-0.5 rounded whitespace-nowrap" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span>
                                      <span class="text-xs font-bold text-gray-800">${mNameValue}</span>
                                  </div>
                                  <div class="text-sm ${bidPriceMobileClass}">${bidpriceFormatted}</div>
                              </div>
                          </div>
                          <table class="hidden md:table bid-item-table ${desktopBorder} cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                              <tbody>
                                  <tr>
                                      <td rowspan="2" class="sakun-no-cell" style="width: 40%;"><div class="flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div></td>
                                      <td class="court-cell" style="width: 21%;"><span class="${courtButtonClass}">${bid.court || '미상'}</span></td>
                                      <td class="stu-cell" style="width: 17%;"><span class="${statusClass}" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span></td>
                                      <td class="m-name-cell" style="width: 22%;">${mNameValue}</td>
                                  </tr>
                                  <tr>
                                      <td class="${mNameIdClass}" style="width: 21%;">${bid.m_name_id || '대표님'}</td>
                                      <td colspan="2" class="${bidPricePcClass}">${bidpriceFormatted}</td>
                                  </tr>
                              </tbody>
                          </table>
                      `;
                        contentHtml += itemHtml;
                    });
                }

                const dayHtml = `
                  <div class="${dayClass}" data-date="${targetDate}" data-has-bids="${bids.length > 0}">
                      <div class="calendar-day-date">${dayDate}</div>
                      ${contentHtml}
                  </div>
              `;
                calendarDaysContainerWeek.insertAdjacentHTML('beforeend', dayHtml);
            }
        }

        // 해당 주가 맨 위에 오도록 스크롤
        setTimeout(() => {
            if (IS_MEMBER_VIEW) {
                scrollToTodayOrEarliestAuction('calendar-week-view', 'calendar-days-container-week');
                return;
            }
            const calendarWeekView = document.getElementById('calendar-week-view');
            if (calendarWeekView) {
                // 입찰일자 조회 시 또는 초기 렌더링 시 해당 주가 맨 위에 오도록
                if (numWeeksBefore === 0) {
                    calendarWeekView.scrollTop = 0;
                } else {
                    // 이전 주가 로드된 경우, currentCalendarDate의 주가 맨 위에 오도록
                    const startWeek = getWeekStart(currentCalendarDate);
                    const today = new Date();
                    const todayWeekStart = getWeekStart(today);
                    const weekDiff = Math.floor((startWeek - todayWeekStart) / (7 * 24 * 60 * 60 * 1000));
                    // weekDiff가 음수면 과거 주, 양수면 미래 주
                    // numWeeksBefore 내에 있으면 스크롤 위치 계산
                    if (weekDiff >= -numWeeksBefore && weekDiff <= 0) {
                        const firstWeekElement = calendarDaysContainerWeek.firstElementChild;
                        if (firstWeekElement) {
                            const weekHeight = firstWeekElement.offsetHeight || 600;
                            const targetScrollTop = (weekDiff + numWeeksBefore) * weekHeight;
                            calendarWeekView.scrollTop = Math.max(0, targetScrollTop);
                        }
                    }
                }
            }
        }, 100);
    }

    // 월별 캘린더 렌더링 (기존 로직)
    function renderCalendarMonth() {
        if (!calendarDaysContainerMonth) return;

        // 사건번호 조회 시 해당 데이터가 있는 월로 이동 (오늘 이후만)
        const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
        if (fSakunno) {
            const today = new Date();
            const todayYear = String(today.getFullYear()).slice(-2);
            const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
            const todayDay = String(today.getDate()).padStart(2, '0');
            const todayYYMMDD = `${todayYear}${todayMonth}${todayDay}`;

            // 사건번호로 필터링된 물건들 중 오늘 이후의 가장 빠른 입찰일자의 월을 찾기
            const filteredItems = allBiddingData.filter(item => {
                const sakunNo = String(item.sakun_no || '').toLowerCase();
                if (!sakunNo.includes(fSakunno)) return false;

                // 오늘 이후만 필터링
                const inDate = String(item['in-date'] || '');
                if (!inDate || inDate.length < 6) return false;
                const inDateStr = inDate.substring(0, 6); // YYMMDD
                return inDateStr >= todayYYMMDD;
            });

            // 가장 빠른 입찰일자 찾기
            let earliestInDate = null;
            filteredItems.forEach(item => {
                const inDate = String(item['in-date'] || '');
                if (inDate && inDate.length >= 6) {
                    const inDateStr = inDate.substring(0, 6); // YYMMDD
                    if (!earliestInDate || inDateStr < earliestInDate) {
                        earliestInDate = inDateStr;
                    }
                }
            });

            if (earliestInDate) {
                // YYMMDD를 Date 객체로 변환하여 해당 월로 이동
                const year = 2000 + parseInt(earliestInDate.substring(0, 2));
                const month = parseInt(earliestInDate.substring(2, 4)) - 1;
                const day = parseInt(earliestInDate.substring(4, 6));
                const searchDate = new Date(year, month, day);

                if (!isNaN(searchDate.getTime())) {
                    currentCalendarDate = new Date(year, month, 1); // 해당 월의 1일로 설정
                }
            }
        }

        if (allBiddingData.length === 0) {
            toggleCalendarLoading(false);
            calendarDaysContainerMonth.innerHTML = `<div style="grid-column: 1 / span 5;" class="text-center p-8 text-gray-500">데이터가 없습니다.</div>`;
            return;
        }

        // 필터 배너 처리
        if (calendarFilterBanner && calendarFilterText) {
            if (calendarFilter.active) {
                calendarFilterBanner.classList.remove('content-hidden');
                let bannerText = "필터 적용 중";
                if (calendarFilter.member && calendarFilter.status) {
                    bannerText = `[${calendarFilter.member}]님 - [${calendarFilter.status}] 물건 조회`;
                } else if (calendarFilter.member) {
                    bannerText = `[${calendarFilter.member}]님 물건 조회`;
                } else if (calendarFilter.status) {
                    bannerText = `전체 [${calendarFilter.status}] 물건 조회`;
                }
                calendarFilterText.textContent = bannerText;
            } else {
                calendarFilterBanner.classList.add('content-hidden');
            }
        }

        toggleCalendarLoading(false);
        calendarDaysContainerMonth.innerHTML = '';

        const date = currentCalendarDate;
        updateCalendarTitle(date);
        updateCalendarTitleVisibility();
        const year = date.getFullYear();
        const month = date.getMonth();
        const today = new Date();

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

        let startDay = firstDayOfMonth.getDay();
        if (startDay === 0) startDay = 7;
        startDay = startDay - 1;
        const bidsByDay = aggregateBidsByDay(year, month);

        const dayNames = ['월', '화', '수', '목', '금', '토', '일'];

        // 빈 날짜 채우기 (전월)
        for (let i = 0; i < startDay; i++) {
            if (dayNames[i] === '토' || dayNames[i] === '일') continue;
            calendarDaysContainerMonth.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
        }

        // 날짜 채우기
        for (let i = 1; i <= lastDateOfMonth; i++) {
            const currentDate = new Date(year, month, i);
            const yearStr = String(currentDate.getFullYear()).slice(-2);
            const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(currentDate.getDate()).padStart(2, '0');
            const targetDate = `${yearStr}${monthStr}${dayStr}`;
            const bids = bidsByDay[i] || [];
            const dayOfWeek = currentDate.getDay();

            if (dayOfWeek === 6 || dayOfWeek === 0) continue; // 주말 제외

            const isToday = (currentDate.toDateString() === today.toDateString());
            const dayClass = `calendar-day current-month ${isToday ? 'today' : ''}`;
            const dayName = dayNames[dayOfWeek === 0 ? 6 : dayOfWeek - 1];
            const dayDate = `${month + 1}월 ${i}일 (${dayName})`;

            let contentHtml = '';

            if (bids.length > 0) {
                bids.forEach(bid => {
                    const bidprice = bid.bidprice || 0;
                    const bidpriceFormatted = (bidprice > 0) ? new Intl.NumberFormat('ko-KR').format(bidprice) + '원' : '';
                    const mNameIdClass = (bid.m_name_id !== '대표님' && bid.m_name_id !== null && bid.m_name_id !== undefined && bid.m_name_id !== '') ? 'm-name-id-red' : '';
                    const mNameValue = bid.m_name || '';
                    const statusClass = getStatusTagClass(bid.stu_member);
                    const courtButtonClass = 'button-like-content';

                    const isNewBid = (bid.bid_state === '신규' || !bid.bid_state);
                    const bidPriceMobileClass = isNewBid ? 'text-red-600 font-bold' : 'text-gray-700 font-bold';
                    const bidPricePcClass = isNewBid ? 'bidprice-cell text-red-600' : 'bidprice-cell';

                    const isNoPrice = (!bid.bidprice || bid.bidprice === 0 || bid.bidprice === '0');
                    const mobileBorder = isNoPrice ? 'border-2 border-red-600' : 'border-2 border-slate-400';
                    const desktopBorder = isNoPrice ? 'border-[2px] border-red-600' : 'border-[1px] border-slate-500';

                    // 이미지 존재 여부 확인 (has_images 플래그 사용) 및 옥션 ID 확인
                    const hasImages = !!bid.has_images;
                    const hasAucId = !!bid.auction_id;
                    let dotClass = "";
                    let dotTitle = "";

                    if (hasImages && hasAucId) {
                        dotClass = "bg-green-500";
                        dotTitle = "이미지+옥션 등록완료";
                    } else if (hasImages) {
                        dotClass = "bg-gray-400";
                        dotTitle = "이미지만 등록됨";
                    } else if (hasAucId) {
                        dotClass = "bg-blue-600";
                        dotTitle = "옥션ID만 연결됨";
                    }

                    const imgButtonHtml = `<span class="inline-block w-5 text-center flex-shrink-0">${(hasImages || hasAucId) ? `<span class="inline-block w-3.5 h-3.5 rounded-full ${dotClass} cursor-pointer" onclick="event.stopPropagation(); openDetailModalWithTab('${bid.id}', true)" title="${dotTitle}"></span>` : ''}</span>`;

                    const itemHtml = IS_MEMBER_VIEW ? createMemberItemCard(bid) : `
                      <div class="md:hidden border-2 border-green-300 rounded-xl p-3 mb-2 bg-stone-50 shadow-sm flex items-center justify-between cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                          <div class="text-indigo-600 font-bold text-sm sm:text-base w-[40%] flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div>
                          <div class="flex flex-col items-center justify-center w-[20%] space-y-1">
                              <span class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded text-gray-600 whitespace-nowrap">${bid.court || '미상'}</span>
                              <span class="text-xs font-bold ${mNameIdClass}">${bid.m_name_id || '대표님'}</span>
                          </div>
                          <div class="flex flex-col items-end w-[40%] space-y-1">
                              <div class="flex items-center space-x-1">
                                      <span class="${statusClass} text-[10px] px-1.5 py-0.5 rounded whitespace-nowrap" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span>
                                  <span class="text-xs font-bold text-gray-800">${mNameValue}</span>
                              </div>
                              <div class="text-sm ${bidPriceMobileClass}">${bidpriceFormatted}</div>
                          </div>
                      </div>
                      <table class="hidden md:table bid-item-table ${desktopBorder} cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                          <tbody>
                              <tr>
                                  <td rowspan="2" class="sakun-no-cell" style="width: 40%;"><div class="flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div></td>
                                  <td class="court-cell" style="width: 21%;"><span class="${courtButtonClass}">${bid.court || '미상'}</span></td>
                                  <td class="stu-cell" style="width: 17%;"><span class="${statusClass}" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span></td>
                                  <td class="m-name-cell" style="width: 22%;">${mNameValue}</td>
                              </tr>
                              <tr>
                                  <td class="${mNameIdClass}" style="width: 21%;">${bid.m_name_id || '대표님'}</td>
                                  <td colspan="2" class="${bidPricePcClass}">${bidpriceFormatted}</td>
                              </tr>
                          </tbody>
                      </table>
                  `;
                    contentHtml += itemHtml;
                });
            }

            const dayHtml = `
              <div class="${dayClass}" data-date="${targetDate}" data-has-bids="${bids.length > 0}">
                  <div class="calendar-day-date">${dayDate}</div>
                  ${contentHtml}
              </div>
          `;
            calendarDaysContainerMonth.insertAdjacentHTML('beforeend', dayHtml);
        }

        // 회원 전용 모드: 오늘 또는 가장 가까운 입찰물건 날짜로 스크롤
        if (IS_MEMBER_VIEW) {
            setTimeout(() => {
                scrollToTodayOrEarliestAuction('calendar-month-view', 'calendar-days-container-month');
            }, 100);
        }

        const totalRenderedDays = calendarDaysContainerMonth.children.length;
        const remainingSlots = 5 - (totalRenderedDays % 5);
        if (remainingSlots > 0 && remainingSlots < 5) {
            for (let i = 0; i < remainingSlots; i++) {
                calendarDaysContainerMonth.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
            }
        }
    }

    // 법원별 입찰 건수 집계 함수
    function aggregateBidsByCourtAndDay(year, month) {
        const yearStr = String(year).slice(-2);
        const monthStr = String(month + 1).padStart(2, '0');
        const bidsByDay = {};

        let dataToAggregate = allBiddingData;

        const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
        const fCourt = calSearchCourt ? calSearchCourt.value.toLowerCase().trim() : '';
        const fStatuses = getSelectedCalendarStatusValues();
        const fMember = calSearchMember ? calSearchMember.value.toLowerCase().trim() : '';
        const fManager = calSearchManager ? calSearchManager.value : '';

        // 나머지 검색 조건 필터링
        dataToAggregate = dataToAggregate.filter(item => {
            let pass = true;
            if (fSakunno && !String(item.sakun_no || '').toLowerCase().includes(fSakunno)) pass = false;
            if (fCourt) {
                const itemCourt = String(item.court || '').toLowerCase().trim();
                const searchCourt = fCourt.toLowerCase().trim();
                if (itemCourt !== searchCourt) pass = false;
            }
            if (fStatuses.length > 0 && !fStatuses.includes(String(item.stu_member || '').trim())) pass = false;
            if (fMember) {
                const memberDisp = `${String(item.m_name || '')}`.toLowerCase();
                if (!memberDisp.includes(fMember)) pass = false;
            }
            if (fManager && item.m_name_id !== fManager) pass = false;
            return pass;
        });

        // 캘린더 점프 필터링
        if (calendarFilter.active) {
            if (calendarFilter.member) {
                dataToAggregate = dataToAggregate.filter(item => isMemberMatch(item, calendarFilter.member));
            }
            if (calendarFilter.status) {
                dataToAggregate = dataToAggregate.filter(item => item.stu_member === calendarFilter.status);
            }
        }

        // 날짜별, 법원별로 집계 (입찰일자 기준)
        dataToAggregate.forEach(item => {
            const itemDate = String(item['in-date'] || '');
            if (!itemDate || itemDate.length < 6) return; // 입찰일자가 없으면 제외

            const itemMonthStr = itemDate.substring(2, 4);
            const itemYearStr = itemDate.substring(0, 2);
            if (itemMonthStr === monthStr && itemYearStr === yearStr) {
                const day = itemDate.substring(4, 6);
                const key = parseInt(day, 10);
                if (!bidsByDay[key]) {
                    bidsByDay[key] = {};
                }
                const court = item.court || '미상';
                if (!bidsByDay[key][court]) {
                    bidsByDay[key][court] = [];
                }
                bidsByDay[key][court].push(item);
            }
        });

        return bidsByDay;
    }

    // 월별(요약) 캘린더 렌더링
    function renderCalendarMonthSummary() {
        if (!calendarDaysContainerMonthSummary) return;

        // 사건번호 조회 시 해당 데이터가 있는 월로 이동 (오늘 이후만)
        const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
        if (fSakunno) {
            const today = new Date();
            const todayYear = String(today.getFullYear()).slice(-2);
            const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
            const todayDay = String(today.getDate()).padStart(2, '0');
            const todayYYMMDD = `${todayYear}${todayMonth}${todayDay}`;

            // 사건번호로 필터링된 물건들 중 오늘 이후의 가장 빠른 입찰일자의 월을 찾기
            const filteredItems = allBiddingData.filter(item => {
                const sakunNo = String(item.sakun_no || '').toLowerCase();
                if (!sakunNo.includes(fSakunno)) return false;

                // 오늘 이후만 필터링
                const inDate = String(item['in-date'] || '');
                if (!inDate || inDate.length < 6) return false;
                const inDateStr = inDate.substring(0, 6); // YYMMDD
                return inDateStr >= todayYYMMDD;
            });

            // 가장 빠른 입찰일자 찾기
            let earliestInDate = null;
            filteredItems.forEach(item => {
                const inDate = String(item['in-date'] || '');
                if (inDate && inDate.length >= 6) {
                    const inDateStr = inDate.substring(0, 6); // YYMMDD
                    if (!earliestInDate || inDateStr < earliestInDate) {
                        earliestInDate = inDateStr;
                    }
                }
            });

            if (earliestInDate) {
                // YYMMDD를 Date 객체로 변환하여 해당 월로 이동
                const year = 2000 + parseInt(earliestInDate.substring(0, 2));
                const month = parseInt(earliestInDate.substring(2, 4)) - 1;
                const day = parseInt(earliestInDate.substring(4, 6));
                const searchDate = new Date(year, month, day);

                if (!isNaN(searchDate.getTime())) {
                    currentCalendarDate = new Date(year, month, 1); // 해당 월의 1일로 설정
                }
            }
        }

        if (allBiddingData.length === 0) {
            toggleCalendarLoading(false);
            calendarDaysContainerMonthSummary.innerHTML = `<div style="grid-column: 1 / span 5;" class="text-center p-8 text-gray-500">데이터가 없습니다.</div>`;
            return;
        }

        // 필터 배너 처리
        if (calendarFilterBanner && calendarFilterText) {
            if (calendarFilter.active) {
                calendarFilterBanner.classList.remove('content-hidden');
                let bannerText = "필터 적용 중";
                if (calendarFilter.member && calendarFilter.status) {
                    bannerText = `[${calendarFilter.member}]님 - [${calendarFilter.status}] 물건 조회`;
                } else if (calendarFilter.member) {
                    bannerText = `[${calendarFilter.member}]님 물건 조회`;
                } else if (calendarFilter.status) {
                    bannerText = `전체 [${calendarFilter.status}] 물건 조회`;
                }
                calendarFilterText.textContent = bannerText;
            } else {
                calendarFilterBanner.classList.add('content-hidden');
            }
        }

        toggleCalendarLoading(false);
        calendarDaysContainerMonthSummary.innerHTML = '';

        const date = currentCalendarDate;
        updateCalendarTitle(date);
        updateCalendarTitleVisibility();
        const year = date.getFullYear();
        const month = date.getMonth();
        const today = new Date();

        const firstDayOfMonth = new Date(year, month, 1);
        const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

        let startDay = firstDayOfMonth.getDay();
        if (startDay === 0) startDay = 7;
        startDay = startDay - 1;
        const bidsByDay = aggregateBidsByCourtAndDay(year, month);

        const dayNames = ['월', '화', '수', '목', '금', '토', '일'];

        // 빈 날짜 채우기 (전월)
        for (let i = 0; i < startDay; i++) {
            if (dayNames[i] === '토' || dayNames[i] === '일') continue;
            calendarDaysContainerMonthSummary.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
        }

        // 날짜 채우기
        for (let i = 1; i <= lastDateOfMonth; i++) {
            const currentDate = new Date(year, month, i);
            const yearStr = String(currentDate.getFullYear()).slice(-2);
            const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
            const dayStr = String(currentDate.getDate()).padStart(2, '0');
            const targetDate = `${yearStr}${monthStr}${dayStr}`;
            const bids = bidsByDay[i] || [];
            const dayOfWeek = currentDate.getDay();

            if (dayOfWeek === 6 || dayOfWeek === 0) continue; // 주말 제외

            const isToday = (currentDate.toDateString() === today.toDateString());
            const dayClass = `calendar-day current-month ${isToday ? 'today' : ''}`;
            const dayName = dayNames[dayOfWeek === 0 ? 6 : dayOfWeek - 1];
            const dayDate = `${month + 1}월 ${i}일 (${dayName})`;

            let contentHtml = '';
            const dayBids = bidsByDay[i] || {};

            // 법원별 건수 계산 및 정렬
            const courtCounts = [];
            let totalCount = 0;
            for (const court in dayBids) {
                const count = dayBids[court].length;
                courtCounts.push({ court, count });
                totalCount += count;
            }
            // 건수 순으로 정렬 (많은 순)
            courtCounts.sort((a, b) => b.count - a.count);

            if (totalCount > 0) {
                // 일별 카드 하나만 생성 (법원별 건수 요약)
                let courtListHtml = '';
                courtCounts.forEach(({ court, count }) => {
                    courtListHtml += `
                      <div class="flex items-center justify-between py-1 px-2 hover:bg-gray-50 rounded">
                          <span class="text-xs font-medium text-gray-700">${court}</span>
                          <span class="text-xs font-bold text-indigo-600">${count}건</span>
                      </div>
                  `;
                });

                const summaryCardHtml = `
                  <div class="border-2 border-indigo-300 rounded-lg p-3 bg-indigo-50 shadow-sm">
                      <div class="flex items-center justify-between mb-2 pb-2 border-b border-indigo-200">
                          <span class="text-sm font-bold text-indigo-800">총 ${totalCount}건</span>
                      </div>
                      <div class="space-y-1 max-h-[400px] overflow-y-auto">
                          ${courtListHtml}
                      </div>
                  </div>
              `;
                contentHtml = summaryCardHtml;
            }

            const dayHtml = `
              <div class="${dayClass}" data-date="${targetDate}" data-has-bids="${totalCount > 0}">
                  <div class="calendar-day-date">${dayDate}</div>
                  ${contentHtml}
              </div>
          `;
            calendarDaysContainerMonthSummary.insertAdjacentHTML('beforeend', dayHtml);
        }

        const totalRenderedDays = calendarDaysContainerMonthSummary.children.length;
        const remainingSlots = 5 - (totalRenderedDays % 5);
        if (remainingSlots > 0 && remainingSlots < 5) {
            for (let i = 0; i < remainingSlots; i++) {
                calendarDaysContainerMonthSummary.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
            }
        }
    }

    // 이전 주 추가 로딩 함수
    function loadPreviousWeeks(weeksToAdd = 4) {
        if (isLoadingPreviousWeeks) return;
        if (numWeeksBefore >= 12) return; // 최대 12주까지만

        isLoadingPreviousWeeks = true;

        const calendarWeekView = document.getElementById('calendar-week-view');
        const calendarDaysContainerWeek = document.getElementById('calendar-days-container-week');

        if (!calendarWeekView || !calendarDaysContainerWeek) {
            isLoadingPreviousWeeks = false;
            return;
        }

        // 현재 첫 번째 주의 높이 저장 (스크롤 위치 유지용)
        const firstWeekElement = calendarDaysContainerWeek.firstElementChild;
        if (!firstWeekElement) {
            isLoadingPreviousWeeks = false;
            return;
        }

        const firstWeekHeight = firstWeekElement.offsetHeight || 600; // 기본값 600px

        // 추가할 주 범위 계산
        const startWeek = getWeekStart(currentCalendarDate);
        const newWeeksBefore = Math.min(numWeeksBefore + weeksToAdd, 12);
        const weeksToRender = newWeeksBefore - numWeeksBefore;

        const today = new Date();
        const dayNames = ['월', '화', '수', '목', '금'];
        let lastMonth = -1;


        // 이전 주들을 DOM 앞에 추가 (역순으로 추가하여 순서 유지)
        let allWeekHtml = '';

        for (let i = weeksToRender - 1; i >= 0; i--) {
            const weekOffset = -(newWeeksBefore - i);
            const weekStart = new Date(startWeek);
            weekStart.setDate(startWeek.getDate() + (weekOffset * 7));

            // 주의 5일(월~금) 렌더링
            for (let j = 0; j < 5; j++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + j);

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const day = currentDate.getDate();

                const isToday = (currentDate.toDateString() === today.toDateString());
                const isMonthChange = (j === 0 && month !== lastMonth);
                lastMonth = month;

                const dayClass = `calendar-day current-month ${isToday ? 'today' : ''} ${isMonthChange ? 'month-change' : ''}`;
                const dayDate = `${month + 1}월 ${day}일 (${dayNames[j]})`;

                let contentHtml = '';

                // 해당 날짜의 입찰 데이터 가져오기
                const yearStr = String(year).slice(-2);
                const monthStr = String(month + 1).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const targetDate = `${yearStr}${monthStr}${dayStr}`;

                // 입찰일자 기준 필터링 (기본)
                const filteredData = allBiddingData.filter(item => {
                    const itemDate = String(item['in-date']);
                    return itemDate === targetDate;
                });

                // 나머지 필터 적용
                const fSakunno = calSearchSakunno ? calSearchSakunno.value.toLowerCase().trim() : '';
                const fCourt = calSearchCourt ? calSearchCourt.value.trim() : '';
                const fStatuses = getSelectedCalendarStatusValues();
                const allCalStatusCb = document.getElementById('cal-search-status-all');
                const isAllCalStatus = (allCalStatusCb && allCalStatusCb.checked);
                const fMember = calSearchMember ? calSearchMember.value.toLowerCase().trim() : '';
                const fManager = calSearchManager ? calSearchManager.value : '';

                const bids = filteredData.filter(item => {
                    if (fSakunno && !String(item.sakun_no || '').toLowerCase().includes(fSakunno)) return false;
                    if (fCourt) {
                        const itemCourt = String(item.court || '').trim();
                        const searchCourt = fCourt.trim();
                        if (itemCourt !== searchCourt) return false;
                    }
                    // 상태 필터링: "전체" 체크 시 통과, 아무것도 선택 안 하면 조회 안 됨
                    const matchesStatus = isAllCalStatus ? true : (fStatuses.length > 0 && fStatuses.includes(item.stu_member || '미정'));
                    if (!matchesStatus) return false;
                    if (fMember) {
                        const memberDisp = `${String(item.m_name || '')}`.toLowerCase();
                        if (!memberDisp.includes(fMember)) return false;
                    }
                    if (fManager && item.m_name_id !== fManager) return false;
                    return true;
                });

                if (bids.length > 0) {
                    bids.forEach(bid => {
                        const bidprice = bid.bidprice || 0;
                        const bidpriceFormatted = (bidprice > 0) ? new Intl.NumberFormat('ko-KR').format(bidprice) + '원' : '';
                        const mNameIdClass = (bid.m_name_id !== '대표님' && bid.m_name_id !== null && bid.m_name_id !== undefined && bid.m_name_id !== '') ? 'm-name-id-red' : '';
                        const mNameValue = bid.m_name || '';
                        const statusClass = getStatusTagClass(bid.stu_member);
                        const courtButtonClass = 'button-like-content';

                        const isNewBid = (bid.bid_state === '신규' || !bid.bid_state);
                        const bidPriceMobileClass = isNewBid ? 'text-red-600 font-bold' : 'text-gray-700 font-bold';
                        const bidPricePcClass = isNewBid ? 'bidprice-cell text-red-600' : 'bidprice-cell';

                        const isNoPrice = (!bid.bidprice || bid.bidprice === 0 || bid.bidprice === '0');
                        const mobileBorder = isNoPrice ? 'border-2 border-red-600' : 'border-2 border-slate-400';
                        const desktopBorder = isNoPrice ? 'border-[2px] border-red-600' : 'border-[1px] border-slate-500';

                        // 이미지 존재 여부 확인 (has_images 플래그 사용)
                        const hasImages = !!bid.has_images;
                        const imgButtonHtml = `<span class="inline-block w-5 text-center flex-shrink-0">${hasImages ? `<span class="inline-block w-3.5 h-3.5 rounded-full bg-green-500 cursor-pointer" onclick="event.stopPropagation(); openDetailModalWithTab('${bid.id}', true)" title="이미지 있음"></span>` : ''}</span>`;

                        const mobileHtml = `
                          <div class="md:hidden border-2 border-green-300 rounded-xl p-3 mb-2 bg-stone-50 shadow-sm flex items-center justify-between cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                              <div class="text-indigo-600 font-bold text-sm sm:text-base w-[40%] flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div>
                              <div class="flex flex-col items-center justify-center w-[20%] space-y-1">
                                  <span class="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded text-gray-600 whitespace-nowrap">${bid.court || '미상'}</span>
                                  <span class="text-xs font-bold ${mNameIdClass}">${bid.m_name_id || '대표님'}</span>
                              </div>
                              <div class="flex flex-col items-end w-[40%] space-y-1">
                                  <div class="flex items-center space-x-1">
                                      <span class="${statusClass} text-[10px] px-1.5 py-0.5 rounded whitespace-nowrap" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span>
                                      <span class="text-xs font-bold text-gray-800">${mNameValue}</span>
                                  </div>
                                  <div class="text-sm ${bidPriceMobileClass}">${bidpriceFormatted}</div>
                              </div>
                          </div>
                      `;

                        const desktopHtml = `
                          <table class="hidden md:table bid-item-table ${desktopBorder} cursor-pointer" onclick="openDetailModalById('${bid.id}')">
                              <tbody>
                                  <tr>
                                      <td rowspan="2" class="sakun-no-cell" style="width: 40%;"><div class="flex items-start">${imgButtonHtml}<span>${bid.sakun_no || '미상'}</span></div></td>
                                      <td class="court-cell" style="width: 21%;"><span class="${courtButtonClass}">${bid.court || '미상'}</span></td>
                                  <td class="stu-cell" style="width: 17%;"><span class="${statusClass}" onclick="event.stopPropagation(); confirmAndSendTelegramForItem_('${bid.member_id || ''}','${bid.id || ''}')">${bid.stu_member || '미정'}</span></td>
                                      <td class="m-name-cell" style="width: 22%;">${mNameValue}</td>
                                  </tr>
                                  <tr>
                                      <td class="${mNameIdClass}" style="width: 21%;">${bid.m_name_id || '대표님'}</td>
                                      <td colspan="2" class="${bidPricePcClass}">${bidpriceFormatted}</td>
                                  </tr>
                              </tbody>
                          </table>
                      `;
                        contentHtml += mobileHtml + desktopHtml;
                    });
                }

                const dayHtml = `
                  <div class="${dayClass}">
                      <div class="calendar-day-date">${dayDate}</div>
                      ${contentHtml}
                  </div>
              `;
                allWeekHtml = dayHtml + allWeekHtml;
            }
        }

        // DOM 앞에 추가
        calendarDaysContainerWeek.insertAdjacentHTML('afterbegin', allWeekHtml);

        // 스크롤 위치 유지 (추가된 높이만큼 스크롤 위치 조정)
        requestAnimationFrame(() => {
            const addedHeight = firstWeekHeight * weeksToRender;
            calendarWeekView.scrollTop = calendarWeekView.scrollTop + addedHeight;

            // 상태 업데이트
            numWeeksBefore = newWeeksBefore;
            isLoadingPreviousWeeks = false;
        });
    }

    // --- [4] 대시보드 렌더링 ---

    function updateDashboardFilterOptions() {
        const filters = ['missingBidFilterMember', 'statusFilterMember'];
        const members = new Set();
        allBiddingData.forEach(item => {
            if (item.m_name_id && item.m_name_id.trim() !== '') {
                members.add(item.m_name_id);
            }
        });
        let optionsHtml = `<option value="">전체</option>`;
        if (members.has('대표님')) members.delete('대표님');
        optionsHtml += `<option value="대표님">대표님</option>`;
        [...members].sort().forEach(member => {
            optionsHtml += `<option value="${member}">${member}</option>`;
        });
        filters.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentVal = select.value;
                select.innerHTML = optionsHtml;
                select.value = currentVal;
                if (select.value !== currentVal) select.value = '';
            }
        });

        // 입찰일정 메뉴의 입찰가 담당 드롭다운도 업데이트
        if (calSearchManager) {
            const currentVal = calSearchManager.value;
            calSearchManager.innerHTML = optionsHtml;
            calSearchManager.value = currentVal || '';
        }
    }

    function renderMissingBidDashboard() {
        if (!missingBidTableBody) return;
        missingBidTableBody.innerHTML = '';
        const targetDates = getWorkingDaysFromToday();
        const filterMember = document.getElementById('missingBidFilterMember') ? document.getElementById('missingBidFilterMember').value : '';

        targetDates.forEach((dateObj, index) => {
            const year = String(dateObj.getFullYear()).slice(-2);
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const targetYYMMDD = `${year}${month}${day}`;

            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const dDay = index === 0 ? "오늘" : `D-${index}`;
            const dDayColor = index === 0 ? "text-gray-800" : "text-red-500";
            const dateStr = `${month}/${day} (${dayNames[dateObj.getDay()]})`;

            const missingCount = allBiddingData.filter(item => {
                const itemDate = String(item['in-date']);
                const price = parseInt(String(item.bidprice || 0));
                const filterMemberVal = filterMember;
                const itemMember = item.m_name_id || '';
                const isTargetMember = (filterMemberVal === 'All' || filterMemberVal === '') || (itemMember === filterMemberVal);
                return itemDate === targetYYMMDD && (isNaN(price) || price === 0) && item.stu_member === '입찰' && isTargetMember;
            }).length;
            const displayCount = missingCount === 0 ? "없음" : `${missingCount}건`;
            const textColorClass = missingCount > 0 ? "text-red-600 font-bold" : "text-gray-400";
            const cursorClass = missingCount > 0 ? "cursor-pointer hover:bg-gray-100" : "";

            const row = document.createElement('tr');
            row.className = `border-b border-gray-100 transition ${cursorClass}`;
            row.innerHTML = `
              <td class="py-2 px-3 text-left whitespace-nowrap">
                  <span class="${dDayColor} font-bold mr-2 text-sm">${dDay}</span>
                  <span class="text-gray-500 text-sm">${dateStr}</span>
              </td>
              <td class="py-2 px-3 text-center text-sm">
                  <span class="${textColorClass}">${displayCount}</span>
              </td>
          `;
            if (missingCount > 0) {
                row.onclick = () => filterFromDashboard(targetYYMMDD, 'missing', null, filterMember);
            }
            missingBidTableBody.appendChild(row);
        });
    }

    function renderStatusManagementDashboard() {
        if (!statusTableBody) return;
        statusTableBody.innerHTML = '';
        const targetDates = getWorkingDaysFromToday();
        const statuses = ['상품', '미정', '추천', '입찰', '변경'];
        const filterMember = document.getElementById('statusFilterMember') ? document.getElementById('statusFilterMember').value : '';
        const statusStyles = {
            '상품': 'bg-yellow-100 text-yellow-800',
            '미정': 'bg-gray-100 text-gray-700',
            '추천': 'bg-orange-100 text-orange-800',
            '입찰': 'bg-indigo-100 text-indigo-800',
            '변경': 'bg-gray-600 text-white'
        };
        targetDates.forEach((dateObj, index) => {
            const year = String(dateObj.getFullYear()).slice(-2);
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const targetYYMMDD = `${year}${month}${day}`;

            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const dDay = index === 0 ? "오늘" : `D-${index}`;
            const dDayColor = index === 0 ? "text-gray-800" : "text-red-500";
            const dateStr = `${month}/${day} (${dayNames[dateObj.getDay()]})`;

            const row = document.createElement('tr');
            row.className = "border-b border-gray-100 hover:bg-gray-50";

            let html = `<td class="py-2 px-3 text-left border-r bg-gray-50 whitespace-nowrap">
              <span class="${dDayColor} font-bold mr-1 text-sm">${dDay}</span>
              <span class="text-gray-400 text-sm">${dateStr}</span>
          </td>`;
            statuses.forEach(status => {
                const count = allBiddingData.filter(item => {
                    const isDateMatch = String(item['in-date']) === targetYYMMDD;
                    const isStatusMatch = item.stu_member === status;
                    const itemMember = item.m_name_id || '';
                    const isMemberMatch = (filterMember === 'All' || filterMember === '') || (itemMember === filterMember);
                    return isDateMatch && isStatusMatch && isMemberMatch;
                }).length;

                const displayContent = count > 0 ? count : "";
                const styleClass = count > 0 ? `${statusStyles[status]} font-bold cursor-pointer hover:opacity-80` : "";
                const clickAttr = count > 0
                    ? `onclick="filterFromDashboard('${targetYYMMDD}', 'status', '${status}', '${filterMember}')"`
                    : "";

                html += `<td class="py-2 px-1 ${styleClass} text-center text-sm transition duration-150 border-r border-gray-100" ${clickAttr}>${displayContent}</td>`;
            });

            row.innerHTML = html;
            statusTableBody.appendChild(row);
        });

        const totalRow = document.createElement('tr');
        totalRow.className = "bg-blue-50 font-bold border-t-2 border-blue-100";
        let totalHtml = `<td class="py-2 px-3 text-left border-r text-blue-800 text-sm">전체 당일~</td>`;
        statuses.forEach(status => {
            const totalCount = allBiddingData.filter(item => {
                const isDateMatch = String(item['in-date']) >= todayYYMMDD;
                const isStatusMatch = item.stu_member === status;
                const itemMember = item.m_name_id || '';
                const isMemberMatch = (filterMember === 'All' || filterMember === '') || (itemMember === filterMember);
                return isDateMatch && isStatusMatch && isMemberMatch;
            }).length;

            const displayContent = totalCount > 0 ? totalCount : "";
            const cursorClass = totalCount > 0 ? "cursor-pointer hover:bg-blue-200 text-blue-800" : "text-gray-300";
            const clickAttr = totalCount > 0
                ? `onclick="filterFromDashboard('${todayYYMMDD}', 'total_status', '${status}', '${filterMember}')"`
                : "";

            totalHtml += `<td class="py-2 px-1 ${cursorClass} text-center text-sm transition duration-150 border-r border-blue-100" ${clickAttr}>${displayContent}</td>`;
        });
        totalRow.innerHTML = totalHtml;
        statusTableBody.appendChild(totalRow);
    }

    // 차트 그리기
    function renderMemberBidChart() {
        if (!memberBidChartCanvas || !summaryText) return;

        const memberData = {};
        const uniqueMembers = new Set();
        const summaryCounts = { product: 0, recommend: 0, bid: 0, change: 0, undecided: 0 };
        allBiddingData.forEach(item => {
            let memberName = item.m_name;
            if (!memberName || memberName.trim() === '' || memberName === '미등록') {
                memberName = '미정';
            }
            uniqueMembers.add(memberName);

            const status = item.stu_member;
            if (status === '상품') summaryCounts.product++;
            else if (status === '추천') summaryCounts.recommend++;
            else if (status === '입찰') summaryCounts.bid++;
            else if (status === '변경') summaryCounts.change++;
            else if (status === '미정') summaryCounts.undecided++;

            if (!memberData[memberName]) {
                memberData[memberName] = { '상품': 0, '미정': 0, '추천': 0, '입찰': 0, '변경': 0 };
            }

            if (['상품', '미정', '추천', '입찰', '변경'].includes(status)) {
                memberData[memberName][status]++;
            } else {
                memberData[memberName]['미정']++;
            }
        });
        summaryText.innerHTML = `
          전체 회원수: ${uniqueMembers.size}명 
          (<span class="summary-item" onclick="filterCalendarByStatus('상품')">상품 ${summaryCounts.product}건</span> |
           <span class="summary-item" onclick="filterCalendarByStatus('미정')">미정 ${summaryCounts.undecided}건</span> |
           <span class="summary-item" onclick="filterCalendarByStatus('추천')">추천 ${summaryCounts.recommend}건</span> | 
           <span class="summary-item" onclick="filterCalendarByStatus('입찰')">입찰 ${summaryCounts.bid}건</span> | 
           <span class="summary-item" onclick="filterCalendarByStatus('변경')">변경 ${summaryCounts.change}건</span>)
       `;
        let labels = Object.keys(memberData).sort();
        const indexUndecided = labels.indexOf('미정');
        if (indexUndecided > -1) {
            labels.splice(indexUndecided, 1);
            labels.unshift('미정');
        }

        const productData = labels.map(name => memberData[name]['상품']);
        const undecidedData = labels.map(name => memberData[name]['미정']);
        const recommendData = labels.map(name => memberData[name]['추천']);
        const bidData = labels.map(name => memberData[name]['입찰']);
        const changeData = labels.map(name => memberData[name]['변경']);
        if (memberBidChartInstance) {
            memberBidChartInstance.destroy();
        }

        memberBidChartInstance = new Chart(memberBidChartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '상품', data: productData, backgroundColor: 'rgba(253, 224, 71, 0.8)', stack: 'Stack 0' },
                    { label: '미정', data: undecidedData, backgroundColor: 'rgba(209, 213, 219, 0.8)', stack: 'Stack 0' },
                    { label: '추천', data: recommendData, backgroundColor: 'rgba(251, 191, 36, 0.8)', stack: 'Stack 0' },
                    { label: '입찰', data: bidData, backgroundColor: 'rgba(79, 70, 229, 0.8)', stack: 'Stack 0' },
                    { label: '변경', data: changeData, backgroundColor: 'rgba(75, 85, 99, 0.8)', stack: 'Stack 0' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } },
                onClick: (e, activeElements) => {
                    if (activeElements.length > 0) {
                        const element = activeElements[0];
                        const index = element.index;
                        const memberName = labels[index];
                        filterCalendarByMemberAndStatus(memberName, null);
                    }
                },
                plugins: { tooltip: { mode: 'index', intersect: false }, legend: { position: 'top' } }
            }
        });
        toggleDashboardLoading(false);
    }

    // =============================================================================
    // 4. 핵심 로직 및 이벤트 핸들러 (Controller)
    // =============================================================================

    // --- [1] 생성/수정/모달 제어 ---
    function goToCreateMode() {
        // Remove active row highlighting
        if (activeRow) {
            activeRow.classList.remove('bg-indigo-100', 'border-indigo-500', 'font-semibold');
            activeRow = null;
        }

        // Clear the form completely by calling showForm('create')
        showForm('create');

        // Additional explicit resets to ensure clean state
        if (formId) formId.value = '';
        if (formInDate) formInDate.value = '';
        if (formSakunNo) formSakunNo.value = '';
        if (formCourt) formCourt.value = '';
        if (formBidPrice) formBidPrice.value = '';
        if (formMName) formMName.value = '';
        if (formMemberId) formMemberId.value = '';
        const formMName2El = document.getElementById('form-m-name2');
        if (formMName2El) formMName2El.value = '';
        if (formImageId) formImageId.value = '';

        // Reset status to default
        if (formStuMember) formStuMember.value = '미정';
        if (formMNameId) formMNameId.value = '대표님';

        // Update form title
        if (formTitle) formTitle.textContent = '새 입찰 정보 등록';

        // Ensure correct button visibility
        if (createTopButton) {
            createTopButton.classList.remove('content-hidden');
            createTopButton.style.display = 'block';
        }
        if (editTopButton) editTopButton.classList.add('content-hidden');
        if (deleteTopButton) deleteTopButton.classList.add('content-hidden');
        if (goBackToCreateButton) goBackToCreateButton.classList.add('content-hidden');

        const telegramTopButton = document.getElementById('telegramTopButton');
        if (telegramTopButton) telegramTopButton.classList.add('content-hidden');

        // [추가] 등록 모드에서 텔레그램 유형 선택 숨김
        const detailTelegramStyleSelect = document.getElementById('detail-telegram-style-select');
        if (detailTelegramStyleSelect) detailTelegramStyleSelect.classList.add('hidden'); // 또는 content-hidden

        // [추가] 등록 화면에서도 옥션원 버튼 노출 (로그인 유도)
        updateAuctionUrlButtonVisibility();

        // Clear member display info
        const displayMemberId = document.getElementById('display-member-id');
        const displayMemberMyungui = document.getElementById('display-member-myungui');
        if (displayMemberId) displayMemberId.textContent = '';
        if (displayMemberMyungui) displayMemberMyungui.textContent = '';

        // Clear telegram info
        const telegramUsername = document.getElementById('form-telegram-username');
        const memberTokenDisplay = document.getElementById('form-member-token-display');
        const telegramChatId = document.getElementById('form-telegram-chat-id');
        if (telegramUsername) telegramUsername.textContent = '-';
        if (memberTokenDisplay) memberTokenDisplay.textContent = '-';
        if (telegramChatId) telegramChatId.textContent = '-';

        // Clear ID/date info
        const currentIdDisplayMoved = document.getElementById('currentIdDisplay-moved');
        const currentModDate = document.getElementById('currentModDate');
        if (currentIdDisplayMoved) currentIdDisplayMoved.textContent = '-';
        if (currentModDate) currentModDate.textContent = '-';

        // Clear item detail member token
        const itemMemberTokenEl = document.getElementById('item-detail-member-token');
        if (itemMemberTokenEl) itemMemberTokenEl.value = '';

        // Clear investigation images
        const investigationImageContainer = document.getElementById('investigationImageContainer');
        if (investigationImageContainer) {
            investigationImageContainer.innerHTML = '<p id="investigationPlaceholder" class="text-gray-500 text-center py-8 self-center w-full">매칭된 이미지 없음</p><div id="investigationImageList" class="w-full flex flex-col gap-4 p-1 content-hidden"></div>';
        }
        const investigationImageIdsFooter = document.getElementById('investigationImageIdsFooter');
        if (investigationImageIdsFooter) {
            investigationImageIdsFooter.textContent = '';
        }

        // Clear current detail item
        currentDetailItem = null;
        currentItemDetailTab = 'detail';

        // Switch to detail tab
        if (typeof switchItemDetailTab === 'function') {
            switchItemDetailTab('detail');
        }

        // Handle mobile view
        if (window.innerWidth < 768) {
            const listPane = document.getElementById('listPane');
            const detailPane = document.getElementById('detailPane');
            if (listPane) listPane.classList.remove('mobile-hidden');
            if (detailPane) {
                detailPane.classList.add('mobile-hidden');
                detailPane.classList.remove('mobile-fullscreen');
            }
        }
    }

    function showForm(mode, data = {}) {
        currentMode = mode;
        if (window.innerWidth < 768) {
            const listPane = document.getElementById('listPane');
            const detailPane = document.getElementById('detailPane');
            if (listPane) listPane.classList.add('mobile-hidden');
            if (detailPane) {
                detailPane.classList.remove('mobile-hidden');
                detailPane.classList.add('mobile-fullscreen');
            }
        }

        const displayMemberId = document.getElementById('display-member-id');
        const formBidState = document.getElementById('form-bid-state');
        const elRegMember = document.getElementById('form-reg-member');
        const itemMemberTokenEl = document.getElementById('item-detail-member-token');
        const telegramTopButton = document.getElementById('telegramTopButton');

        if (mode === 'create') {
            if (formTitle) formTitle.textContent = '새 입찰 정보 등록';
            if (formId) formId.value = '';
            if (formSakunNo) formSakunNo.value = '';
            if (formBidPrice) formBidPrice.value = '';
            if (formStuMember) formStuMember.value = formStuMember.value || '미정';
            if (formMNameId) formMNameId.value = formMNameId.value || '대표님';
            if (formMName) formMName.value = '';
            if (formMemberId) formMemberId.value = '';

            const formMName2El = document.getElementById('form-m-name2');
            if (formMName2El) formMName2El.value = '';
            if (formBidState) formBidState.value = '';
            if (formImageId) formImageId.value = '';
            if (elRegMember) elRegMember.value = '';
            if (displayMemberId) displayMemberId.textContent = '';
            if (itemMemberTokenEl) itemMemberTokenEl.value = '';

            // 물건그랩경보 초기화 (회원 텔레그램 정보)
            const telegramUsername = document.getElementById('form-telegram-username');
            const memberTokenDisplay = document.getElementById('form-member-token-display');
            const telegramChatId = document.getElementById('form-telegram-chat-id');
            if (telegramUsername) telegramUsername.textContent = '-';
            if (memberTokenDisplay) memberTokenDisplay.textContent = '-';
            if (telegramChatId) telegramChatId.textContent = '-';

            // ID 정보 초기화
            const currentIdDisplayMoved = document.getElementById('currentIdDisplay-moved');
            const currentModDate = document.getElementById('currentModDate');
            if (currentIdDisplayMoved) currentIdDisplayMoved.textContent = '-';
            if (currentModDate) currentModDate.textContent = '-';

            if (window.innerWidth < 768) {
                if (goBackToCreateButton) {
                    goBackToCreateButton.classList.remove('content-hidden');
                    goBackToCreateButton.textContent = '목록으로';
                }
            } else {
                if (goBackToCreateButton) goBackToCreateButton.classList.add('content-hidden');
            }
            if (createTopButton) createTopButton.style.display = 'block';
            if (editTopButton) editTopButton.classList.add('content-hidden');
            if (deleteTopButton) deleteTopButton.classList.add('content-hidden');
            if (telegramTopButton) telegramTopButton.classList.add('content-hidden');
            currentDetailItem = null;
            currentItemDetailTab = 'detail';
            if (typeof switchItemDetailTab === 'function') switchItemDetailTab('detail');
        } else {
            if (formTitle) formTitle.textContent = `입찰정보상세 및 수정`;
            if (goBackToCreateButton) {
                goBackToCreateButton.classList.remove('content-hidden');
                if (window.innerWidth < 768) {
                    goBackToCreateButton.textContent = '목록으로';
                } else {
                    goBackToCreateButton.textContent = '등록화면';
                }
            }
            if (createTopButton) createTopButton.style.display = 'none';
            if (editTopButton) editTopButton.classList.remove('content-hidden');
            if (deleteTopButton) deleteTopButton.classList.remove('content-hidden');
            if (telegramTopButton) telegramTopButton.classList.remove('content-hidden');

            const safeId = String(data.id || '');
            const shortId = safeId.length > 8 ? safeId.substring(0, 8) + '...' : safeId;

            // 메타데이터 정보 업데이트
            const currentIdDisplayMoved = document.getElementById('currentIdDisplay-moved');
            const currentModDate = document.getElementById('currentModDate');
            const currentRegMember = document.getElementById('currentRegMember');
            const currentRegDate = document.getElementById('currentRegDate');

            if (currentIdDisplayMoved) currentIdDisplayMoved.textContent = data.image_id || '-';
            if (currentModDate) {
                const modDate = data.mod_date || '-';
                currentModDate.textContent = modDate;
            }
            if (currentRegMember) currentRegMember.textContent = data.reg_member || '-';
            if (currentRegDate) currentRegDate.textContent = data.reg_date || '-';

            if (formId) formId.value = safeId;
            if (formInDate) formInDate.value = data['in-date'] || '';
            if (formSakunNo) formSakunNo.value = data.sakun_no || '';
            if (formCourt) formCourt.value = data.court || '';
            if (formStuMember) formStuMember.value = data.stu_member || '미정';
            if (formMemberId) formMemberId.value = data.member_id || '';
            if (itemMemberTokenEl) itemMemberTokenEl.value = '';
            // [수정] items 시트의 m_name 우선순위 적용 (없을 경우에만 회원 DB 참조)
            if (formMName) {
                const mem = data.member_id ? getMemberById_(data.member_id) : null;
                const base = (data.m_name && String(data.m_name).trim()) ? data.m_name : (mem ? getMemberName_(mem) : '');
                const alias = String(data.m_name2 || '').trim();
                // 명의 중복 방지: base에 alias가 이미 포함되어 있으면 alias를 붙이지 않음
                formMName.value = (alias && !base.includes(alias)) ? `${base} ${alias}` : base;
            }



            if (formBidState) formBidState.value = data.bid_state || '';
            if (formImageId) formImageId.value = data.image_id || '';
            if (formNote) formNote.value = data.note || '';

            if (elRegMember) elRegMember.value = data.reg_member || '';

            if (displayMemberId) {
                if (data.member_id) {
                    let displayId = data.member_id;
                    if (displayId === 'b69b381b-0f36-429d-a110-876c5c2d7598') {
                        displayId = '이정우';
                    }
                    const regDate = data.reg_date ? data.reg_date : '';
                    displayMemberId.textContent = `(${regDate}, ${displayId})`;
                } else {
                    displayMemberId.textContent = '';
                }
            }

            // 회원 토큰 표시(없으면 생성)
            if (data.member_id && itemMemberTokenEl && typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(res => {
                        if (res && res.success && itemMemberTokenEl) itemMemberTokenEl.value = res.member_token || '';
                    })
                    .withFailureHandler(_err => { })
                    .ensureMemberToken(data.member_id);
            }

            // [NEW] 회원 텔레그램 정보 및 토큰 표시 (allMemberData 활용)
            if (data.member_id && typeof allMemberData !== 'undefined' && Array.isArray(allMemberData)) {
                const mem = allMemberData.find(m => String(m.member_id) === String(data.member_id));
                if (mem) {
                    // 텔레그램 Username -> Y/N (telegram_enabled)로 변경
                    const telegramUsername = document.getElementById('form-telegram-username');
                    if (telegramUsername) {
                        telegramUsername.textContent = (mem.telegram_enabled === 'Y') ? 'Y' : 'N';
                    }

                    // Member Token Display
                    const memberTokenDisplay = document.getElementById('form-member-token-display');
                    if (memberTokenDisplay) memberTokenDisplay.textContent = mem.member_token || '-';

                    // Chat ID
                    const telegramChatId = document.getElementById('form-telegram-chat-id');
                    if (telegramChatId) telegramChatId.textContent = mem.telegram_chat_id || '-';

                }
            }

            if (formMNameId) formMNameId.value = data.m_name_id || '대표님';

            const price = data.bidprice;
            if (formBidPrice) formBidPrice.value = (price == 0 || price === '0') ? '' : new Intl.NumberFormat('ko-KR').format(price);

            // [NEW] 입찰가 상태(신규/전송됨) 버튼 초기화
            const currentBidState = data.bid_state || '신규'; // 기본값 신규
            setBidState(currentBidState, false); // false: 값만 세팅하고 UI 업데이트 (이벤트 발생 X)

            currentDetailItem = data;
            // 물건 선택 시 항상 상세 탭으로 시작
            currentItemDetailTab = 'detail';
            if (typeof switchItemDetailTab === 'function') switchItemDetailTab('detail');
            // 회원 부가정보(명의/토큰/텔레그램) 표기 갱신
            try { updateMemberTokenInfo('main'); } catch (e) { }
        }
    }

    // --- [NEW] Start of Helper Functions for Bidding Detail ---

    // 법원 코드 (SheetDB.js와 동일하게 유지)
    const COURT_CODES = ['공매', '인천', '서울중앙', '서울동부', '서울서부', '서울남부', '서울북부', '의정부', '의정부고양', '의정부남양주', '인천부천', '수원', '수원성남', '수원평택', '수원안산', '수원안양', '수원여주', '춘천', '춘천강릉', '춘천원주', '춘천속초', '춘천영월', '대전', '대전홍성', '대전공주', '대전논산', '대전서산', '대전천안', '청주', '청주충주', '청주제천', '청주영동', '대구', '대구서부', '대구안동', '대구경주', '대구포항', '대구김천', '대구상주', '대구의성', '대구영덕', '부산', '부산동부', '부산서부', '울산', '창원', '창원마산', '창원진주', '창원통영', '창원밀양', '창원거창', '광주', '광주목포', '광주장흥', '광주순천', '광주해남', '전주', '전주군산', '전주정읍', '전주남원', '제주'];

    function validateCourt(input) {
        const val = input.value.trim();
        if (val && !COURT_CODES.includes(val)) {
            alert('허용되지 않은 법원명입니다.\n목록에서 선택해주세요.');
            input.value = '';
            input.focus();
        }
    }

    function validateMember(input) {
        const mName = input.value.trim();
        if (!mName) return;

        // "이정우 (MJ) 한한한" 형식에서 이름 부분만 추출하여 비교
        const cleanMName = mName.split(' ')[0].split('(')[0].trim();
        const memberList = (typeof allMembersNewData !== 'undefined' && allMembersNewData.length > 0) ? allMembersNewData : (allMemberData || []);
        const isValidMember = memberList && memberList.some(m => String(m.member_name || m.name || '').trim() === cleanMName);

        if (!isValidMember) {
            alert('등록되지 않은 회원입니다.');
            input.value = '';
            input.focus();
        }
    }

    function setBidState(state, updateHidden = true) {
        const btnNew = document.getElementById('btn-bid-new');
        const btnDone = document.getElementById('btn-bid-done');
        const hiddenInput = document.getElementById('form-bid-state');

        if (state === '신규') {
            if (btnNew) {
                btnNew.classList.remove('bg-white', 'text-gray-600');
                btnNew.classList.add('bg-red-100', 'text-red-600', 'font-bold', 'border-red-200');
            }
            if (btnDone) {
                btnDone.classList.remove('bg-green-100', 'text-green-600', 'font-bold', 'border-green-200');
                btnDone.classList.add('bg-white', 'text-gray-600');
            }
        } else {
            if (btnNew) {
                btnNew.classList.remove('bg-red-100', 'text-red-600', 'font-bold', 'border-red-200');
                btnNew.classList.add('bg-white', 'text-gray-600');
            }
            if (btnDone) {
                btnDone.classList.remove('bg-white', 'text-gray-600');
                btnDone.classList.add('bg-green-100', 'text-green-600', 'font-bold', 'border-green-200');
            }
        }

        if (updateHidden && hiddenInput) {
            hiddenInput.value = state;
        }
    }

    function goToMemberManagement() {
        const nameInput = document.getElementById('form-m-name');
        let memberName = '';
        if (nameInput) {
            // "홍길동 (ID) ..." 형식에서 이름만 추출
            const val = nameInput.value;
            const match = val.match(/^([^\(]+)/);
            if (match) {
                memberName = match[1].trim();
            } else {
                memberName = val.trim();
            }
        }

        navigateTo('MemberManagement');

        // 약간의 지연 후 검색 실행 (탭 전환 및 DOM 준비 시간 고려)
        setTimeout(() => {
            const searchInput = document.getElementById('mem-search-name');
            if (searchInput) {
                searchInput.value = memberName;
                if (typeof filterMembersNew === 'function') {
                    filterMembersNew();
                } else if (typeof filterMembers === 'function') {
                    filterMembers();
                }
            }
        }, 100);
    }

    function handleDetailTelegramSend() {
        // 상세 화면의 MemberID, ItemID 가져오기
        const memberIdEl = document.getElementById('form-member-id');
        const itemIdEl = document.getElementById('form-id');

        if (!memberIdEl || !itemIdEl) {
            showStatus('회원 ID 또는 물건 ID를 찾을 수 없습니다.', 'error');
            return;
        }

        const memberId = memberIdEl.value;
        const itemId = itemIdEl.value;

        if (!memberId) {
            showStatus('회원이 선택되지 않았습니다.', 'error');
            return;
        }
        if (!itemId) {
            showStatus('저장되지 않은 물건입니다. 먼저 저장해주세요.', 'error');
            return;
        }

        // [추가] 상세 화면의 텔레그램 스타일 드롭다운 값 읽기
        const styleSelect = document.getElementById('detail-telegram-style-select');
        const styleKey = styleSelect ? styleSelect.value : 'card';

        // 기존 confirmAndSendTelegramForItem_ 함수 활용 (스타일 파라미터 추가)
        if (typeof confirmAndSendTelegramForItem_ === 'function') {
            confirmAndSendTelegramForItem_(memberId, itemId, styleKey);
        } else {
            showStatus('전송 함수를 찾을 수 없습니다.', 'error');
        }
    }

    function updateMemberDatalist() {
        const datalist = document.getElementById('member-name-with-myungui-datalist');
        if (!datalist) return;
        datalist.innerHTML = '';

        if (!allMemberData || !Array.isArray(allMemberData)) return;

        allMemberData.forEach(member => {
            const option = document.createElement('option');
            // Format: Name (ID) Name1 Name2 Name3
            let label = `${member.member_name || member.name} (${member.member_id})`;
            const extras = [];
            if (member.name1) extras.push(member.name1);
            if (member.name2) extras.push(member.name2);
            if (member.name3) extras.push(member.name3);

            if (extras.length > 0) {
                label += ' ' + extras.join(' ');
            }

            option.value = label;
            datalist.appendChild(option);
        });

        // input 이벤트 리스너 연결 (datalist 선택 감지용)
        const input = document.getElementById('form-m-name');
        if (input) {
            // 중복 방지를 위해 기존 리스너 제거 방식은 복잡하므로, 속성에 저장된 핸들러가 없으면 추가
            if (!input.dataset.hasMemberListener) {
                input.addEventListener('input', onMemberNameInput);
                input.dataset.hasMemberListener = 'true';
            }
        }
    }

    function onMemberNameInput(e) {
        const val = e.target.value;
        // "(ID)" 패턴 찾기
        const match = val.match(/\(([^)]+)\)/);
        if (match && match[1]) {
            const id = match[1];
            const memberIdField = document.getElementById('form-member-id');
            if (memberIdField && memberIdField.value !== id) {
                memberIdField.value = id;

                // 회원 정보(텔레그램 등) 업데이트 시뮬레이션
                if (typeof allMemberData !== 'undefined') {
                    const mem = allMemberData.find(m => String(m.member_id) === String(id));
                    if (mem) {
                        const telegramUsername = document.getElementById('form-telegram-username');
                        if (telegramUsername) {
                            const enabled = mem.telegram_enabled || '';
                            telegramUsername.textContent = (enabled === 'Y') ? 'Y' : 'N';
                        }
                        const memberTokenDisplay = document.getElementById('form-member-token-display');
                        if (memberTokenDisplay) memberTokenDisplay.textContent = mem.member_token || '-';
                        const telegramChatId = document.getElementById('form-telegram-chat-id');
                        if (telegramChatId) telegramChatId.textContent = mem.telegram_chat_id || '-';
                    }
                }
            }
        }
    }
    // --- [NEW] End of Helper Functions ---

    function copyItemDetailMemberToken() {
        const el = document.getElementById('item-detail-member-token');
        const token = el ? String(el.value || '').trim() : '';
        if (!token) {
            showStatus('복사할 토큰이 없습니다.', 'error');
            return;
        }
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(token).then(() => {
                showStatus('토큰을 복사했습니다.', 'success');
            }).catch(() => {
                try {
                    el.focus();
                    el.select();
                    document.execCommand('copy');
                    showStatus('토큰을 복사했습니다.', 'success');
                } catch (e) {
                    showStatus('복사에 실패했습니다.', 'error');
                }
            });
            return;
        }
        try {
            el.focus();
            el.select();
            document.execCommand('copy');
            showStatus('토큰을 복사했습니다.', 'success');
        } catch (e) {
            showStatus('복사에 실패했습니다.', 'error');
        }
    }

    function switchItemDetailTab(tabName) {
        currentItemDetailTab = tabName;
        var btnDetail = document.getElementById('btnTabDetail');
        var btnInvestigation = document.getElementById('btnTabInvestigation');
        var contentDetail = document.getElementById('itemDetailTabContent');
        var contentInvestigation = document.getElementById('itemInvestigationTabContent');
        var placeholderEl = document.getElementById('investigationPlaceholder');
        var toolbar = document.getElementById('investigationToolbar');
        var detailPane = document.getElementById('detailPane');

        if (!contentDetail || !contentInvestigation) return;

        if (detailPane) {
            detailPane.classList.remove('tab-detail-active', 'tab-investigation-active');
            detailPane.classList.add('tab-' + tabName + '-active');
        }

        if (tabName === 'detail') {
            if (btnDetail) btnDetail.classList.add('active');
            if (btnInvestigation) btnInvestigation.classList.remove('active');
            contentDetail.classList.remove('content-hidden');
            contentInvestigation.classList.add('content-hidden');
            if (toolbar) toolbar.classList.add('content-hidden');
        } else {
            if (btnInvestigation) btnInvestigation.classList.add('active');
            if (btnDetail) btnDetail.classList.remove('active');
            contentDetail.classList.add('content-hidden');
            contentInvestigation.classList.remove('content-hidden');
            if (toolbar) toolbar.classList.remove('content-hidden');
            // 서버 호출 없이 data-images / currentDetailItem.image_ids 로 즉시 렌더링
            var ids = [];
            var idsRaw = '';
            if (typeof activeRow !== 'undefined' && activeRow && activeRow.getAttribute('data-images') != null) {
                idsRaw = activeRow.getAttribute('data-images') || '';
            } else if (currentDetailItem && (currentDetailItem.image_ids != null || currentDetailItem.image_id != null)) {
                idsRaw = currentDetailItem.image_ids != null ? String(currentDetailItem.image_ids) : (currentDetailItem.image_id || '');
            }
            if (idsRaw) ids = idsRaw.split(',').map(function (s) { return s.trim(); }).filter(Boolean);
            if (ids.length) {
                renderInvestigationImagesFromIds(ids);
            } else {
                var listEl = document.getElementById('investigationImageList');
                var placeholderEl = document.getElementById('investigationPlaceholder');
                var footerEl = document.getElementById('investigationImageIdsFooter');
                if (listEl) { listEl.innerHTML = ''; listEl.classList.add('content-hidden'); }
                if (placeholderEl) { placeholderEl.textContent = '등록된 이미지 없음'; placeholderEl.classList.remove('content-hidden'); }
                if (footerEl) footerEl.textContent = '';
            }
            // setupInvestigationDropPaste();
        }

        // [NEW] 옥션원 이동 버튼 가시성 업데이트
        updateAuctionUrlButtonVisibility();
    }

    function loadInvestigationImages() {
        var listEl = document.getElementById('investigationImageList');
        var placeholderEl = document.getElementById('investigationPlaceholder');
        var footerEl = document.getElementById('investigationImageIdsFooter');
        if (!listEl || !placeholderEl) return;
        listEl.innerHTML = '';
        listEl.classList.add('content-hidden');
        placeholderEl.classList.remove('content-hidden');
        placeholderEl.textContent = '이미지 로딩 중...';
        if (!currentDetailItem || !currentDetailItem.id) {
            placeholderEl.textContent = '매칭된 이미지 없음';
            if (footerEl) footerEl.textContent = '';
            return;
        }
        google.script.run
            .withSuccessHandler(function (rows) {
                if (!rows || rows.length === 0) {
                    placeholderEl.textContent = '매칭된 이미지 없음';
                    if (footerEl) footerEl.textContent = '';
                    return;
                }
                placeholderEl.classList.add('content-hidden');
                listEl.classList.remove('content-hidden');
                var ids = rows.map(function (r) { return r.image_id; });
                if (footerEl) footerEl.textContent = 'Image ID: ' + ids.join(', ');
                rows.forEach(function (r) {
                    var wrap = document.createElement('div');
                    wrap.className = 'w-full border border-gray-200 rounded-lg overflow-hidden bg-white';
                    var img = document.createElement('img');
                    img.className = 'investigation-image-max w-full cursor-pointer';
                    img.alt = r.file_name || '이미지';
                    img.dataset.imageId = r.image_id;
                    img.dataset.uploader = r.uploader || '';
                    if (r.image_id) {
                        var thumbUrl = 'https://drive.google.com/thumbnail?sz=w1600&id=' + encodeURIComponent(r.image_id);
                        var originalUrl = 'https://drive.google.com/uc?export=view&id=' + encodeURIComponent(r.image_id);
                        img.src = thumbUrl;
                        img.loading = 'lazy';
                        img.style.cursor = 'pointer';
                        img.onclick = (function (url) { return function () { window.open(url, '_blank'); }; })(originalUrl);
                    }
                    wrap.appendChild(img);
                    // 삭제 버튼: 모든 이미지(system/web)에 표시
                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'mt-2 mx-2 mb-2 text-red-600 hover:text-red-800 text-sm font-medium';
                    btn.textContent = '삭제(X)';
                    btn.onclick = function (ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        handleDeleteItemImage(currentDetailItem.id, r.image_id);
                    };
                    wrap.appendChild(btn);
                    listEl.appendChild(wrap);
                });
            })
            .withFailureHandler(function () {
                placeholderEl.textContent = '이미지를 불러올 수 없습니다.';
                if (footerEl) footerEl.textContent = '';
            })
            .getItemImages(currentDetailItem.id);
    }

    function renderInvestigationImagesFromIds(ids) {
        var listEl = document.getElementById('investigationImageList');
        var placeholderEl = document.getElementById('investigationPlaceholder');
        var footerEl = document.getElementById('investigationImageIdsFooter');
        if (!listEl || !placeholderEl) return;
        listEl.innerHTML = '';
        listEl.classList.add('content-hidden');
        placeholderEl.classList.remove('content-hidden');
        if (!ids || ids.length === 0) {
            placeholderEl.textContent = '등록된 이미지 없음';
            if (footerEl) footerEl.textContent = '';
            return;
        }
        placeholderEl.classList.add('content-hidden');
        listEl.classList.remove('content-hidden');
        if (footerEl) footerEl.textContent = 'Image ID: ' + ids.join(', ');
        ids.forEach(function (id) {
            var wrap = document.createElement('div');
            wrap.className = 'w-full border border-gray-200 rounded-lg overflow-hidden bg-white';
            var img = document.createElement('img');
            img.className = 'investigation-image-max w-full cursor-pointer';
            img.alt = '이미지';
            if (id) {
                var thumbUrl = 'https://drive.google.com/thumbnail?sz=w1600&id=' + encodeURIComponent(id);
                var originalUrl = 'https://drive.google.com/uc?export=view&id=' + encodeURIComponent(id);
                img.src = thumbUrl;
                img.dataset.id = id; // [추가] 복사 시 ID 참조를 위해 저장
                img.loading = 'lazy';
                img.style.cursor = 'pointer';
                img.onclick = (function (url) { return function () { window.open(url, '_blank'); }; })(originalUrl);
            }
            wrap.appendChild(img);
            listEl.appendChild(wrap);
        });
    }

    function openInvestigationTab(element, preferInvestigationTab) {
        var id = element.getAttribute('data-id') || element.dataset.id || '';
        var imageIdsString = element.getAttribute('data-images') || '';
        var item = (typeof allBiddingData !== 'undefined' && allBiddingData)
            ? allBiddingData.find(function (i) { return String(i.id) === String(id); })
            : null;
        if (item && typeof selectItem === 'function') selectItem(element, item);
        var ids = imageIdsString
            ? imageIdsString.split(',').map(function (s) { return s.trim(); }).filter(Boolean)
            : [];
        if (ids.length) {
            renderInvestigationImagesFromIds(ids);
            if (typeof switchItemDetailTab === 'function') switchItemDetailTab(preferInvestigationTab ? 'investigation' : 'detail');
            if (preferInvestigationTab) {
                setTimeout(function () { if (document.activeElement && document.activeElement.blur) document.activeElement.blur(); }, 0);
            }
        } else {
            var listEl = document.getElementById('investigationImageList');
            var placeholderEl = document.getElementById('investigationPlaceholder');
            var footerEl = document.getElementById('investigationImageIdsFooter');
            if (listEl) { listEl.innerHTML = ''; listEl.classList.add('content-hidden'); }
            if (placeholderEl) { placeholderEl.textContent = '등록된 이미지 없음'; placeholderEl.classList.remove('content-hidden'); }
            if (footerEl) footerEl.textContent = '';
            if (typeof switchItemDetailTab === 'function') switchItemDetailTab('detail');
        }
    }

    function setupInvestigationDropPaste() {
        var zone = document.getElementById('investigationDropZone');
        var tab = document.getElementById('itemInvestigationTabContent');
        function onOver(e) { e.preventDefault(); e.stopPropagation(); if (zone) zone.classList.add('border-blue-500', 'bg-blue-50'); }
        function onLeave(e) { e.preventDefault(); if (zone) zone.classList.remove('border-blue-500', 'bg-blue-50'); }
        function onDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            if (zone) zone.classList.remove('border-blue-500', 'bg-blue-50');
            var f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) ? e.dataTransfer.files[0] : null;
            if (f && f.type.indexOf('image/') === 0) uploadInvestigationFile(f);
        }
        if (zone) { zone.ondragover = onOver; zone.ondragleave = onLeave; zone.ondrop = onDrop; }
        if (tab) { tab.ondragover = onOver; tab.ondragleave = onLeave; tab.ondrop = onDrop; }
        document.removeEventListener('keydown', investigationPasteKey);
        document.addEventListener('keydown', investigationPasteKey);
    }
    function investigationPasteKey(e) {
        if (!e.ctrlKey || e.key !== 'v') return;
        var inv = document.getElementById('itemInvestigationTabContent');
        if (!inv || inv.classList.contains('content-hidden')) return;
        setTimeout(function () {
            if (!navigator.clipboard || !navigator.clipboard.read) return;
            navigator.clipboard.read().then(function (items) {
                for (var i = 0; i < items.length; i++) {
                    var t = items[i].types;
                    var mime = t.indexOf('image/png') >= 0 ? 'image/png' : (t.indexOf('image/jpeg') >= 0 ? 'image/jpeg' : (t.indexOf('image/gif') >= 0 ? 'image/gif' : null));
                    if (mime) {
                        items[i].getType(mime).then(function (blob) { uploadInvestigationBlob(blob); });
                        return;
                    }
                }
            }).catch(function () { });
        }, 10);
    }
    function uploadInvestigationFile(file) {
        var r = new FileReader();
        r.onload = function () { uploadInvestigationBlobAsDataUrl(r.result, file.type); };
        r.readAsDataURL(file);
    }
    function uploadInvestigationBlob(blob) {
        var r = new FileReader();
        r.onload = function () { uploadInvestigationBlobAsDataUrl(r.result, blob.type || 'image/png'); };
        r.readAsDataURL(blob);
    }
    function uploadInvestigationBlobAsDataUrl(dataUrl, mimeType) {
        if (!currentDetailItem || !currentDetailItem.id) return;
        if (typeof showStatusMessage === 'function') showStatusMessage('이미지 등록 중...', 'info');
        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.success) {
                    if (typeof showStatusMessage === 'function') showStatusMessage('이미지가 등록되었습니다.', 'success');
                    loadInvestigationImages();
                } else {
                    if (typeof showStatusMessage === 'function') showStatusMessage(res && res.message ? res.message : '등록 실패', 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (typeof showStatusMessage === 'function') showStatusMessage('등록 실패: ' + (err && err.message ? err.message : '오류'), 'error');
            })
            .registerWebImage(
                currentDetailItem.id,
                dataUrl,
                mimeType || 'image/png',
                currentDetailItem.sakun_no || '',
                currentDetailItem['in-date'] || '',
                currentDetailItem.court || ''
            );
    }
    function handleDeleteWebImage(itemId, imageId) {
        if (!itemId || !imageId) return;
        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.success) {
                    if (typeof showStatusMessage === 'function') showStatusMessage('이미지를 삭제했습니다.', 'success');
                    loadInvestigationImages();
                } else {
                    if (typeof showStatusMessage === 'function') showStatusMessage(res && res.message ? res.message : '삭제 실패', 'error');
                }
            })
            .withFailureHandler(function () {
                if (typeof showStatusMessage === 'function') showStatusMessage('삭제에 실패했습니다.', 'error');
            })
            .deleteWebImage(itemId, imageId);
    }

    function handleDeleteItemImage(itemId, imageId) {
        if (!itemId || !imageId) return;
        if (!confirm('이 이미지를 삭제하시겠습니까?\n(구글 드라이브 휴지통으로 이동됩니다)')) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.success) {
                    if (typeof showStatusMessage === 'function') showStatusMessage('이미지를 삭제했습니다.', 'success');
                    loadInvestigationImages();
                } else {
                    if (typeof showStatusMessage === 'function') showStatusMessage(res && res.message ? res.message : '삭제 실패', 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (typeof showStatusMessage === 'function') showStatusMessage('삭제 실패: ' + (err.message || err), 'error');
            })
            .deleteItemImage(itemId, imageId);
    }

    function handleInvestigationImageReg() {
        switchItemDetailTab('investigation');
        if (typeof showStatusMessage === 'function') showStatusMessage('이미지를 영역에 놓거나 Ctrl+V로 붙여넣으세요.', 'info');
    }

    function handleInvestigationDelete() {
        if (!currentDetailItem || !currentDetailItem.id) {
            if (typeof showStatusMessage === 'function') showStatusMessage('물건을 먼저 선택해주세요.', 'error');
            return;
        }

        google.script.run
            .withSuccessHandler(function (images) {
                if (!images || images.length === 0) {
                    if (typeof showStatusMessage === 'function') showStatusMessage('삭제할 이미지가 없습니다.', 'error');
                    return;
                }

                var firstImageId = images[0].image_id;
                if (!confirm('첫 번째 이미지를 삭제하시겠습니까?\n(구글 드라이브 휴지통으로 이동됩니다)')) return;

                handleDeleteItemImage(currentDetailItem.id, firstImageId);
            })
            .withFailureHandler(function (err) {
                if (typeof showStatusMessage === 'function') showStatusMessage('이미지 조회 실패: ' + (err.message || err), 'error');
            })
            .getItemImages(currentDetailItem.id);
    }

    function getFirstInvestigationImageSrc() {
        // 활성 창(모달 또는 상세 Pane)에 따라 이미지 리스트 선택
        const modal = document.getElementById('itemDetailModal');
        const isModalOpen = modal && !modal.classList.contains('content-hidden');
        const listId = isModalOpen ? 'modal-investigation-image-list' : 'investigationImageList';

        var list = document.getElementById(listId);
        if (!list) return null;
        var imgs = list.querySelectorAll('img[src]');
        return imgs.length ? imgs[0].src : null;
    }

    function getFirstInvestigationImageId() {
        // 활성 창(모달 또는 상세 Pane)에 따라 이미지 리스트 선택
        const modal = document.getElementById('itemDetailModal');
        const isModalOpen = modal && !modal.classList.contains('content-hidden');
        const listId = isModalOpen ? 'modal-investigation-image-list' : 'investigationImageList';

        var list = document.getElementById(listId);
        if (!list) return null;
        var imgs = list.querySelectorAll('img[data-id]');
        return imgs.length ? imgs[0].dataset.id : null;
    }

    function handleInvestigationPrint() {
        var inv = document.getElementById('itemInvestigationTabContent');
        var printImg = document.getElementById('printInvestigationImg');
        var wrap = document.getElementById('printInvestigationArea');
        if (!inv || !wrap || !printImg) return;
        var wasHidden = inv.classList.contains('content-hidden');
        if (wasHidden) switchItemDetailTab('investigation');
        function doPrint() {
            var noImgEl = document.getElementById('printInvestigationNoImage');
            var src = getFirstInvestigationImageSrc();
            if (src) {
                printImg.src = src;
                printImg.style.display = 'block';
                if (noImgEl) noImgEl.style.display = 'none';
            } else {
                printImg.src = '';
                printImg.style.display = 'none';
                if (noImgEl) noImgEl.style.display = 'block';
            }
            window.print();
            if (wasHidden) switchItemDetailTab('detail');
        }
        setTimeout(doPrint, wasHidden ? 600 : 100);
    }

    function handleInvestigationCopy() {
        var imageId = getFirstInvestigationImageId();

        if (imageId) {
            showStatus('이미지 데이터를 가져오는 중 (CORS 우회)...', 'warning');

            // 클라이언트측 CORS 이슈를 해결하기 위해 서버측(GAS)에서 이미지를 Base64로 가져옴
            google.script.run.withSuccessHandler(function (base64Data) {
                if (!base64Data) {
                    showStatus('이미지 데이터를 가져오지 못했습니다.', 'error');
                    return;
                }

                showStatus('이미지 변환 및 복사 중...', 'warning');
                var img = new Image();
                img.onload = function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(function (blob) {
                        if (!blob) {
                            showStatus('이미지 변환 실패', 'error');
                            return;
                        }
                        var item = new ClipboardItem({ 'image/png': blob });
                        navigator.clipboard.write([item]).then(function () {
                            showStatus('이미지를 클립보드에 복사했습니다. (PNG)', 'success');
                        }).catch(function (err) {
                            console.error('Clipboard error:', err);
                            showStatus('클립보드 저장 실패', 'error');
                        });
                    }, 'image/png');
                };
                img.onerror = function () {
                    showStatus('이미지 렌더링 실패', 'error');
                };
                img.src = base64Data;
            }).withFailureHandler(function (err) {
                showStatus('서버 오류: ' + err, 'error');
            }).getImageAsBase64(imageId);
            return;
        }

        // 이미지가 없으면 텍스트 복사 등 기존 로직 수행 (필요 시)
        const modal = document.getElementById('itemDetailModal');
        const isModalOpen = modal && !modal.classList.contains('content-hidden');
        const data = isModalOpen ? currentModalItemData : currentDetailItem;

        var text = (data && data.sakun_no)
            ? (data.sakun_no || '') + ' ' + (data.court || '') + ' ' + (data['in-date'] || '')
            : '매칭된 이미지 없음';

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
                showStatus('요약 정보를 클립보드에 복사했습니다.', 'success');
            }).catch(function () {
                showStatus('복사에 실패했습니다.', 'error');
            });
        } else {
            showStatus('복사 기능을 사용할 수 없습니다.', 'error');
        }
    }

    function selectItem(rowElement, data) {
        if (activeRow) {
            activeRow.classList.remove('bg-indigo-100', 'border-indigo-500', 'font-semibold');
        }
        rowElement.classList.add('bg-indigo-100', 'border-indigo-500', 'font-semibold');
        activeRow = rowElement;
        rowElement.dataset.id = data.id;
        showForm('edit', data);
    }

    let currentModalItemData = null;

    function openDetailModal(data) {
        currentModalItemData = data;
        ensureCourtListLoaded();
        ensureMemberListLoaded();

        if (modalFormId) modalFormId.value = data.id;
        if (modalFormInDate) modalFormInDate.value = data['in-date'] || '';
        if (modalFormSakunNo) modalFormSakunNo.value = data.sakun_no || '';
        if (modalFormCourt) modalFormCourt.value = data.court || '';
        if (modalFormStuMember) modalFormStuMember.value = data.stu_member || '미정';
        if (modalFormMemberId) modalFormMemberId.value = data.member_id || '';
        // [수정] items 시트의 m_name 우선순위 적용 (없을 경우에만 회원 DB 참조)
        if (modalFormMName) {
            const mem = data.member_id ? getMemberById_(data.member_id) : null;
            const base = (data.m_name && String(data.m_name).trim()) ? data.m_name : (mem ? getMemberName_(mem) : '');
            const alias = String(data.m_name2 || '').trim();
            // 명의 중복 방지: base에 alias가 이미 포함되어 있으면 alias를 붙이지 않음
            modalFormMName.value = (alias && !base.includes(alias)) ? `${base} ${alias}` : base;
        }



        if (modalFormImageId) modalFormImageId.value = data.image_id || '';

        // 메타데이터 정보 표시 (이미지 ID, 수정날짜, 등록자, 등록일자)
        const modalImageIdDisplay = document.getElementById('modal-image-id-display');
        const modalModDate = document.getElementById('modal-mod-date');
        const modalRegMemberDisplay = document.getElementById('modal-reg-member');
        const modalRegDateDisplay = document.getElementById('modal-reg-date');

        if (modalImageIdDisplay) modalImageIdDisplay.textContent = data.image_id || '-';
        if (modalModDate) modalModDate.textContent = data.mod_date || '-';
        if (modalRegMemberDisplay) modalRegMemberDisplay.textContent = data.reg_member || '-';
        if (modalRegDateDisplay) modalRegDateDisplay.textContent = data.reg_date || '-';

        // 회원 부가정보(명의/토큰/텔레그램) 표기 갱신
        try { updateMemberTokenInfo('modal'); } catch (e) { }

        const modalRegMember = document.getElementById('modal-form-reg-member');
        if (modalRegMember) modalRegMember.value = data.reg_member || '';

        const modalDisplayMemberId = document.getElementById('modal-display-member-id');
        if (modalDisplayMemberId) {
            if (data.member_id) {
                let displayId = data.member_id;
                if (displayId === 'b69b381b-0f36-429d-a110-876c5c2d7598') {
                    displayId = '이정우';
                }
                const regDate = data.reg_date ? data.reg_date : '';
                modalDisplayMemberId.textContent = `(${regDate}, ${displayId})`;
            } else {
                modalDisplayMemberId.textContent = '';
            }
        }

        if (modalFormMNameId) modalFormMNameId.value = data.m_name_id || '대표님';
        const price = data.bidprice;
        if (modalFormBidPrice) modalFormBidPrice.value = (price == 0 || price === '0') ? '' : new Intl.NumberFormat('ko-KR').format(price);

        const savedBidState = data.bid_state || '';
        setBidState(savedBidState);

        const templateContainer = document.getElementById('template-area-container');
        if (templateContainer) templateContainer.classList.add('hidden');

        switchTemplateTab('guide', false);

        // 기본적으로 상세 탭 표시
        switchModalTab('detail');

        // 회원 전용 링크: 상세는 "조회 전용"으로 잠금
        if (IS_MEMBER_VIEW) {
            try {
                // 상단 버튼 툴바 전체 숨김 (X 버튼 제외)
                const modalDeleteBtn = document.querySelector('#itemDetailModal button[onclick*="handleModalDelete"]');
                const modalUpdateBtn = document.getElementById('modal-update-btn');
                const modalCancelBtn = document.querySelector('#itemDetailModal button[onclick*="closeDetailModal()"]'); // 텍스트 "취소" 버튼
                const tgToolbar = document.getElementById('modal-telegram-toolbar');

                if (modalDeleteBtn) modalDeleteBtn.classList.add('content-hidden');
                if (modalUpdateBtn) modalUpdateBtn.classList.add('content-hidden');
                if (modalCancelBtn) modalCancelBtn.classList.add('content-hidden');
                if (tgToolbar) tgToolbar.classList.add('content-hidden');

                // 상세 탭 내부 섹션 숨김 (텔레그램 정보, 메타데이터, 템플릿, 입찰상태 버튼)
                const hideIds = [
                    'modal-detail-telegram-section',
                    'modal-detail-metadata-section',
                    'modal-detail-template-section',
                    'modal-bid-state-buttons'
                ];
                hideIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('content-hidden');
                });

                // 입력 비활성화
                Array.from(document.querySelectorAll('#modalForm input, #modalForm select, #modalForm textarea')).forEach(el => {
                    if (!el) return;
                    el.setAttribute('disabled', 'disabled');
                    // 글씨색을 조금 더 진하게 (disabled 시 너무 연해지는 것 방지)
                    el.style.color = '#374151';
                });
            } catch (e) { }
        }

        if (itemDetailModal) itemDetailModal.classList.remove('content-hidden');
    }

    function switchTemplateTab(type, showContent = true) {
        const guideTab = document.getElementById('tab-bid-guide');
        const checkTab = document.getElementById('tab-bid-check');
        const templateContainer = document.getElementById('template-area-container');

        const activeClass = ['text-indigo-700', 'border-indigo-700', 'bg-indigo-50', 'font-bold'];
        const inactiveClass = ['text-gray-500', 'border-transparent', 'hover:text-indigo-600', 'hover:bg-gray-50', 'font-medium'];

        if (type === 'guide') {
            if (guideTab) {
                guideTab.classList.add(...activeClass);
                guideTab.classList.remove(...inactiveClass);
            }
            if (checkTab) {
                checkTab.classList.add(...inactiveClass);
                checkTab.classList.remove(...activeClass);
            }
            updateMessageTemplate('guide');
        } else if (type === 'check') {
            if (checkTab) {
                checkTab.classList.add(...activeClass);
                checkTab.classList.remove(...inactiveClass);
            }
            if (guideTab) {
                guideTab.classList.add(...inactiveClass);
                guideTab.classList.remove(...activeClass);
            }
            updateMessageTemplate('check');
        }

        if (showContent && templateContainer && templateContainer.classList.contains('hidden')) {
            templateContainer.classList.remove('hidden');
        }
    }

    function updateMessageTemplate(type) {
        const textarea = document.getElementById('template-textarea');
        if (!textarea || !currentModalItemData) return;

        const data = currentModalItemData;
        const price = data.bidprice;

        let dateStr = String(data['in-date'] || '').trim();
        let formattedDate = dateStr;
        if (dateStr.length === 6) {
            formattedDate = `20${dateStr.substring(0, 2)}년 ${dateStr.substring(2, 4)}월 ${dateStr.substring(4, 6)}일`;
        }

        let formattedPrice = (price == 0 || price === '0') ? '0' : new Intl.NumberFormat('ko-KR').format(price);

        let templateContent = '';

        if (type === 'guide') {
            templateContent = `안녕하세요 엠제이경매스쿨입니다.    
입찰가 전달드립니다.      
   
회 원 명:    ${data.m_name || ''}
입찰일자:   ${formattedDate}
사건번호:   ${data.sakun_no || ''}
법     원:   ${data.court || ''}
   
입 찰 가:    ${formattedPrice}원
   
확인 부탁 드립니다.    
감사합니다.    
   


* 참고사항
서울/수도권(경기,인천) 입찰하시는 분은 1주택자만 대출이가능합니다!!

앞으로 원할한 소통을 위해 제 번호 연락처 등록 요청 드립니다.    
향후 카카오톡으로 전달 드리겠습니다.    
카카오톡으로 받으시는 분께서는 신경안쓰셔도 됩니다~   
   
MJ 이정우 팀장
 
======================
*업무별 담당자 안내 드립니다.    
1. 입찰가 관리: 이정우    
2. 단기투자클럽 관리: 이경미님 (010-3448-8035)    
3. PT 관리: 장정아님 (010-9838-8035)  
======================`;

        } else if (type === 'check') {
            templateContent = `안녕하세요? 
입찰여부 확인 및 회신 부탁드립니다. 

회 원 명:    ${data.m_name || ''}
입찰일자:   ${formattedDate}
사건번호:   ${data.sakun_no || ''}
법     원:   ${data.court || ''}

감사합니다.`;
        }

        textarea.value = templateContent;
    }

    function setBidState(state) {
        const bidInput = document.getElementById('modal-form-bidprice');
        const hiddenInput = document.getElementById('modal-form-bid-state');
        const btnNew = document.getElementById('modal-bid-state-new-btn');
        const btnDelivered = document.getElementById('modal-bid-state-delivered-btn');

        if (hiddenInput) hiddenInput.value = state;

        // 버튼 스타일 초기화
        if (btnNew) {
            btnNew.classList.remove('bg-red-500', 'text-white', 'font-bold');
            btnNew.classList.add('bg-red-100', 'text-red-700');
        }
        if (btnDelivered) {
            btnDelivered.classList.remove('bg-blue-500', 'text-white', 'font-bold');
            btnDelivered.classList.add('bg-gray-100', 'text-gray-700');
        }

        // 선택된 버튼 스타일 적용
        if (state === '신규') {
            if (btnNew) {
                btnNew.classList.remove('bg-red-100', 'text-red-700');
                btnNew.classList.add('bg-red-500', 'text-white', 'font-bold');
            }
            if (bidInput) {
                bidInput.classList.remove('text-gray-700');
                bidInput.classList.add('text-red-600');
            }
        } else if (state === '전달완료') {
            if (btnDelivered) {
                btnDelivered.classList.remove('bg-gray-100', 'text-gray-700');
                btnDelivered.classList.add('bg-blue-500', 'text-white', 'font-bold');
            }
            if (bidInput) {
                bidInput.classList.remove('text-red-600');
                bidInput.classList.add('text-gray-700');
            }
        } else {
            if (bidInput) {
                bidInput.classList.remove('text-gray-700');
                bidInput.classList.add('text-red-600');
            }
        }
    }

    function openDetailModalById(id) {
        const item = allBiddingData.find(i => String(i.id) === String(id));
        if (item) {
            openDetailModal(item);
        } else {
            showStatus("데이터를 찾을 수 없습니다.", "error");
        }
    }

    function closeDetailModal(event) {
        if (!itemDetailModal) return;
        if (!event || event.target === itemDetailModal) {
            itemDetailModal.classList.add('content-hidden');
        }
    }

    function toggleTemplateArea() {
        const container = document.getElementById('template-area-container');
        if (container) {
            container.classList.toggle('hidden');
        }
    }

    function copyTemplateText() {
        const textarea = document.getElementById('template-textarea');
        if (!textarea) return;

        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showStatus('내용이 클립보드에 복사되었습니다.', 'success');
                }).catch(err => {
                    showStatus('복사 실패 (권한 확인 필요)', 'error');
                });
            } else {
                const wasHidden = textarea.parentElement.classList.contains('hidden');
                if (wasHidden) textarea.parentElement.classList.remove('hidden');

                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');

                if (wasHidden) textarea.parentElement.classList.add('hidden');
                showStatus('내용이 클립보드에 복사되었습니다.', 'success');
            }
        } catch (err) {
            showStatus('복사 중 오류 발생: ' + err, 'error');
        }
    }

    // --- [Telegram] 물건 1건 텔레그램 전송 (관리자) ---
    function sendTelegramForCurrentItem() {
        if (!currentModalItemData) {
            showStatus('전송할 물건 정보를 찾을 수 없습니다.', 'error');
            return;
        }
        const memberId = currentModalItemData.member_id;
        const itemId = currentModalItemData.id;
        const styleEl = document.getElementById('telegram-style-select');
        const styleKey = styleEl ? String(styleEl.value || '').trim() : 'card';
        if (!memberId) {
            showStatus('이 물건에 member_id(회원)가 지정되어 있지 않습니다.', 'error');
            return;
        }
        showStatus('텔레그램 전송 중...', 'warning');
        google.script.run
            .withSuccessHandler(result => {
                if (result && result.success) {
                    showStatus(result.message || '텔레그램 전송 완료', 'success');
                } else {
                    showStatus((result && result.message) ? result.message : '텔레그램 전송 실패', 'error');
                }
            })
            .withFailureHandler(error => {
                showStatus(`텔레그램 전송 오류: ${error.message}`, 'error');
            })
            .sendItemToMemberTelegramWithStyle(memberId, itemId, styleKey);
    }

    function handleDetailTelegramSend() {
        const memberId = document.getElementById('form-member-id').value;
        const itemId = document.getElementById('formId').value;
        confirmAndSendTelegramForItem_(memberId, itemId);
    }

    // --- [2] 데이터 CRUD 처리 (서버 통신) ---

    function checkDuplicate(inDate, sakunNo, court, excludeId = null) {
        return allBiddingData.some(item => {
            if (excludeId && String(item.id) === String(excludeId)) return false;

            return String(item['in-date']) === String(inDate) &&
                String(item.sakun_no).trim() === String(sakunNo).trim() &&
                String(item.court).trim() === String(court).trim();
        });
    }

    function handleModalUpdate() {
        if (!modalFormId || !modalFormInDate || !modalFormSakunNo || !modalFormCourt) {
            showStatus('필수 입력 항목을 확인해 주세요.', 'error');
            return;
        }

        const id = modalFormId.value;
        const inDate = modalFormInDate.value;
        const sakunNo = modalFormSakunNo.value;
        const court = modalFormCourt.value;
        const stuMember = modalFormStuMember ? modalFormStuMember.value : '';
        const mName = getBaseMemberNameForSave_('modal');
        const mName2 = getMemberName2ForSave_('modal');
        const memberId = modalFormMemberId ? modalFormMemberId.value : '';
        const mNameId = modalFormMNameId ? modalFormMNameId.value : '';
        const bidPriceRaw = modalFormBidPrice ? modalFormBidPrice.value.replace(/[^0-9]/g, '') : '0';

        // [회원명 검증]
        const cleanMName = String(mName || '').split(' ')[0].split('(')[0].trim();
        const memberList = (typeof allMembersNewData !== 'undefined' && allMembersNewData.length > 0) ? allMembersNewData : (allMemberData || []);
        const isValidMember = memberList && memberList.some(m => String(m.member_name || m.name || '').trim() === cleanMName);
        if (!isValidMember) {
            showStatus('등록된 회원이 아닙니다.', 'error');
            if (modalFormMName) modalFormMName.focus();
            return;
        }
        const bidPrice = bidPriceRaw === '' ? '0' : bidPriceRaw;
        const bidState = document.getElementById('modal-form-bid-state') ? document.getElementById('modal-form-bid-state').value : '';
        const imageId = modalFormImageId ? modalFormImageId.value : '';

        if (!inDate || !sakunNo || !court) {
            showStatus('필수 입력 항목(입찰일자, 사건번호, 법원명)을 확인해 주세요.', 'error');
            return;
        }
        if (inDate.length !== 6 || !/^\d{6}$/.test(inDate)) {
            showStatus('입찰일자는 6자리 (YYMMDD) 형식이어야 합니다.', 'error');
            return;
        }
        var courtTrimModal = (court || '').trim();
        if (courtListCache && courtListCache.indexOf(courtTrimModal) === -1) {
            showStatus('등록된 법원만 선택할 수 있습니다.', 'error');
            if (modalFormCourt) modalFormCourt.focus();
            return;
        }

        if (checkDuplicate(inDate, sakunNo, court, id)) {
            showStatus('이미 등록된 물건입니다. (입찰일자, 사건번호, 법원명 중복)', 'error');
            return;
        }

        showStatus('수정 내용을 저장 중...', 'warning');

        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    dataCache = { data: null, timestamp: 0 };
                    closeDetailModal();
                    // forceRefresh = true를 전달하여 서버에서 최신 데이터를 가져오도록 함
                    loadDataAndRenderCalendar(true);
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(error => {
                showStatus(`수정 오류: ${error.message}`, 'error');
            })
            .updateData(id, inDate, sakunNo, court, stuMember, mNameId, mName, bidPrice, memberId, bidState, imageId, '', mName2);
    }

    function handleModalDelete() {
        if (!modalFormId) return;
        const id = modalFormId.value;
        if (!confirm(`정말로 이 물건을 삭제하시겠습니까?`)) {
            return;
        }
        showStatus('삭제 중...', 'warning');
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    dataCache = { data: null, timestamp: 0 };
                    closeDetailModal();
                    // forceRefresh = true를 전달하여 서버에서 최신 데이터를 가져오도록 함
                    loadDataAndRenderCalendar(true);
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(error => {
                showStatus(`삭제 오류: ${error.message}`, 'error');
            })
            .deleteData(id);
    }

    function handleFormSubmit() {
        if (!dataForm || !dataForm.reportValidity()) {
            showStatus('필수 입력 항목을 확인해 주세요.', 'error');
            return;
        }
        if (!formId || !formInDate || !formSakunNo || !formCourt) {
            showStatus('필수 입력 항목을 확인해 주세요.', 'error');
            return;
        }

        const id = formId.value;
        const inDate = formInDate.value;
        const sakunNo = formSakunNo.value;
        const court = formCourt.value;
        const stuMember = formStuMember ? formStuMember.value : '';
        const mName = getBaseMemberNameForSave_('main');
        const mName2 = getMemberName2ForSave_('main');
        const memberId = formMemberId ? formMemberId.value : '';
        const mNameId = formMNameId ? formMNameId.value : '';
        let rawBidPrice = formBidPrice ? formBidPrice.value.replace(/[^0-9]/g, '') : '0';

        // [회원명 검증]
        const cleanMName = String(mName || '').split(' ')[0].split('(')[0].trim();
        const memberList = (typeof allMembersNewData !== 'undefined' && allMembersNewData.length > 0) ? allMembersNewData : (allMemberData || []);
        const isValidMember = memberList && memberList.some(m => String(m.member_name || m.name || '').trim() === cleanMName);
        if (!isValidMember) {
            showStatus('등록된 회원이 아닙니다.', 'error');
            if (formMName) formMName.focus();
            return;
        }
        const bidPrice = rawBidPrice === '' ? '0' : rawBidPrice;
        const imageId = formImageId ? formImageId.value : '';
        const note = formNote ? formNote.value : '';

        let processedInDate = inDate.trim();


        if (processedInDate.length === 4 && /^\d{4}$/.test(processedInDate)) {
            const currentYear = new Date().getFullYear().toString().slice(-2);
            processedInDate = currentYear + processedInDate;
        }
        if (processedInDate.length !== 6 || !/^\d{6}$/.test(processedInDate)) {
            showStatus('입찰일자는 6자리 (YYMMDD) 형식이어야 합니다.', 'error');
            if (formInDate) formInDate.focus();
            return;
        }
        var courtTrim = (court || '').trim();
        if (courtListCache && courtListCache.indexOf(courtTrim) === -1) {
            showStatus('등록된 법원만 선택할 수 있습니다.', 'error');
            if (formCourt) formCourt.focus();
            return;
        }

        if (checkDuplicate(processedInDate, sakunNo, court, currentMode === 'edit' ? id : null)) {
            showStatus('이미 등록된 물건입니다. (입찰일자, 사건번호, 법원명 중복)', 'error');
            return;
        }

        let bidState = document.getElementById('form-bid-state') ? document.getElementById('form-bid-state').value : '';

        if (currentMode === 'create' && bidPrice !== '0') {
            bidState = '신규';
        }

        toggleLoading(true);
        const successHandler = (result) => {
            if (result.success) {
                showStatus(result.message, 'success');
                dataCache = { data: null, timestamp: 0 };
                loadData(true);
                if (currentMode === 'create') {
                    if (formSakunNo) formSakunNo.value = '';
                    if (formBidPrice) formBidPrice.value = '';
                    if (formInDate) formInDate.focus();
                    const bidStateEl = document.getElementById('form-bid-state');
                    if (bidStateEl) bidStateEl.value = '';
                } else {
                    goToCreateMode();
                }
            } else {
                showStatus(result.message, 'error');
                loadData();
                toggleLoading(false);
                if (formInDate) formInDate.focus();
            }
        };
        const errorHandler = (error) => {
            toggleLoading(false);
            showStatus(`작업 처리 중 오류: ${error.message}`, 'error');
        };

        const dataArgs = [processedInDate, sakunNo, court, stuMember, mNameId, mName, bidPrice, memberId, bidState, imageId, note, mName2];
        if (currentMode === 'create') {
            google.script.run.withSuccessHandler(successHandler).withFailureHandler(errorHandler).createData(...dataArgs);
        } else if (currentMode === 'edit') {
            google.script.run.withSuccessHandler(successHandler).withFailureHandler(errorHandler).updateData(id, ...dataArgs);
        }
    }

    function handleDelete(id) {
        if (!id) {
            showStatus('삭제할 항목을 먼저 선택해 주세요.', 'error');
            return;
        }
        if (!confirm(`정말로 ID ${id}의 입찰 정보를 삭제하시겠습니까?`)) {
            return;
        }
        toggleLoading(true);
        google.script.run
            .withSuccessHandler((result) => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    dataCache = { data: null, timestamp: 0 };
                    goToCreateMode();
                    loadData(true);
                } else {
                    showStatus(result.message, 'error');
                    toggleLoading(false);
                }
            })
            .withFailureHandler(error => {
                toggleLoading(false);
                showStatus(`삭제 처리 중 오류: ${error.message}`, 'error');
            })
            .deleteData(id);
    }

    // --- [3] 데이터 로드 (Read) ---

    function loadData(forceRefresh = false) {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            if (dataTableBody) {
                dataTableBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500 font-bold">⚠️ 오류: 이 코드는 구글 앱스 스크립트 환경이 아닙니다.</td></tr>`;
            }
            return;
        }

        // 캐시 확인 (회원 전용 링크에서는 캐시 재사용 금지)
        const now = Date.now();
        if (!IS_MEMBER_VIEW && !forceRefresh && dataCache.data && (now - dataCache.timestamp) < CACHE_DURATION) {
            allBiddingData = dataCache.data;
            applyFilters();
            return;
        }

        toggleLoading(true);
        const runner = google.script.run
            .withSuccessHandler(data => {
                data.sort(dataComparator);
                allBiddingData = data;
                dataCache = { data: allBiddingData, timestamp: Date.now() };
                applyFilters();
                if (typeof renderMemberDashboardSummary === 'function') renderMemberDashboardSummary(); // [추가] 초기 대시보드 요약 갱신
                toggleLoading(false);
            })
            .withFailureHandler(error => {
                toggleLoading(false);
                showStatus(`데이터 로드 실패: ${error.message}`, 'error');
                if (dataTableBody) {
                    dataTableBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">데이터 로드 중 오류가 발생했습니다.</td></tr>`;
                }
            });

        // 회원 전용 링크에서는 서버에서 토큰 기준으로 본인 데이터만 가져오기
        if (IS_MEMBER_VIEW) {
            runner.readDataWithImageIdsByMemberToken(APP_CTX.token);
        } else {
            runner.readAllDataWithImageIds();
        }
    }

    function loadDataAndRenderCalendar(forceRefresh = false) {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            showStatus('Google Apps Script 환경이 아닙니다.', 'error');
            return;
        }
        // 데이터 캐싱: 회원 전용 링크에서는 항상 서버에서 토큰 기반으로 재로딩
        if (!IS_MEMBER_VIEW && !forceRefresh && allBiddingData && allBiddingData.length > 0) {
            updateDashboardFilterOptions();
            renderCalendar();
            return;
        }
        toggleCalendarLoading(true);
        const runner = google.script.run
            .withSuccessHandler(data => {
                allBiddingData = data.sort(dataComparator);
                dataCache = { data: allBiddingData, timestamp: Date.now() };
                updateDashboardFilterOptions();
                renderCalendar();
                if (typeof renderMemberDashboardSummary === 'function') renderMemberDashboardSummary(); // [추가] 초기 대시보드 요약 갱신
            })
            .withFailureHandler(error => {
                toggleCalendarLoading(false);
                showStatus(`[일정 로드 오류]: ${error.message}.`, 'error');
            });

        if (IS_MEMBER_VIEW) {
            runner.readDataWithImageIdsByMemberToken(APP_CTX.token);
        } else {
            runner.readAllDataWithImageIds();
        }
    }

    function loadDataAndRenderDashboard(forceRefresh = false) {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            showStatus('Google Apps Script 환경이 아닙니다.', 'error');
            return;
        }

        // ★ 텔레그램 요청 목록은 대시보드 데이터 로드와 독립적으로 항상 로드
        // (readAllDataWithImageIds 실패 시에도 요청 목록은 표시되어야 함)
        if (!IS_MEMBER_VIEW) {
            try { loadTelegramRequests(); } catch (e) { console.error('[TG-REQ] 독립 로드 실패:', e); }
            try { startTelegramRequestsPolling_(); } catch (e) { }
        }

        // 데이터 캐싱: 회원 전용 링크에서는 대시보드 사용 안 함 (혹시 호출되면 재사용 금지)
        if (!IS_MEMBER_VIEW && !forceRefresh && allBiddingData && allBiddingData.length > 0) {
            updateDashboardFilterOptions();
            renderMissingBidDashboard();
            renderStatusManagementDashboard();
            renderMemberBidChart();
            return;
        }
        toggleDashboardLoading(true);
        const runner = google.script.run
            .withSuccessHandler(data => {
                allBiddingData = data.sort(dataComparator);
                dataCache = { data: allBiddingData, timestamp: Date.now() };
                updateDashboardFilterOptions();
                renderMissingBidDashboard();
                renderStatusManagementDashboard();
                renderMemberBidChart();
                if (typeof renderMemberDashboardSummary === 'function') renderMemberDashboardSummary(); // [추가] 초기 대시보드 요약 갱신
            })
            .withFailureHandler(error => {
                toggleDashboardLoading(false);
                showStatus(`[대시보드 로드 오류]: ${error.message}.`, 'error');
            });

        if (IS_MEMBER_VIEW) {
            // 회원 링크에서는 대시보드항목은 표시하지 않지만, 데이터는 가져옴
            runner.readDataWithImageIdsByMemberToken(APP_CTX.token);
        } else {
            runner.readAllDataWithImageIds();
        }
    }

    /**
     * 회원 대시보드 전용 데이터 로드 및 렌더링
     */
    function loadDataAndRenderMemberDashboard(forceRefresh = false) {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            return;
        }

        // 캐시 확인
        const now = Date.now();
        if (!forceRefresh && allBiddingData && allBiddingData.length > 0 && (now - dataCache.timestamp) < CACHE_DURATION) {
            navigateTo('MemberDashboard');
            renderMemberDashboard();
            return;
        }

        // 회원 전용 모드일 때만 로딩 바 표시 (필요시)
        if (IS_MEMBER_VIEW) {
            // 캘린더 로딩 표시 재활용
            const grid = document.getElementById('memberDashCalGrid');
            if (grid) grid.innerHTML = '<div class="col-span-12 py-10 text-center text-gray-400">데이터를 불러오는 중...</div>';
        }

        google.script.run
            .withSuccessHandler(data => {
                allBiddingData = data.sort(dataComparator);
                dataCache = { data: allBiddingData, timestamp: Date.now() };
                navigateTo('MemberDashboard');
                renderMemberDashboard();
            })
            .withFailureHandler(error => {
                console.error('Member dashboard loading error:', error);
                showStatus('데이터 로드에 실패했습니다.', 'error');
                navigateTo('MemberDashboard');
            })
            .readDataWithImageIdsByMemberToken(APP_CTX.token);
    }

    // --- [Telegram] 양방향 요청(승인 필요) UI ---
    let telegramRequestCache_ = [];
    let telegramRequestsPoller_ = null;

    function startTelegramRequestsPolling_() {
        if (IS_MEMBER_VIEW) return;
        if (telegramRequestsPoller_) return;
        telegramRequestsPoller_ = setInterval(() => {
            const dash = document.getElementById('Dashboard');
            if (!dash || dash.classList.contains('content-hidden')) return;
            try { loadTelegramRequests(true); } catch (e) { } // ★ 배경에서 조용히 갱신
        }, 15000); // ★ 5초 -> 15초로 완화
    }

    function stopTelegramRequestsPolling_() {
        if (telegramRequestsPoller_) {
            clearInterval(telegramRequestsPoller_);
            telegramRequestsPoller_ = null;
        }
    }

    function toggleAllTelegramRequestCheckboxes(headerCb) {
        const tb = document.getElementById('tg-req-tbody');
        if (!tb) return;
        tb.querySelectorAll('input.tg-req-cb').forEach(cb => { cb.checked = !!headerCb.checked; });
    }

    function getSelectedTelegramRequestIds_() {
        const tb = document.getElementById('tg-req-tbody');
        if (!tb) return [];
        const cbs = tb.querySelectorAll('input.tg-req-cb:checked');
        return Array.from(cbs).map(cb => String(cb.value || '').trim()).filter(Boolean);
    }

    function renderTelegramRequests_(rows) {
        const tb = document.getElementById('tg-req-tbody');
        if (!tb) return;
        telegramRequestCache_ = Array.isArray(rows) ? rows : [];
        if (!telegramRequestCache_.length) {
            tb.innerHTML = `<tr><td colspan="8" class="py-4 text-center text-gray-500">승인 대기 요청이 없습니다.</td></tr>`;
            const all = document.getElementById('tg-req-checkall');
            if (all) all.checked = false;
            return;
        }

        // 기존 체크된 ID 저장 (갱신 후 유지용)
        const checkedIds = getSelectedTelegramRequestIds_();

        tb.innerHTML = telegramRequestCache_.map(r => {
            const a = String(r.action || '').trim();
            const actionLabel = (a === 'REQUEST_BID')
                ? '입찰확정 요청'
                : (a === 'REQUEST_CANCEL')
                    ? '입찰취소 요청'
                    : (r.action || '');
            const isChecked = checkedIds.includes(String(r.req_id));
            return `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="py-2 px-2 text-center"><input type="checkbox" class="tg-req-cb rounded" value="${String(r.req_id || '').replace(/"/g, '&quot;')}" ${isChecked ? 'checked' : ''}></td>
              <td class="py-2 px-2 text-left whitespace-nowrap">${r.requested_at || ''}</td>
              <td class="py-2 px-2 text-left">${(r.m_name || '')}</td>
              <td class="py-2 px-2 text-left">${(r.sakun_no || '')}</td>
              <td class="py-2 px-2 text-left">${(r.court || '')}</td>
              <td class="py-2 px-2 text-center">${(r.in_date || '')}</td>
              <td class="py-2 px-2 text-center">${(r.stu_member || '')}</td>
              <td class="py-2 px-2 text-left">${actionLabel}</td>
            </tr>
          `;
        }).join('');
        const all = document.getElementById('tg-req-checkall');
        if (all && !checkedIds.length) all.checked = false;
    }

    function loadTelegramRequests(isSilent) {
        if (IS_MEMBER_VIEW) return;
        const panel = document.getElementById('telegram-requests-panel');
        const tb = document.getElementById('tg-req-tbody');
        if (!panel || !tb) return;
        if (typeof google === 'undefined' || !google.script || !google.script.run) return;

        // ★ Silent 모드가 아닐 때만 "로딩 중" 표시
        if (!isSilent) {
            tb.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-gray-500">요청을 불러오는 중...</td></tr>';
        }

        var startTime = Date.now();
        google.script.run
            .withSuccessHandler(function (rows) {
                // 조용히 데이터만 갱신
                renderTelegramRequests_(rows);
            })
            .withFailureHandler(function (err) {
                if (!isSilent) {
                    tb.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-red-600">요청 로드 오류: ' + (err && err.message ? err.message : String(err)) + '</td></tr>';
                }
            })
            .listTelegramRequests('PENDING');
    }

    function approveSelectedTelegramRequests() {
        const ids = getSelectedTelegramRequestIds_();
        if (!ids.length) { showStatus('승인할 요청을 선택해 주세요.', 'error'); return; }
        showConfirmInStatus_(`선택한 ${ids.length}건을 승인할까요?`, () => {
            showStatus('승인 처리 중...', 'warning');
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.success) {
                        showStatus(res.message || '승인 완료', 'success');
                        // 데이터 갱신 (캘린더/대시보드)
                        try { loadDataAndRenderCalendar(true); } catch (e) { }
                        try { loadDataAndRenderDashboard(true); } catch (e) { }
                        loadTelegramRequests();
                    } else {
                        showStatus((res && res.message) ? res.message : '승인 실패', 'error');
                    }
                })
                .withFailureHandler(err => showStatus('승인 오류: ' + err.message, 'error'))
                .approveTelegramRequests(ids, 'admin');
        }, () => { });
    }

    function rejectSelectedTelegramRequests() {
        const ids = getSelectedTelegramRequestIds_();
        if (!ids.length) { showStatus('거절할 요청을 선택해 주세요.', 'error'); return; }
        showConfirmInStatus_(`선택한 ${ids.length}건을 거절할까요?`, () => {
            showStatus('거절 처리 중...', 'warning');
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.success) {
                        showStatus(res.message || '거절 완료', 'success');
                        loadTelegramRequests();
                    } else {
                        showStatus((res && res.message) ? res.message : '거절 실패', 'error');
                    }
                })
                .withFailureHandler(err => showStatus('거절 오류: ' + err.message, 'error'))
                .rejectTelegramRequests(ids, 'admin');
        }, () => { });
    }

    function getSelectedStatusValues() {
        const cbs = document.querySelectorAll('input[name="search-status-cb"]:checked');
        return Array.from(cbs).map(el => el.value);
    }
    function toggleStatusDropdown(ev) {
        ev.stopPropagation();
        const dd = document.getElementById('search-status-dropdown');
        const btn = document.getElementById('search-status-btn');
        if (!dd || !btn) return;
        const isHidden = dd.classList.contains('content-hidden');
        dd.classList.toggle('content-hidden', !isHidden);
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        if (isHidden) {
            document.addEventListener('click', closeStatusDropdownOnce);
        }
    }
    function closeStatusDropdownOnce() {
        const dd = document.getElementById('search-status-dropdown');
        if (dd) dd.classList.add('content-hidden');
        const btn = document.getElementById('search-status-btn');
        if (btn) btn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', closeStatusDropdownOnce);
        updateStatusLabel();
    }

    function updateStatusLabel() {
        const allCb = document.getElementById('search-status-all');
        const isAllStatus = (allCb && allCb.checked);
        const selected = getSelectedStatusValues();
        const statusLabel = document.getElementById('search-status-label');
        if (statusLabel) {
            if (isAllStatus) {
                statusLabel.textContent = '전체';
            } else if (selected.length === 0) {
                statusLabel.textContent = '미선택';
            } else {
                statusLabel.textContent = selected.join(',');
            }
        }
    }

    // 상태 체크박스 변경 시 라벨 업데이트
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            document.querySelectorAll('input[name="search-status-cb"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    updateStatusLabel();
                });
            });
            // 초기 로드 시 "전체" 라벨 표시
            updateStatusLabel();
        }, 100);
    });

    // --- [4] 필터링 로직 ---
    function handleStatusAll(allCb) {
        if (allCb.checked) {
            const cbs = document.querySelectorAll('input[name="search-status-cb"]');
            cbs.forEach(cb => cb.checked = false);
        } else {
            // "전체"를 해제하면? (보통 전체 해제 시 아무것도 안 선택된 상태가 됨 -> applyFilters에서 처리)
        }
    }

    function handleStatusOther(otherCb) {
        if (otherCb.checked) {
            const allCb = document.getElementById('search-status-all');
            if (allCb) allCb.checked = false;
        }
    }

    // --- [4] 필터링 로직 ---
    function applyFilters() {
        const currentFocusId = document.activeElement ? document.activeElement.id : '';
        const termIndate = (searchIndateInput && searchIndateInput.value) ? searchIndateInput.value.trim() : '';
        const termSakunNo = (searchSakunNoInput && searchSakunNoInput.value) ? searchSakunNoInput.value.toLowerCase().trim() : '';
        const termCourt = (searchCourtInput && searchCourtInput.value) ? searchCourtInput.value.toLowerCase().trim() : '';
        const selectedStatuses = getSelectedStatusValues();
        const allStatusCb = document.getElementById('search-status-all');
        const isAllStatus = (allStatusCb && allStatusCb.checked);
        const termRegDate = (searchRegDateInput && searchRegDateInput.value) ? searchRegDateInput.value.trim() : '';
        const termManager = (searchManagerInput && searchManagerInput.value) ? String(searchManagerInput.value).trim() : '';
        const termMName = (searchMNameInput && searchMNameInput.value) ? searchMNameInput.value.toLowerCase().trim() : '';

        // 입력값 유무에 따라 실시간 강조 스타일 적용
        if (searchIndateInput) searchIndateInput.classList.toggle('filter-active-input', !!termIndate);
        if (searchSakunNoInput) searchSakunNoInput.classList.toggle('filter-active-input', !!termSakunNo);
        if (searchCourtInput) searchCourtInput.classList.toggle('filter-active-input', !!termCourt);
        if (searchRegDateInput) searchRegDateInput.classList.toggle('filter-active-input', !!termRegDate);
        if (searchManagerInput) searchManagerInput.classList.toggle('filter-active-input', !!termManager);
        if (searchMNameInput) searchMNameInput.classList.toggle('filter-active-input', !!termMName);
        if (searchMNameInput) searchMNameInput.classList.toggle('filter-active-input', !!termMName);
        const sBtn = document.getElementById('search-status-btn');
        // 전체가 아니면 강조 (미선택 포함)
        if (sBtn) sBtn.classList.toggle('filter-active-input', !isAllStatus);

        const activeFilterBanner = document.getElementById('activeFilterBanner');
        const activeFilterText = document.getElementById('activeFilterText');
        if (dashboardFilter.active && activeFilterBanner && activeFilterText) {
            activeFilterBanner.classList.remove('content-hidden');
            let filterDesc = "";

            const managerText = (dashboardFilter.manager && dashboardFilter.manager !== 'All')
                ? `[${dashboardFilter.manager}] `
                : '';

            if (dashboardFilter.type === 'total_status') {
                filterDesc = `당일 이후 전체 [${dashboardFilter.status}] 건`;
            } else {
                const d = dashboardFilter.date;
                const niceDate = `${d.substring(0, 2)}/${d.substring(2, 4)}/${d.substring(4, 6)}`;
                if (dashboardFilter.type === 'missing') {
                    filterDesc = `${niceDate} 입찰가 미입력 건`;
                } else if (dashboardFilter.type === 'status') {
                    filterDesc = `${niceDate} [${dashboardFilter.status}] 건`;
                }
            }
            activeFilterText.textContent = `${filterDesc} 필터링 중`;
        } else {
            if (activeFilterBanner) activeFilterBanner.classList.add('content-hidden');
        }

        if (allBiddingData.length === 0 && loadingIndicator && !loadingIndicator.classList.contains('content-hidden')) {
            renderFilteredData([]);
            return;
        }

        let filteredData = allBiddingData.filter(item => {
            const inDate = String(item['in-date'] || '');
            const regDate = String(item.reg_date || '');
            // 입찰일자 필터링: 검색어가 있으면 검색어로, 없으면 오늘 이후만 (숫자 비교로 정확한 날짜 비교)
            const inDateStr = String(inDate || '');
            const inDateNum = inDateStr.replace(/\D/g, '');
            const matchesIndate = termIndate
                ? (inDateStr.includes(termIndate) || inDateNum.includes(termIndate.replace(/\D/g, '')))
                : (parseInt(inDateNum || '0') >= parseInt(todayYYMMDD.replace(/\D/g, '')));
            const matchesSakunNo = !termSakunNo || String(item.sakun_no || '').toLowerCase().includes(termSakunNo);
            // 정확한 매칭: 입력값과 정확히 일치하는 경우만 통과
            const matchesCourt = !termCourt || String(item.court || '').toLowerCase().trim() === termCourt.toLowerCase().trim();
            // 상태 필터링: "전체" 체크 시 모든 상태 통과, 아무것도 선택 안 하면 조회 안 됨
            const matchesStatus = isAllStatus ? true : (selectedStatuses.length > 0 && selectedStatuses.includes(String(item.stu_member || '').trim()));
            const matchesRegDate = !termRegDate || regDate.includes(termRegDate) || regDate.replace(/\D/g, '').includes(String(termRegDate).replace(/\D/g, ''));
            const matchesManager = !termManager || String(item.m_name_id || '').trim() === termManager;
            const matchesMName = !termMName || `${String(item.m_name || '')} ${String(item.m_name2 || '')}`.toLowerCase().includes(termMName);
            return matchesIndate && matchesSakunNo && matchesCourt && matchesStatus && matchesRegDate && matchesManager && matchesMName;
        });

        filteredData = filteredData.filter(item => {
            const itemDate = String(item['in-date']);
            const price = parseInt(String(item.bidprice || 0));

            if (dashboardFilter.active) {
                const isManagerMatch = (dashboardFilter.manager === 'All' || !dashboardFilter.manager) ||
                    (item.m_name_id === dashboardFilter.manager);

                if (!isManagerMatch) return false;

                if (dashboardFilter.type === 'missing') {
                    return itemDate === dashboardFilter.date && (isNaN(price) || price === 0) && item.stu_member === '입찰';
                } else if (dashboardFilter.type === 'status') {
                    return itemDate === dashboardFilter.date && item.stu_member === dashboardFilter.status;
                } else if (dashboardFilter.type === 'total_status') {
                    return itemDate >= todayYYMMDD && item.stu_member === dashboardFilter.status;
                }
            } else {
                // 입찰물건 관리 기본은 "전체"를 보여주고, 필요 시 사용자가 검색/필터로 좁히도록 함
                return true;
            }
            return true;
        });
        if (itemListSort.key) {
            const k = itemListSort.key;
            const d = itemListSort.dir;
            filteredData = filteredData.slice().sort((a, b) => {
                let va = a[k] != null ? String(a[k]) : '';
                let vb = b[k] != null ? String(b[k]) : '';
                if (k === 'in-date' || k === 'reg_date') { va = va.replace(/\D/g, ''); vb = vb.replace(/\D/g, ''); }
                return d * (va < vb ? -1 : va > vb ? 1 : 0);
            });
        }
        renderFilteredData(filteredData);

        // 전송 컬럼 제거 (렌더링 후 즉시 + 지연 실행)
        removeSendColumn();
        setTimeout(removeSendColumn, 10);
        setTimeout(removeSendColumn, 50);
        setTimeout(removeSendColumn, 100);

        const searchIds = ['search-indate', 'search-sakunno', 'search-court', 'search-regdate', 'search-manager', 'search-mname'];
        if (searchIds.indexOf(currentFocusId) !== -1) {
            setTimeout(() => {
                const el = document.getElementById(currentFocusId);
                if (el) el.focus();
            }, 0);
        }
        const statusLabel = document.getElementById('search-status-label');
        if (statusLabel) statusLabel.textContent = selectedStatuses.length ? selectedStatuses.join(',') : '상태';
    }

    function clearDashboardFilter() {
        dashboardFilter = { active: false, date: null, status: null, type: null, manager: null };
        applyFilters();
    }

    function sortItemList(key) {
        if (itemListSort.key === key) itemListSort.dir = -itemListSort.dir;
        else { itemListSort.key = key; itemListSort.dir = 1; }
        applyFilters();
    }

    function syncItemManagementSearchFromDashboard() {
        if (!dashboardFilter.active) return;

        // 관련 입력 필드 강조 (파란 배경)
        if (searchIndateInput && dashboardFilter.date) {
            searchIndateInput.value = dashboardFilter.date;
            searchIndateInput.classList.add('filter-active-input');
        }

        if (searchManagerInput && dashboardFilter.manager) {
            searchManagerInput.value = dashboardFilter.manager === 'All' ? '' : dashboardFilter.manager;
            searchManagerInput.classList.add('filter-active-input');
        }

        const statusToSet = (dashboardFilter.type === 'missing') ? '입찰' : (dashboardFilter.status || '');
        if (statusToSet) {
            document.querySelectorAll('input[name="search-status-cb"]').forEach(cb => {
                cb.checked = (cb.value === statusToSet);
            });
            const allStatusCb = document.getElementById('search-status-all');
            if (allStatusCb) allStatusCb.checked = false;
            const statusBtn = document.getElementById('search-status-btn');
            const statusLabel = document.getElementById('search-status-label');
            if (statusBtn) statusBtn.classList.add('filter-active-input');
            if (statusLabel) {
                statusLabel.textContent = statusToSet;
            }
        }
    }

    function resetItemManagementSearch() {
        // 모든 입력 필드 강조 제거
        document.querySelectorAll('#ItemManagement .filter-active-input').forEach(el => {
            el.classList.remove('filter-active-input');
        });
        const statusLabel = document.getElementById('search-status-label');
        if (statusLabel) {
            statusLabel.textContent = '전체';
            statusLabel.style.fontWeight = '';
            statusLabel.style.color = '';
        }

        if (searchIndateInput) {
            searchIndateInput.value = ''; // 검색초기화 시 입찰일자 비우기
        }
        if (searchSakunNoInput) searchSakunNoInput.value = '';
        if (searchCourtInput) searchCourtInput.value = '';
        if (searchRegDateInput) searchRegDateInput.value = '';
        if (searchManagerInput) searchManagerInput.value = '';
        if (searchMNameInput) searchMNameInput.value = '';

        // [변경] 상태 필터 초기화: '전체' 체크, 나머지 해제
        const allStatusCb = document.getElementById('search-status-all');
        if (allStatusCb) allStatusCb.checked = true;
        const statusCbs = document.querySelectorAll('input[name="search-status-cb"]');
        statusCbs.forEach(cb => {
            if (cb.id !== 'search-status-all') { // '전체' 체크박스는 제외
                cb.checked = false;
            }
        });

        if (statusLabel) {
            statusLabel.textContent = '상태';
            statusLabel.style.fontWeight = '';
            statusLabel.style.color = '';
        }
        const dd = document.getElementById('search-status-dropdown');
        if (dd) dd.classList.add('content-hidden');
        dashboardFilter = { active: false, date: null, status: null, type: null, manager: null };
        loadData(true);
    }



    function toggleAllItemCheckboxes(headerCheckbox) {
        const cbs = dataTableBody ? dataTableBody.querySelectorAll('input.item-row-cb') : [];
        cbs.forEach(cb => { cb.checked = !!headerCheckbox.checked; });
    }

    function handleItemCaptureListDownload() {
        const cbs = dataTableBody ? dataTableBody.querySelectorAll('input.item-row-cb:checked') : [];
        const list = Array.from(cbs).map(cb => (cb.getAttribute('data-sakun-no') || cb.dataset.sakunNo || '').trim()).filter(Boolean);
        if (list.length === 0) {
            if (typeof showStatusMessage === 'function') showStatusMessage('캡처할 항목을 체크해 주세요.', 'warning');
            return;
        }
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const sec = String(now.getSeconds()).padStart(2, '0');
        const filename = '' + y + m + d + h + min + sec + '.txt';
        const blob = new Blob([list.join('\n')], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        if (typeof showStatusMessage === 'function') showStatusMessage('파일(' + filename + ')이 다운로드 폴더에 저장됩니다. 해당 파일을 아래 폴더로 이동한 뒤 건변등록.bat을 실행하세요. → C:\\LJW\\MAPS_TEST\\00.imageup\\건별 캡쳐 리스트', 'success');
    }

    // --- [Telegram] 입찰물건 관리: 체크된 항목 다중 전송 ---
    function getSelectedItemIdsFromList_() {
        const cbs = dataTableBody ? dataTableBody.querySelectorAll('input.item-row-cb:checked') : [];
        return Array.from(cbs).map(cb => {
            const tr = cb.closest ? cb.closest('tr') : null;
            return tr && tr.dataset ? tr.dataset.id : '';
        }).filter(Boolean);
    }

    function handleBulkTelegramSendFromItemList() {
        if (IS_MEMBER_VIEW) return;
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            showStatus('Google Apps Script 환경이 아닙니다.', 'error');
            return;
        }
        const ids = getSelectedItemIdsFromList_();
        if (!ids || ids.length === 0) {
            showStatus('전송할 항목을 체크해 주세요.', 'error');
            return;
        }

        showConfirmInStatus_(`선택한 ${ids.length}건을 텔레그램으로 전송할까요?`, () => {
            const styleEl = document.getElementById('telegram-style-select-bulk');
            const styleKey = styleEl ? String(styleEl.value || '').trim() : 'card';
            let ok = 0;
            let fail = 0;
            let idx = 0;

            const next = () => {
                const done = ok + fail;
                showStatus(`전송 중... (${done}/${ids.length})`, 'warning');
                if (idx >= ids.length) {
                    showStatus(`전송 완료: 성공 ${ok}건 / 실패 ${fail}건`, (fail > 0 ? 'warning' : 'success'));
                    return;
                }
                const id = ids[idx++];
                const item = getBidItemById(id);
                if (!item || !item.member_id) {
                    fail++;
                    next();
                    return;
                }
                google.script.run
                    .withSuccessHandler(res => {
                        if (res && res.success) ok++;
                        else fail++;
                        next();
                    })
                    .withFailureHandler(_err => {
                        fail++;
                        next();
                    })
                    .sendItemToMemberTelegramWithStyle(item.member_id, item.id, styleKey);
            };

            next();
        }, () => { });
    }

    function getSelectedCalendarStatusValues() {
        const cbs = document.querySelectorAll('input[name="cal-search-status-cb"]:checked');
        return Array.from(cbs).map(el => el.value);
    }

    function handleCalendarStatusAll(allCb) {
        if (allCb.checked) {
            const cbs = document.querySelectorAll('input[name="cal-search-status-cb"]');
            cbs.forEach(cb => cb.checked = false);
        } else {
            // "전체"를 해제하면? (보통 전체 해제 시 아무것도 안 선택된 상태가 됨 -> renderCalendar에서 처리)
        }
    }

    function handleCalendarStatusOther(otherCb) {
        if (otherCb.checked) {
            const allCb = document.getElementById('cal-search-status-all');
            if (allCb) allCb.checked = false;
        }
    }

    function toggleCalendarStatusDropdown(ev) {
        ev.stopPropagation();
        const dd = document.getElementById('cal-search-status-dropdown');
        const btn = document.getElementById('cal-search-status-btn');
        if (!dd || !btn) return;
        const isHidden = dd.classList.contains('content-hidden');
        dd.classList.toggle('content-hidden', !isHidden);
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        if (isHidden) {
            document.addEventListener('click', closeCalendarStatusDropdownOnce);
        }
    }

    function closeCalendarStatusDropdownOnce() {
        const dd = document.getElementById('cal-search-status-dropdown');
        if (dd) dd.classList.add('content-hidden');
        const btn = document.getElementById('cal-search-status-btn');
        if (btn) btn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', closeCalendarStatusDropdownOnce);
        updateCalendarStatusLabel();
    }

    function updateCalendarStatusLabel() {
        const allCb = document.getElementById('cal-search-status-all');
        const isAllStatus = (allCb && allCb.checked);
        const selected = getSelectedCalendarStatusValues();
        if (calSearchStatusLabel) {
            if (isAllStatus) {
                calSearchStatusLabel.textContent = '전체';
            } else if (selected.length === 0) {
                calSearchStatusLabel.textContent = '미선택';
            } else {
                calSearchStatusLabel.textContent = selected.join(',');
            }
        }
    }

    // 상태 체크박스 변경 시 라벨 업데이트
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            document.querySelectorAll('input[name="cal-search-status-cb"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    updateCalendarStatusLabel();
                });
            });
            // 초기 로드 시 "전체" 라벨 표시
            updateCalendarStatusLabel();
        }, 100);
    });

    function resetCalendarSearch() {
        calendarFilter = { active: false, member: null, status: null };

        // 모든 입력 필드 강조 제거
        document.querySelectorAll('#BiddingSchedule .filter-active-input').forEach(el => {
            el.classList.remove('filter-active-input');
        });

        if (calSearchSakunno) calSearchSakunno.value = '';
        if (calSearchCourt) calSearchCourt.value = '';
        document.querySelectorAll('input[name="cal-search-status-cb"]').forEach(cb => { cb.checked = false; });
        const allCalStatusCb = document.getElementById('cal-search-status-all');
        if (allCalStatusCb) allCalStatusCb.checked = true;
        const statusLabel = document.getElementById('cal-search-status-label');
        if (statusLabel) {
            statusLabel.textContent = '전체';
            statusLabel.style.fontWeight = '';
            statusLabel.style.color = '';
        }
        const calStatusDd = document.getElementById('cal-search-status-dropdown');
        if (calStatusDd) calStatusDd.classList.add('content-hidden');
        if (calSearchMember) calSearchMember.value = '';
        if (calSearchManager) calSearchManager.value = '';
        loadDataAndRenderCalendar();
    }

    function clearCalendarFilter() {
        calendarFilter = { active: false, member: null, status: null };
        renderCalendar();
    }

    // 마우스 휠 아래로 이동시 다음주가 계속 나오도록 구현 (여러 주가 이미 렌더링되어 있으므로 스크롤만 처리)
    let calendarWheelHandler = null;
    function setupCalendarWheelScroll() {
        const calendarWeekView = document.getElementById('calendar-week-view');
        if (!calendarWeekView) return;

        // 기존 이벤트 리스너 제거 (중복 방지)
        const existingHandler = calendarWeekView._wheelHandler;
        if (existingHandler) {
            calendarWeekView.removeEventListener('wheel', existingHandler);
        }

        // 마우스 휠 이벤트 핸들러
        const wheelHandler = (e) => {
            // 위로 스크롤 시도 (deltaY < 0)이고 맨 위에 있을 때
            if (e.deltaY < 0 && calendarWeekView.scrollTop <= 5) { // 5px 여유를 둠
                // 아직 이전 주를 모두 로드하지 않았을 때
                if (numWeeksBefore < 12 && !isLoadingPreviousWeeks) {
                    e.preventDefault(); // 기본 스크롤 방지
                    loadPreviousWeeks(4); // 4주씩 추가
                }
            }
        };

        // 이벤트 리스너 추가
        calendarWeekView.addEventListener('wheel', wheelHandler, { passive: false });
        calendarWeekView._wheelHandler = wheelHandler; // 참조 저장 (나중에 제거용)
    }

    function isMemberMatch(item, targetMember) {
        if (targetMember === '미정') {
            return !item.m_name || item.m_name === '미등록' || item.m_name === '';
        }
        return item.m_name === targetMember;
    }

    function filterFromDashboard(targetDate, type, status = null, manager = null) {
        dashboardFilter = {
            active: true,
            date: targetDate,
            type: type,
            status: status,
            manager: manager
        };
        navigateTo('ItemManagement');
    }

    function jumpToEarliestDate(filterCriteria) {
        let filteredItems = allBiddingData;

        // 관련 입력 필드 강조
        if (filterCriteria.member && calSearchMember) {
            calSearchMember.value = filterCriteria.member;
            calSearchMember.classList.add('filter-active-input');
        }

        if (filterCriteria.status) {
            document.querySelectorAll('input[name="cal-search-status-cb"]').forEach(cb => {
                cb.checked = (cb.value === filterCriteria.status);
            });
            const allCalStatusCb = document.getElementById('cal-search-status-all');
            if (allCalStatusCb) allCalStatusCb.checked = false;
            updateCalendarStatusLabel();
            const statusBtn = document.getElementById('cal-search-status-btn');
            const statusLabel = document.getElementById('cal-search-status-label');
            if (statusBtn) statusBtn.classList.add('filter-active-input');
            // 스타일은 CSS 클래스(filter-active-input)로만 처리
        }

        if (filterCriteria.member) {
            filteredItems = filteredItems.filter(item => isMemberMatch(item, filterCriteria.member));
        }
        if (filterCriteria.status) {
            filteredItems = filteredItems.filter(item => item.stu_member === filterCriteria.status);
        }

        let earliestDate = null;
        filteredItems.forEach(item => {
            const itemDateStr = String(item['in-date']);
            if (itemDateStr.length === 6) {
                const year = 2000 + parseInt(itemDateStr.substring(0, 2));
                const month = parseInt(itemDateStr.substring(2, 4)) - 1;
                const day = parseInt(itemDateStr.substring(4, 6));
                const d = new Date(year, month, day);
                if (!earliestDate || d < earliestDate) {
                    earliestDate = d;
                }
            }
        });
        if (earliestDate) {
            currentCalendarDate = getWeekStart(earliestDate);
        } else {
            currentCalendarDate = getWeekStart(new Date());
        }

        calendarFilter = {
            active: true,
            member: filterCriteria.member || null,
            status: filterCriteria.status || null
        };

        navigateTo('BiddingSchedule');
        renderCalendar();
    }

    function filterCalendarByStatus(status) {
        jumpToEarliestDate({ status: status });
    }

    function filterCalendarByMemberAndStatus(member, status) {
        jumpToEarliestDate({ member: member, status: status });
    }

    // --- [5] 회원 관리 로직 ---

    function loadMembers() {
        // DOM 요소를 다시 찾기 (탭이 표시된 후)
        const memberDataTableBody = getMemberDataTableBody();

        if (!memberDataTableBody) {
            console.error('회원 관리 테이블을 찾을 수 없습니다. DOM이 준비되지 않았을 수 있습니다.');
            // 재시도 (DOM이 아직 준비되지 않았을 수 있음)
            setTimeout(() => {
                const retryTableBody = getMemberDataTableBody();
                if (retryTableBody) {
                    loadMembers();
                } else {
                    showStatus('회원 관리 테이블을 찾을 수 없습니다. 페이지를 새로고침해주세요.', 'error');
                }
            }, 200);
            return;
        }

        memberDataTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">회원 데이터를 불러오는 중...</td></tr>';

        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.error('Google Apps Script 환경이 아닙니다.');
            showStatus('Google Apps Script 환경이 아닙니다.', 'error');
            if (memberDataTableBody) {
                memberDataTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Google Apps Script 환경이 아닙니다.</td></tr>';
            }
            return;
        }

        google.script.run
            .withSuccessHandler(data => {
                const tableBody = getMemberDataTableBody();
                if (!tableBody) {
                    console.error('회원 테이블을 찾을 수 없습니다.');
                    return;
                }

                if (!data || !Array.isArray(data)) {
                    renderMemberList([]);
                    return;
                }
                if (data.length === 0) {
                    allMemberData = [];
                    renderMemberList([]);
                    return;
                }
                allMemberData = data;
                renderMemberList(data);
                showStatus('회원 데이터를 성공적으로 불러왔습니다.', 'success');
                // [NEW] 회원 자동완성 리스트 업데이트
                if (typeof updateMemberDatalist === 'function') {
                    updateMemberDatalist();
                }
            })
            .withFailureHandler(error => {
                console.error('회원 데이터 로드 실패:', error);
                showStatus('회원 데이터 로드 실패: ' + error.message, 'error');
                const tableBody = getMemberDataTableBody();
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">데이터 로드 중 오류가 발생했습니다: ' + error.message + '</td></tr>';
                }
            })
            .readAllMembers();
    }

    function renderMemberList(data) {
        const memberDataTableBody = getMemberDataTableBody();
        const noDataMessage = document.getElementById('memberNoDataMessage');
        const loadingIndicator = document.getElementById('memberLoadingIndicator');

        if (!memberDataTableBody) return;

        memberDataTableBody.innerHTML = '';

        if (!data || !Array.isArray(data) || data.length === 0) {
            if (noDataMessage) noDataMessage.classList.remove('content-hidden');
            memberDataTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">데이터가 없습니다.</td></tr>';
            return;
        }

        if (noDataMessage) noDataMessage.classList.add('content-hidden');

        try {
            data.forEach((member) => {
                if (!member) return;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer transition border-b border-gray-100';
                row.onclick = () => showMemberForm('edit', member);

                const id = member.member_id || '';
                const name = member.member_name || member.name || '';
                const role = member.gubun || member.role || 'member';
                const phone = member.phone || '';
                const className = member.class_id || member.class_name || '';
                let regDate = member.reg_date || '';
                if (regDate && regDate.length > 10) regDate = regDate.substring(0, 10);

                let roleClass = 'text-gray-600';
                if (role === 'admin' || role === '관리자') roleClass = 'text-red-600 font-bold';
                if (role === 'manager' || role === '직원') roleClass = 'text-indigo-600 font-bold';

                row.innerHTML = `
                    <td class="px-2 py-3 text-center text-sm text-gray-500">${id}</td>
                    <td class="px-2 py-3 text-center text-sm font-medium text-gray-900">${name}</td>
                    <td class="px-2 py-3 text-center text-sm ${roleClass}">${role}</td>
                    <td class="px-2 py-3 text-center text-sm text-gray-500">${phone}</td>
                    <td class="px-2 py-3 text-center text-sm text-gray-500">${className}</td>
                    <td class="px-2 py-3 text-center text-xs text-gray-400">${regDate}</td>
                `;
                memberDataTableBody.appendChild(row);
            });
        } catch (e) {
            console.error('회원 목록 렌더링 오류:', e);
            memberDataTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">렌더링 오류: ${e.message}</td></tr>`;
        }
    }

    function filterMembers() {
        const nameInput = document.getElementById('mem-search-name');
        const roleInput = document.getElementById('mem-search-role');
        const keywordName = nameInput ? nameInput.value.toLowerCase() : '';
        const keywordRole = roleInput ? roleInput.value.toLowerCase() : '';

        // 필터 배너 표시 여부 제어
        const filterBanner = document.getElementById('memberActiveFilterBanner');
        if (filterBanner) {
            if (keywordName || keywordRole) {
                filterBanner.classList.remove('content-hidden');
            } else {
                filterBanner.classList.add('content-hidden');
            }
        }

        if (!allMemberData) return;

        const filtered = allMemberData.filter(m => {
            const mName = m.member_name || m.name || '';
            const mRole = m.gubun || m.role || '';
            const matchName = !keywordName || String(mName).toLowerCase().includes(keywordName) || String(m.member_id || '').toLowerCase().includes(keywordName);
            const matchRole = !keywordRole || String(mRole).toLowerCase().includes(keywordRole);
            return matchName && matchRole;
        });
        renderMemberList(filtered);
    }

    function clearMemberFilter() {
        const nameInput = document.getElementById('mem-search-name');
        const roleInput = document.getElementById('mem-search-role');
        if (nameInput) nameInput.value = '';
        if (roleInput) roleInput.value = '';
        filterMembers();
    }

    function resetMemberSearch() {
        clearMemberFilter();
        // 전체 데이터 다시 로드 필요 시 로드
        renderMemberList(allMemberData);
    }

    function showMemberForm(mode, data = {}) {
        currentMode = mode;

        if (window.innerWidth < 768) {
            const memberListPane = document.getElementById('memberListPane');
            const memberDetailPane = document.getElementById('memberDetailPane');
            if (memberListPane) memberListPane.classList.add('mobile-hidden');
            if (memberDetailPane) memberDetailPane.classList.remove('mobile-hidden');
        }

        const memberFormTitle = getMemberFormTitle();
        const btnCreateMember = getBtnCreateMember();
        const btnUpdateMember = getBtnUpdateMember();
        const btnDeleteMember = getBtnDeleteMember();
        const memberForm = getMemberForm();

        if (mode === 'create') {
            if (memberFormTitle) memberFormTitle.textContent = '회원 등록';
            if (btnCreateMember) btnCreateMember.classList.remove('content-hidden');
            if (btnUpdateMember) btnUpdateMember.classList.add('content-hidden');
            if (btnDeleteMember) btnDeleteMember.classList.add('content-hidden');
            if (memberForm) memberForm.reset();
            if (memId) memId.value = '';
            if (memRegDate) memRegDate.value = '';
            if (memMemberToken) memMemberToken.value = '';
            if (memTelegramChatId) memTelegramChatId.value = '';
            if (memTelegramEnabled) memTelegramEnabled.value = '';
        } else {
            if (memberFormTitle) memberFormTitle.textContent = '회원 수정';
            if (btnCreateMember) btnCreateMember.classList.add('content-hidden');
            if (btnUpdateMember) btnUpdateMember.classList.remove('content-hidden');
            if (btnDeleteMember) btnDeleteMember.classList.remove('content-hidden');

            if (memId) memId.value = data.member_id;
            if (memName) memName.value = data.member_name || data.name || '';
            if (memRole) memRole.value = data.gubun || data.role || '회원';
            if (memPhone) memPhone.value = data.phone || '';
            if (memClassName) memClassName.value = data.class_id || data.class_name || '';
            if (memLoginId) memLoginId.value = data.login_id || '';
            if (memPassword) memPassword.value = data.password || '';
            if (memAccountNo) memAccountNo.value = data.account_no || '';
            if (memRrn) memRrn.value = data.rrn || '';
            if (memAddress) memAddress.value = data.address || '';
            if (memNote1) memNote1.value = data.note1 || '';
            if (memNote2) memNote2.value = data.note2 || '';
            if (memRegDate) memRegDate.value = data.reg_date || '';
            if (memMemberToken) memMemberToken.value = data.member_token || '';
            if (memTelegramChatId) memTelegramChatId.value = data.telegram_chat_id || '';
            if (memTelegramEnabled) memTelegramEnabled.value = data.telegram_enabled || '';
        }
    }

    function copyMemberTokenToClipboard() {
        const token = memMemberToken ? String(memMemberToken.value || '').trim() : '';
        if (!token) {
            showStatus('복사할 토큰이 없습니다. 먼저 토큰을 재발급하세요.', 'error');
            return;
        }
        // clipboard API 우선
        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(token).then(() => {
                showStatus('토큰을 복사했습니다.', 'success');
            }).catch(() => {
                // fallback
                try {
                    memMemberToken.focus();
                    memMemberToken.select();
                    document.execCommand('copy');
                    showStatus('토큰을 복사했습니다.', 'success');
                } catch (e) {
                    showStatus('복사에 실패했습니다. 토큰을 길게 눌러 복사하세요.', 'error');
                }
            });
            return;
        }
        try {
            memMemberToken.focus();
            memMemberToken.select();
            document.execCommand('copy');
            showStatus('토큰을 복사했습니다.', 'success');
        } catch (e) {
            showStatus('복사에 실패했습니다. 토큰을 길게 눌러 복사하세요.', 'error');
        }
    }

    function handleRegenerateMemberToken() {
        const memberId = memId ? String(memId.value || '').trim() : '';
        if (!memberId) {
            showStatus('먼저 회원을 저장한 뒤 토큰을 발급할 수 있습니다.', 'error');
            return;
        }
        showStatus('토큰 재발급 중...', 'warning');
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.success) {
                    if (memMemberToken) memMemberToken.value = res.member_token || '';
                    showStatus('토큰을 재발급했습니다. 회원에게 이 토큰을 보내주세요.', 'success');
                } else {
                    showStatus((res && res.message) ? res.message : '토큰 재발급 실패', 'error');
                }
            })
            .withFailureHandler(err => showStatus('토큰 재발급 오류: ' + err.message, 'error'))
            .regenerateMemberToken(memberId);
    }

    function handleMemberFormSubmit() {
        if (!memName || !memName.value) {
            showStatus('이름은 필수 입력 항목입니다.', 'error');
            return;
        }

        const memberData = {
            member_id: memId ? memId.value : '',
            member_name: memName.value,
            gubun: memRole ? memRole.value : '회원',
            phone: memPhone ? memPhone.value : '',
            class_id: memClassName ? memClassName.value : '',
            login_id: memLoginId ? memLoginId.value : '',
            password: memPassword ? memPassword.value : '',
            account_no: memAccountNo ? memAccountNo.value : '',
            rrn: memRrn ? memRrn.value : '',
            address: memAddress ? memAddress.value : '',
            note1: memNote1 ? memNote1.value : '',
            note2: memNote2 ? memNote2.value : ''
        };

        showStatus('저장 중...', 'warning');

        if (currentMode === 'create') {
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showStatus(result.message, 'success');
                        loadMembers();
                        showMemberForm('create');
                    } else {
                        showStatus(result.message, 'error');
                    }
                })
                .withFailureHandler(err => showStatus('등록 오류: ' + err.message, 'error'))
                .createMember(memberData);
        } else {
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showStatus(result.message, 'success');
                        loadMembers();
                    } else {
                        showStatus(result.message, 'error');
                    }
                })
                .withFailureHandler(err => showStatus('수정 오류: ' + err.message, 'error'))
                .updateMember(memberData);
        }
    }

    function handleMemberDelete() {
        if (!memId || !memId.value) return;
        const id = memId.value;
        if (!confirm('정말 이 회원을 삭제하시겠습니까?')) return;

        showStatus('삭제 중...', 'warning');
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    loadMembers();
                    showMemberForm('create');
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(err => showStatus('삭제 오류: ' + err.message, 'error'))
            .deleteMember(id);
    }

    // --- [6] 이미지 동기화 (단계별 처리) ---
    function handleSyncImages() {
        const button = document.getElementById('syncImagesButton');
        const statusDiv = document.getElementById('syncImagesStatus');
        const detailsDiv = document.getElementById('syncImagesDetails');
        const tbody = document.getElementById('syncLogsTableBody');
        const container = document.getElementById('syncLogsListContainer');

        if (!button || !statusDiv) return;

        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        statusDiv.textContent = '동기화 시작 중...';

        if (detailsDiv) {
            detailsDiv.classList.add('content-hidden');
            detailsDiv.innerHTML = '';
        }
        if (tbody) tbody.innerHTML = '';
        if (container) container.classList.remove('content-hidden');

        let totalProcessed = 0;
        let totalNew = 0;
        let totalMatch = 0;
        let totalConflict = 0;
        let totalSkip = 0;
        let totalError = 0;

        function runBatch() {
            statusDiv.textContent = `동기화 진행 중... (현재까지 ${totalProcessed}건 처리 완료)`;

            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        const d = result.details;
                        totalProcessed += d.processCount;
                        totalNew += d.newCount;
                        totalMatch += d.matchCount;
                        totalConflict += d.conflictCount;
                        totalSkip += d.skipCount;
                        totalError += d.errorCount;

                        // 로그 테이블에 실시간 추가 (역순으로 쌓기 위해 앞에 추가)
                        if (d.logs && d.logs.length > 0) {
                            const newRows = d.logs.map(log => createSyncLogRowHtml(log)).join('');
                            tbody.innerHTML = newRows + tbody.innerHTML;
                        }

                        // 통계 실시간 업데이트
                        displaySyncDetails({
                            processCount: totalProcessed,
                            newCount: totalNew,
                            matchCount: totalMatch,
                            conflictCount: totalConflict,
                            skipCount: totalSkip,
                            errorCount: totalError,
                            remainingFiles: d.remainingFiles,
                            skippedFiles: d.skippedFiles,
                            errorFiles: d.errorFiles
                        }, detailsDiv);

                        if (d.remainingFiles > 0) {
                            // 아직 남은 파일이 있으면 다음 배치 실행
                            setTimeout(runBatch, 500);
                        } else {
                            // 최종 완료
                            button.disabled = false;
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                            statusDiv.textContent = `동기화가 모두 완료되었습니다. (총 ${totalProcessed}건)`;
                            statusDiv.classList.add('text-green-600');
                            showStatus('이미지 동기화가 완료되었습니다.', 'success');

                            // 대기실 데이터도 갱신
                            if (totalConflict > 0) loadSyncConflicts();
                        }
                    } else {
                        statusDiv.textContent = '오류: ' + result.message;
                        statusDiv.classList.add('text-red-600');
                        button.disabled = false;
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                        showStatus(result.message, 'error');
                    }
                })
                .withFailureHandler(error => {
                    statusDiv.textContent = '치명적 오류: ' + error.message;
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    showStatus('동기화 실패: ' + error.message, 'error');
                })
                .syncImages(10); // 10건씩 나누어 처리
        }

        runBatch();
    }

    // --- [Telegram] Webhook 설정 (환경설정 버튼) ---
    function handleSetTelegramWebhook() {
        const btn = document.getElementById('setTelegramWebhookButton');
        const statusEl = document.getElementById('telegramWebhookStatus');

        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            showStatus('Google Apps Script 환경이 아닙니다.', 'error');
            return;
        }
        if (btn) {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (statusEl) statusEl.textContent = '설정 중...';
        showStatus('텔레그램 웹훅 설정 중...', 'warning');

        google.script.run
            .withSuccessHandler(res => {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if (res && res.success) {
                    if (statusEl) statusEl.textContent = '설정 완료';
                    showStatus('웹훅 설정이 완료되었습니다.', 'success');
                } else {
                    if (statusEl) statusEl.textContent = (res && res.message) ? res.message : '설정 실패';
                    showStatus((res && res.message) ? res.message : '웹훅 설정 실패', 'error');
                }
            })
            .withFailureHandler(err => {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if (statusEl) statusEl.textContent = '오류: ' + err.message;
                showStatus('웹훅 설정 오류: ' + err.message, 'error');
            })
            .setTelegramWebhook();
    }

    function displaySyncDetails(details, container, isError = false) {
        if (!details || !container) return;

        container.classList.remove('content-hidden');
        let html = '';

        // 통계 정보
        html += '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">';
        html += '<h3 class="font-semibold text-gray-800 mb-2">처리 통계</h3>';
        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">';
        html += `<div><span class="text-gray-600">총 처리:</span> <span class="font-bold text-indigo-600">${details.processCount || 0}</span></div>`;
        html += `<div><span class="text-gray-600">신규 추가:</span> <span class="font-bold text-green-600">${details.newCount || 0}</span></div>`;
        html += `<div><span class="text-gray-600">매칭 성공:</span> <span class="font-bold text-blue-600">${details.matchCount || 0}</span></div>`;
        if (details.conflictCount > 0) {
            html += `<div><span class="text-gray-600">충돌(대기):</span> <span class="font-bold text-red-600">${details.conflictCount}</span></div>`;
        }
        if (details.skipCount > 0) {
            html += `<div><span class="text-gray-600">건너뜀:</span> <span class="font-bold text-yellow-600">${details.skipCount}</span></div>`;
        }
        if (details.errorCount > 0) {
            html += `<div><span class="text-gray-600">오류:</span> <span class="font-bold text-red-600">${details.errorCount}</span></div>`;
        }
        if (details.remainingFiles > 0) {
            html += `<div><span class="text-gray-600">남은 파일:</span> <span class="font-bold text-orange-600">${details.remainingFiles}</span></div>`;
        }
        html += '</div></div>';

        // 건너뜀 파일 목록
        if (details.skippedFiles && details.skippedFiles.length > 0) {
            html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">';
            html += '<h3 class="font-semibold text-yellow-800 mb-2">건너뜀 파일 (파일명 형식 오류)</h3>';
            html += '<div class="max-h-40 overflow-y-auto text-sm">';
            details.skippedFiles.forEach(file => {
                html += `<div class="mb-1"><span class="font-mono text-xs">${file.name}</span> <span class="text-yellow-700 text-xs">(${file.reason})</span></div>`;
            });
            if (details.skipCount > details.skippedFiles.length) {
                html += `<div class="text-yellow-700 text-xs mt-2">... 외 ${details.skipCount - details.skippedFiles.length}개 파일</div>`;
            }
            html += '</div></div>';
        }

        // 오류 파일 목록
        if (details.errorFiles && details.errorFiles.length > 0) {
            html += '<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">';
            html += '<h3 class="font-semibold text-red-800 mb-2">처리 오류 파일</h3>';
            html += '<div class="max-h-40 overflow-y-auto text-sm">';
            details.errorFiles.forEach(file => {
                html += `<div class="mb-1"><span class="font-mono text-xs">${file.name}</span> <span class="text-red-700 text-xs">(${file.error})</span></div>`;
            });
            if (details.errorCount > details.errorFiles.length) {
                html += `<div class="text-red-700 text-xs mt-2">... 외 ${details.errorCount - details.errorFiles.length}개 파일</div>`;
            }
            html += '</div></div>';
        }

        // 중복 파일 목록
        if (details.duplicateFiles && details.duplicateFiles.length > 0) {
            html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">';
            html += '<h3 class="font-semibold text-blue-800 mb-2">중복 파일 (기존 파일 삭제됨)</h3>';
            html += '<div class="max-h-40 overflow-y-auto text-sm">';
            details.duplicateFiles.forEach(fileName => {
                html += `<div class="mb-1"><span class="font-mono text-xs">${fileName}</span></div>`;
            });
            html += '</div></div>';
        }

        container.innerHTML = html;
    }

    /**
     * 동기화 로그 검색 및 표시
     */
    function handleSearchSyncLogs() {
        const sakunNo = document.getElementById('sync-search-sakunno').value;
        const inDate = document.getElementById('sync-search-indate').value;
        const court = document.getElementById('sync-search-court').value;

        const container = document.getElementById('syncLogsListContainer');
        const tbody = document.getElementById('syncLogsTableBody');

        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">조회 중...</td></tr>';
        if (container) container.classList.remove('content-hidden');

        google.script.run
            .withSuccessHandler(logs => {
                renderSyncLogsTable(logs);
            })
            .withFailureHandler(err => {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">조회 오류: ${err.message}</td></tr>`;
            })
            .getSyncLogs({ sakun_no: sakunNo, in_date: inDate, court: court });
    }
    function renderSyncLogsTable(logs) {
        const tbody = document.getElementById('syncLogsTableBody');
        const container = document.getElementById('syncLogsListContainer');
        if (!tbody) return;

        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">조회된 이력이 없습니다.</td></tr>';
            return;
        }

        let html = '';
        logs.forEach(log => {
            html += createSyncLogRowHtml(log);
        });
        tbody.innerHTML = html;
        if (container) container.classList.remove('content-hidden');
    }

    function createSyncLogRowHtml(log) {
        const dateStr = log.timestamp ? log.timestamp : (log[0] ? new Date(log[0]).toLocaleString() : '-');

        // 데이터 구조 보정 (배열 형태 호환성)
        const status = log.status || log[1] || '-';
        const sakun = log.sakun_no || log[2] || '-';
        const inDate = log.in_date || log[3] || '-';
        const court = log.court || log[4] || '-';
        const fileName = log.file_name || log[5] || '-';
        const msg = log.message || log[6] || '-';
        const imgId = log.image_code || log[7] || '-';
        const aucId = log.auction_id || log[8] || '-';

        let statusClass = 'text-gray-600';
        if (status.includes('신규')) statusClass = 'text-green-600';
        else if (status.includes('매칭')) statusClass = 'text-blue-600';
        else if (status.includes('충돌')) statusClass = 'text-red-600';

        return `
            <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                <td class="px-3 py-2 text-[11px] text-gray-500">${dateStr}</td>
                <td class="px-3 py-2 text-xs font-bold ${statusClass}">${status}</td>
                <td class="px-3 py-2 text-xs font-bold">
                    <a href="javascript:void(0)" onclick="searchFromSyncLog('${sakun}')" class="text-indigo-600 hover:text-indigo-800 hover:underline">
                        ${sakun}
                    </a>
                </td>
                <td class="px-3 py-2 text-xs text-gray-600">${inDate}</td>
                <td class="px-3 py-2 text-xs text-gray-600">${court}</td>
                <td class="px-3 py-2 text-xs text-gray-500 truncate max-w-[150px]" title="${fileName}">${msg}</td>
                <td class="px-3 py-2 text-[10px] text-gray-400 font-mono">${imgId}</td>
                <td class="px-3 py-2 text-[10px] text-gray-400">${aucId}</td>
            </tr>
        `;
    }

    /**
     * 동가화 로그에서 사건번호 클릭 시 입찰물건 관리로 이동 및 검색
     */
    function searchFromSyncLog(sakunNo) {
        if (!sakunNo || sakunNo === '-') return;

        // 1. 입찰물건 관리 탭으로 이동
        navigateTo('ItemManagement');

        // 2. 검색창에 사건번호 입력
        const searchInput = document.getElementById('search-sakunno');
        if (searchInput) {
            searchInput.value = sakunNo;

            // 3. 필터 초기화 (모든 상태 검색을 위해)
            const allStatusCb = document.getElementById('search-status-all');
            if (allStatusCb) {
                allStatusCb.checked = true;
                handleStatusAll(allStatusCb);
            }

            // 4. 검색 실행 (탭 전환 및 렌더링 시간 고려하여 지연 호출)
            setTimeout(() => {
                if (typeof applyFilters === 'function') {
                    applyFilters();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 150);

            if (typeof showStatus === 'function') showStatus(`${sakunNo} 건으로 이동하여 검색을 실행했습니다.`, 'success');
        }
    }

    /**
     * 이미지 동기화 충돌 내역(대기실) 로드
     */
    function loadSyncConflicts() {
        const tbody = document.getElementById('syncConflictTableBody');
        if (!tbody) return;

        google.script.run
            .withSuccessHandler(conflicts => {
                renderSyncConflicts(conflicts);
            })
            .withFailureHandler(err => {
                tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">로드 실패: ${err.message}</td></tr>`;
            })
            .getSyncConflicts();
    }

    /**
     * 동기화 충돌 내역 렌더링
     */
    function renderSyncConflicts(conflicts) {
        const tbody = document.getElementById('syncConflictTableBody');
        if (!tbody) return;

        if (!conflicts || conflicts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-12 text-center text-gray-500 italic">대기 중인 충돌 내역이 없습니다.</td></tr>';
            return;
        }

        let html = '';
        conflicts.forEach(c => {
            const timeStr = c.timestamp ? c.timestamp : '-';
            const bidPrice = Number(c.bid_price || 0).toLocaleString();

            html += `
                <tr class="hover:bg-red-50 transition-colors">
                    <td class="px-3 py-3 text-center">
                        <input type="checkbox" class="sync-conflict-item-check rounded" value="${c.id}">
                    </td>
                    <td class="px-3 py-3">
                        <div class="text-[10px] text-gray-400 mb-1">${timeStr}</div>
                        <div class="text-sm font-bold text-gray-800">
                            <a href="javascript:void(0)" onclick="searchFromSyncLog('${c.sakun_no}')" class="text-indigo-600 hover:text-indigo-800 hover:underline">
                                ${c.sakun_no}
                            </a>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-gray-700 font-medium">${c.court || '-'}</td>
                    <td class="px-3 py-3">
                        <span class="px-2 py-0.5 rounded-full text-[10px] bg-blue-50 text-blue-600 border border-blue-100">${c.state || '-'}</span>
                    </td>
                    <td class="px-3 py-3 text-gray-700">${c.member || '-'}</td>
                    <td class="px-3 py-3 text-right font-mono font-bold text-gray-900">${bidPrice}</td>
                    <td class="px-3 py-3">
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-[11px]">${c.existing_uploader}</span>
                    </td>
                    <td class="px-3 py-3">
                        <div class="flex items-center">
                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-[11px] font-bold border border-red-200">${c.new_uploader}</span>
                            <button onclick="openAuctionWindowById('${c.auction_id}')" class="ml-2 text-blue-600 hover:text-blue-800" title="옥션보기">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </button>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <div class="flex flex-col space-y-1 items-center">
                            <button onclick="handleSyncConflictResolve('${c.id}', 'keep_existing')" 
                                    class="w-20 px-2 py-1 bg-gray-500 text-white text-[10px] rounded hover:bg-gray-600 transition">
                                기존 유지
                            </button>
                            <button onclick="handleSyncConflictResolve('${c.id}', 'replace_with_new')" 
                                    class="w-20 px-2 py-1 bg-red-600 text-white text-[10px] rounded hover:bg-red-700 transition shadow-sm">
                                신규 교체
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    // [NEW] 동기화 충돌 체크박스 전체 토글
    function toggleAllSyncConflictCheckboxes(master) {
        const checks = document.querySelectorAll('.sync-conflict-item-check');
        checks.forEach(c => c.checked = master.checked);
    }

    function showBulkSyncResolveModal() {
        const selectedIds = Array.from(document.querySelectorAll('.sync-conflict-item-check:checked')).map(c => c.value);
        if (selectedIds.length === 0) {
            showStatus('처리할 항목을 선택해주세요.', 'warning');
            return;
        }

        const countSpan = document.getElementById('bulk-sync-count');
        if (countSpan) countSpan.textContent = selectedIds.length;

        document.getElementById('syncConflictBulkModal').classList.remove('content-hidden');
    }

    function closeSyncConflictBulkModal() {
        document.getElementById('syncConflictBulkModal').classList.add('content-hidden');
    }

    /**
     * 모달에서 버튼 클릭 시 실제 처리 실행
     */
    function executeBulkSyncResolve(action) {
        const selectedIds = Array.from(document.querySelectorAll('.sync-conflict-item-check:checked')).map(c => c.value);
        if (selectedIds.length === 0) return;

        closeSyncConflictBulkModal();
        handleBulkSyncConflictResolve(selectedIds, action);
    }

    function handleBulkSyncConflictResolve(ids, action) {
        showStatus(`${ids.length}건 일괄 처리 중...`, 'warning');

        google.script.run
            .withSuccessHandler(res => {
                if (res.success) {
                    showStatus(res.message, 'success');
                    loadSyncConflicts();
                    const master = document.getElementById('sync-conflict-checkall');
                    if (master) master.checked = false;
                } else {
                    showStatus(res.message, 'error');
                }
            })
            .withFailureHandler(err => {
                showStatus('일괄 처리 실패: ' + err.message, 'error');
            })
            .resolveSyncConflictsBatch(ids, action);
    }

    /**
     * 충돌 해결 실행
     */
    function handleSyncConflictResolve(conflictId, action) {
        const msg = action === 'keep_existing'
            ? '기존유지: 이미지ID, 옥션ID가 이 이미지의 정보로 업데이트 됩니다.\n(담당자는 변경되지 않습니다. 계속하시겠습니까?)'
            : '신규교체: 입찰가담당자, 이미지ID, 옥션ID가 이 이미지의 정보로 업데이트 됩니다.\n(계속하시겠습니까?)';

        if (!confirm(msg)) return;

        showStatus('충돌 해결 중...', 'warning');

        google.script.run
            .withSuccessHandler(res => {
                if (res && res.success) {
                    showStatus(res.message || '해결되었습니다.', 'success');
                    loadSyncConflicts();
                    // 필요한 경우 물건 데이터 재로드
                    if (action === 'replace_with_new') loadData(true);
                } else {
                    showStatus(res && res.message ? res.message : '해결 실패', 'error');
                }
            })
            .withFailureHandler(err => {
                showStatus('해결 오류: ' + err.message, 'error');
            })
            .resolveSyncConflict(conflictId, action);
    }

    /**
     * 옥션 URL 설정 로드
     */
    function loadAuctionSettings() {
        if (typeof google === 'undefined') return;
        google.script.run
            .withSuccessHandler(settings => {
                document.getElementById('setting-auction-pattern').value = settings.auction_pattern || '';
                document.getElementById('setting-gongmae-pattern').value = settings.gongmae_pattern || '';
                // 캐시에 저장하여 클릭 시 사용
                auctionSettingsCache = settings;
                // 바로 미리보기 업데이트
                updateAuctionUrlPreview();
            })
            .getAuctionSettings();
    }

    /**
     * 옥션 URL 설정 실시간 미리보기 업데이트
     */
    function updateAuctionUrlPreview() {
        const auctionPattern = document.getElementById('setting-auction-pattern').value;
        const gongmaePattern = document.getElementById('setting-gongmae-pattern').value;
        const demoId = "1234567";

        const previewAuction = document.getElementById('preview-auction-url');
        const previewGongmae = document.getElementById('preview-gongmae-url');

        if (previewAuction) {
            if (auctionPattern.includes('[ID]')) {
                previewAuction.innerHTML = "미리보기: " + auctionPattern.replace('[ID]', `<b>${demoId}</b>`);
                previewAuction.classList.replace('text-gray-400', 'text-blue-600');
            } else {
                previewAuction.innerHTML = "⚠ [ID]를 입력해 주세요.";
                previewAuction.classList.replace('text-blue-600', 'text-gray-400');
            }
        }

        if (previewGongmae) {
            if (gongmaePattern.includes('[ID]')) {
                previewGongmae.innerHTML = "미리보기: " + gongmaePattern.replace('[ID]', `<b>${demoId}</b>`);
                previewGongmae.classList.replace('text-gray-400', 'text-blue-600');
            } else {
                previewGongmae.innerHTML = "⚠ [ID]를 입력해 주세요.";
                previewGongmae.classList.replace('text-blue-600', 'text-gray-400');
            }
        }
    }

    let auctionSettingsCache = { auction_pattern: '', gongmae_pattern: '' };

    /**
     * 옥션 URL 설정 저장
     */
    function handleSaveAuctionSettings() {
        const auction = document.getElementById('setting-auction-pattern').value;
        const gongmae = document.getElementById('setting-gongmae-pattern').value;

        showStatus("설정 저장 중...", "info");
        google.script.run
            .withSuccessHandler(result => {
                showStatus(result.message, "success");
                auctionSettingsCache = { auction_pattern: auction, gongmae_pattern: gongmae };
            })
            .withFailureHandler(err => {
                showStatus("저장 실패: " + err.message, "error");
            })
            .saveAuctionSettings({ auction_pattern: auction, gongmae_pattern: gongmae });
    }

    // 전송 컬럼 강제 제거 함수
    // - 문제 원인: 실제 DOM은 `.item-list-table`이 아닐 수 있음 (사용자 selector 기준)
    // - 해결: `#listPane` 내부의 테이블을 기준으로 전송 컬럼/셀을 무조건 제거
    function removeSendColumn() {
        const root = document.getElementById('listPane') || document;
        const tables = Array.from(root.querySelectorAll('table'));

        // listPane 안에 테이블이 없을 때도, 혹시 모를 직접 selector 처리
        const forceRemoveNodes = (scope) => {
            Array.from(scope.querySelectorAll('th.item-col-action, td.item-col-action')).forEach(n => {
                try { n.remove(); } catch (e) { }
            });
            Array.from(scope.querySelectorAll('thead th')).forEach(th => {
                if (String(th.textContent || '').trim() === '전송') {
                    try { th.remove(); } catch (e) { }
                }
            });
        };

        tables.forEach(table => {
            forceRemoveNodes(table);

            // 헤더가 8개를 초과하면 9번째부터 잘라내기 (담당 컬럼까지 8개 유지)
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                while (headerRow.children && headerRow.children.length > 8) {
                    try { headerRow.removeChild(headerRow.children[8]); } catch (e) { break; }
                }
            }

            // 바디 행도 8개 초과 셀 제거
            const bodyRows = Array.from(table.querySelectorAll('tbody tr'));
            bodyRows.forEach(row => {
                // item-col-action을 우선 제거
                Array.from(row.querySelectorAll('td.item-col-action, th.item-col-action')).forEach(n => {
                    try { n.remove(); } catch (e) { }
                });
                // 남아있으면 9번째 이상을 강제로 자름 (담당 컬럼까지 8개 유지)
                while (row.cells && row.cells.length > 8) {
                    try { row.deleteCell(8); } catch (e) { break; }
                }
            });
        });

        // 사용자 제공 selector 케이스를 직접 타격
        forceRemoveNodes(document);

        // 로딩 메시지 row의 colspan이 깨졌을 수 있어 보정
        const firstRowTd = document.querySelector('#dataTableBody tr td[colspan]');
        if (firstRowTd) {
            firstRowTd.setAttribute('colspan', '8');
        }
    }

    // =============================================================================
    // 회원명 자동완성 관련 함수
    // =============================================================================

    // [NEW] 커스텀 회원명 자동검색(위/아래/탭 선택) 상태
    const MEMBER_AC_STATE = {
        main: { open: false, items: [], activeIndex: 0, container: null, anchor: null, programmatic: false },
        modal: { open: false, items: [], activeIndex: 0, container: null, anchor: null, programmatic: false }
    };

    function getMemberDataSource_() {
        if (typeof allMembersNewData !== 'undefined' && Array.isArray(allMembersNewData) && allMembersNewData.length > 0) return allMembersNewData;
        if (typeof allMembersData !== 'undefined' && Array.isArray(allMembersData) && allMembersData.length > 0) return allMembersData;
        if (typeof allMemberData !== 'undefined' && Array.isArray(allMemberData) && allMemberData.length > 0) return allMemberData;
        return [];
    }

    function getMemberName_(m) {
        return String(m.member_name || m.name || '').trim();
    }

    function getMemberById_(memberId) {
        const id = String(memberId || '').trim();
        if (!id) return null;
        const members = getMemberDataSource_();
        return members.find(m => String(m.member_id || '').trim() === id) || null;
    }

    function ensureMemberAcContainer_(targetType) {
        const st = MEMBER_AC_STATE[targetType];
        if (st.container) return st.container;
        const el = document.createElement('div');
        el.id = `member-ac-${targetType}`;
        el.style.position = 'absolute';
        el.style.zIndex = '99999';
        el.style.display = 'none';
        el.className = 'bg-white border border-gray-200 rounded-lg shadow-lg overflow-auto';
        el.setAttribute('role', 'listbox');
        el.addEventListener('mousedown', (e) => {
            // 클릭 시 input blur 방지
            e.preventDefault();
        });
        document.body.appendChild(el);
        st.container = el;
        return el;
    }

    function positionMemberAc_(targetType) {
        const st = MEMBER_AC_STATE[targetType];
        if (!st.open || !st.container || !st.anchor) return;
        const r = st.anchor.getBoundingClientRect();
        st.container.style.left = `${Math.max(8, r.left + window.scrollX)}px`;
        st.container.style.top = `${r.bottom + window.scrollY + 4}px`;
        st.container.style.width = `${Math.max(240, r.width)}px`;
        st.container.style.maxHeight = '240px';
    }

    function closeMemberAc_(targetType) {
        const st = MEMBER_AC_STATE[targetType];
        st.open = false;
        st.items = [];
        st.activeIndex = 0;
        if (st.container) st.container.style.display = 'none';
    }

    function renderMemberAc_(targetType) {
        const st = MEMBER_AC_STATE[targetType];
        const box = ensureMemberAcContainer_(targetType);
        if (!st.items || st.items.length === 0) {
            closeMemberAc_(targetType);
            return;
        }
        let html = '';
        st.items.forEach((it, idx) => {
            const active = idx === st.activeIndex;
            const baseCls = 'px-3 py-2 text-sm cursor-pointer select-none flex items-center justify-between';
            const activeCls = active ? 'bg-indigo-100 active-item' : 'hover:bg-indigo-50';
            const leftCls = it.kind === 'myungui' ? 'pl-6 text-gray-700' : 'text-gray-900 font-medium';
            const right = it.rightText ? `<span class="ml-3 text-xs text-gray-400">${escapeHtml(it.rightText)}</span>` : '';
            html += `
                <div data-idx="${idx}" class="${baseCls} ${activeCls}">
                    <span class="${leftCls}">${escapeHtml(it.displayText)}</span>
                    ${right}
                </div>
            `;
        });
        box.innerHTML = html;
        box.style.display = 'block';
        positionMemberAc_(targetType);

        // [Fix] 키보드 이동 시 자동 스크롤
        const activeNode = box.querySelector('.active-item');
        if (activeNode) {
            activeNode.scrollIntoView({ block: 'nearest', behavior: 'auto' });
        }

        Array.from(box.querySelectorAll('[data-idx]')).forEach(node => {
            // 마우스 이동 시 activeIndex 업데이트 (키보드와 충돌 방지 위해 약간의 조건 추가 가능하지만 단순화)
            node.addEventListener('mouseenter', () => {
                // 프로그램적 스크롤 중에는 mouseenter 무시 방지 등을 할 수도 있으나,
                // 여기선 사용자가 마우스를 움직이면 그쪽으로 포커스 이동
                const idx = parseInt(node.getAttribute('data-idx'), 10);
                if (!Number.isNaN(idx)) {
                    // 렌더링 루프 방지를 위해 index가 다를 때만 재렌더링
                    if (st.activeIndex !== idx) {
                        st.activeIndex = idx;
                        // 마우스 호버는 재렌더링 없이 클래스만 바꾸는게 성능상 좋지만, 
                        // 기존 구조 유지를 위해 그대로 두되, 스크롤 튐 방지는 scrollIntoView가 처리
                        renderMemberAc_(targetType);
                    }
                }
            });
            node.addEventListener('click', (e) => {
                // 이벤트 버블링 방지
                e.stopPropagation();
                const idx = parseInt(node.getAttribute('data-idx'), 10);
                if (!Number.isNaN(idx)) {
                    st.activeIndex = idx;
                    applyMemberAcSelection_(targetType, { moveFocusNext: true });
                }
            });
        });
    }

    function buildMemberAcItems_(queryRaw) {
        const q = String(queryRaw || '').trim().toLowerCase();
        if (!q) return [];
        const members = getMemberDataSource_();
        if (!members || members.length === 0) return [];

        const matches = members
            .map(m => ({ m, name: getMemberName_(m) }))
            .filter(x => x.name && x.name.toLowerCase().includes(q))
            .slice(0, 20);

        if (matches.length === 0) return [];

        // 정확히 1명만 "이름 완전 일치"하면 → 그 회원의 명의까지 펼쳐서 표시
        const exact = matches.filter(x => x.name.toLowerCase() === q);
        if (exact.length === 1) {
            const m = exact[0].m;
            const baseName = getMemberName_(m);
            const list = [];
            list.push({
                kind: 'base',
                member_id: m.member_id,
                baseName,
                displayText: baseName,
                inputValue: baseName
            });
            const addMy = (gubunKey, nameKey) => {
                const nm = String(m[nameKey] || '').trim();
                if (!nm) return;
                const gb = String(m[gubunKey] || '').trim();
                const display = gb ? `(${gb}) ${nm}` : nm;
                const input = gb ? `${baseName} (${gb}) ${nm}` : `${baseName} ${nm}`;
                list.push({
                    kind: 'myungui',
                    member_id: m.member_id,
                    baseName,
                    displayText: display,
                    inputValue: input
                });
            };
            addMy('name1_gubun', 'name1');
            addMy('name2_gubun', 'name2');
            addMy('name3_gubun', 'name3');
            return list;
        }

        // 여러 명 매칭이면 → 회원명만 나열 (기본 커서는 첫 줄)
        return matches.map(x => ({
            kind: 'base',
            member_id: x.m.member_id,
            baseName: x.name,
            displayText: x.name,
            inputValue: x.name,
            rightText: x.m.member_id ? `ID:${x.m.member_id}` : ''
        }));
    }

    // --- [Court Autocomplete] State & Helpers ---
    const COURT_AC_STATE = {
        main: { open: false, items: [], activeIndex: 0, container: null, anchor: null, programmatic: false },
        modal: { open: false, items: [], activeIndex: 0, container: null, anchor: null, programmatic: false }
    };

    function ensureCourtAcContainer_(targetType) {
        const inputEl = targetType === 'modal' ? document.getElementById('modal-form-court') : document.getElementById('form-court');
        if (!inputEl) return;
        let container = document.getElementById('court-ac-container-' + targetType);
        if (!container) {
            container = document.createElement('ul');
            container.id = 'court-ac-container-' + targetType;
            container.className = 'absolute z-50 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto text-sm hidden';
            document.body.appendChild(container);
            COURT_AC_STATE[targetType].container = container;
        }
    }

    function positionCourtAc_(targetType) {
        const st = COURT_AC_STATE[targetType];
        if (!st.open || !st.container || !st.anchor) return;
        const rect = st.anchor.getBoundingClientRect();
        st.container.style.top = (rect.bottom + window.scrollY) + 'px';
        st.container.style.left = (rect.left + window.scrollX) + 'px';
        st.container.style.width = rect.width + 'px';
        st.container.classList.remove('hidden');
    }

    function closeCourtAc_(targetType) {
        const st = COURT_AC_STATE[targetType];
        st.open = false;
        if (st.container) st.container.classList.add('hidden');
    }

    function renderCourtAc_(targetType) {
        const st = COURT_AC_STATE[targetType];
        if (!st.container) ensureCourtAcContainer_(targetType);
        if (!st.open || st.items.length === 0) {
            closeCourtAc_(targetType);
            return;
        }
        positionCourtAc_(targetType);

        st.container.innerHTML = st.items.map((item, idx) => {
            const activeClass = (idx === st.activeIndex) ? 'bg-indigo-100 text-indigo-900' : 'text-gray-700 hover:bg-gray-100';
            return `<li class="cursor-pointer px-4 py-2 ${activeClass}" data-idx="${idx}">${item}</li>`;
        }).join('');

        // 마우스 이벤트 연결
        Array.from(st.container.children).forEach(li => {
            li.addEventListener('mousedown', (e) => {
                e.preventDefault(); // 블러 방지
                const idx = parseInt(li.getAttribute('data-idx'), 10);
                st.activeIndex = idx;
                applyCourtAcSelection_(targetType);
            });
        });

        // 스크롤 처리
        const activeLi = st.container.children[st.activeIndex];
        if (activeLi) {
            activeLi.scrollIntoView({ block: 'nearest' });
        }
    }

    function buildCourtAcItems_(queryRaw) {
        const query = (queryRaw || '').trim().toLowerCase();
        let list = courtListCache || [];
        // COURT_CODES가 있다면 우선 사용, 없으면 캐시 사용 (현재 courtListCache 사용)

        if (!query) return list; // 전체 목록 (필요하면 제한)
        return list.filter(c => c.toLowerCase().includes(query));
    }

    function applyCourtAcSelection_(targetType, opts = {}) {
        const st = COURT_AC_STATE[targetType];
        const inputEl = targetType === 'modal' ? document.getElementById('modal-form-court') : document.getElementById('form-court');
        if (!inputEl || !st.items || st.items.length === 0) return;

        const val = st.items[Math.max(0, Math.min(st.activeIndex, st.items.length - 1))];
        if (!val) return;

        st.programmatic = true;
        inputEl.value = val;
        st.programmatic = false;

        closeCourtAc_(targetType);
        if (opts.moveFocusNext) focusNextField_(inputEl);
    }

    function bindCourtAutocomplete_(targetType) {
        const inputEl = targetType === 'modal'
            ? document.getElementById('modal-form-court')
            : document.getElementById('form-court');

        if (!inputEl) return;

        inputEl.setAttribute('autocomplete', 'off');
        inputEl.setAttribute('spellcheck', 'false');

        ensureCourtAcContainer_(targetType);
        const st = COURT_AC_STATE[targetType];

        const openWithCurrent = () => {
            st.anchor = inputEl;
            const items = buildCourtAcItems_(inputEl.value);
            st.items = items;
            st.activeIndex = 0;
            st.open = items.length > 0;
            renderCourtAc_(targetType);
        };

        inputEl.addEventListener('input', () => {
            if (st.programmatic) return;
            openWithCurrent();
        });

        inputEl.addEventListener('focus', () => {
            openWithCurrent();
        });

        inputEl.addEventListener('blur', () => {
            setTimeout(() => { closeCourtAc_(targetType); }, 200);
        });

        inputEl.addEventListener('keydown', (e) => {
            const isOpen = st.open && st.items.length > 0;
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                if (!isOpen) { openWithCurrent(); return; }
                e.preventDefault();
                if (e.key === 'ArrowDown') st.activeIndex = (st.activeIndex + 1) % st.items.length;
                else st.activeIndex = (st.activeIndex - 1 + st.items.length) % st.items.length;
                st.open = true;
                renderCourtAc_(targetType);
                return;
            }
            if (e.key === 'Enter') {
                if (isOpen) {
                    e.preventDefault();
                    applyCourtAcSelection_(targetType, { moveFocusNext: true });
                }
                return;
            }
            if (e.key === 'Escape') {
                if (isOpen) {
                    e.preventDefault();
                    closeCourtAc_(targetType);
                }
                return;
            }
            if (e.key === 'Tab' && !e.shiftKey) {
                if (isOpen) {
                    e.preventDefault();
                    applyCourtAcSelection_(targetType, { moveFocusNext: true });
                }
            }
        });
    }

    function focusNextField_(inputEl) {
        try {
            const root = inputEl && inputEl.form ? inputEl.form : document;
            const focusables = Array.from(root.querySelectorAll('input, select, textarea, button, [tabindex]'))
                .filter(el => el && !el.disabled && el.tabIndex !== -1 && el.offsetParent !== null);
            const idx = focusables.indexOf(inputEl);
            if (idx >= 0 && idx < focusables.length - 1) {
                focusables[idx + 1].focus();
            }
        } catch (e) { }
    }

    function applyMemberAcSelection_(targetType, opts = {}) {
        const st = MEMBER_AC_STATE[targetType];
        const inputEl = targetType === 'modal'
            ? document.getElementById('modal-form-m-name')
            : document.getElementById('form-m-name');
        const memberIdEl = targetType === 'modal'
            ? document.getElementById('modal-form-member-id')
            : document.getElementById('form-member-id');

        if (!inputEl || !memberIdEl || !st.items || st.items.length === 0) return;

        const it = st.items[Math.max(0, Math.min(st.activeIndex, st.items.length - 1))];
        if (!it) return;

        st.programmatic = true;
        inputEl.value = it.inputValue || '';
        memberIdEl.value = it.member_id || '';

        inputEl.dataset.memberBaseName = it.baseName || '';
        inputEl.dataset.memberDisplay = it.inputValue || '';
        st.programmatic = false;

        closeMemberAc_(targetType);
        // 선택 즉시 member_id 기반으로 우측 정보(토큰/명의/텔레그램) 갱신
        updateMemberTokenInfo(targetType);

        if (opts.moveFocusNext) {
            focusNextField_(inputEl);
        }
    }

    // 회원명 datalist 업데이트 (명의 정보 포함)
    function updateMemberNameDatalist() {
        const datalist = document.getElementById('member-name-with-myungui-datalist');
        if (!datalist) return;

        // 새 회원 데이터(allMembersNewData)가 있으면 우선 사용, 없으면 기존 데이터 사용
        let members = [];
        if (allMembersNewData && allMembersNewData.length > 0) {
            members = allMembersNewData;
        } else if (allMembersData && allMembersData.length > 0) {
            members = allMembersData;
        }

        if (members.length === 0) {
            datalist.innerHTML = '';
            return;
        }

        let options = [];
        members.forEach(m => {
            const name = m.member_name || m.name || '';
            if (!name || !String(name).trim()) return;

            // 본인 이름 추가
            options.push(`<option value="${String(name).trim()}">${String(name).trim()}</option>`);

            // 명의1 추가
            if (m.name1 && String(m.name1).trim()) {
                const myungui1 = `${String(m.name1).trim()}`;
                options.push(`<option value="${myungui1}">└ 명의1: ${m.name1_gubun || ''} - ${myungui1}</option>`);
            }

            // 명의2 추가
            if (m.name2 && String(m.name2).trim()) {
                const myungui2 = `${String(m.name2).trim()}`;
                options.push(`<option value="${myungui2}">└ 명의2: ${m.name2_gubun || ''} - ${myungui2}</option>`);
            }

            // 명의3 추가
            if (m.name3 && String(m.name3).trim()) {
                const myungui3 = `${String(m.name3).trim()}`;
                options.push(`<option value="${myungui3}">└ 명의3: ${m.name3_gubun || ''} - ${myungui3}</option>`);
            }
        });

        datalist.innerHTML = options.join('');
    }

    // 회원명 입력 시 회원 정보 자동 설정
    function updateMemberTokenInfo(targetType = 'main') {
        const formMName = targetType === 'modal'
            ? document.getElementById('modal-form-m-name')
            : document.getElementById('form-m-name');
        if (!formMName) return;

        const selectedName = String(formMName.value || '').trim();
        const formMemberId = targetType === 'modal'
            ? document.getElementById('modal-form-member-id')
            : document.getElementById('form-member-id');
        const selectedMemberId = formMemberId ? String(formMemberId.value || '').trim() : '';

        // 표시용 엘리먼트들
        const displayMemberId = targetType === 'modal'
            ? document.getElementById('modal-display-member-id')
            : document.getElementById('display-member-id');
        const displayMemberMyungui = targetType === 'modal'
            ? document.getElementById('modal-display-member-myungui')
            : document.getElementById('display-member-myungui');

        if (!selectedName) {
            // 이름이 비어있으면 초기화
            if (formMemberId) formMemberId.value = '';

            const tokenField = document.getElementById('item-detail-member-token');
            if (tokenField) tokenField.value = '';

            if (displayMemberId) displayMemberId.textContent = '';
            if (displayMemberMyungui) displayMemberMyungui.textContent = '';

            // 물건그랩경보 초기화
            if (targetType === 'main') {
                const telegramUsername = document.getElementById('form-telegram-username');
                const memberTokenDisplay = document.getElementById('form-member-token-display');
                const telegramChatId = document.getElementById('form-telegram-chat-id');
                if (telegramUsername) telegramUsername.textContent = '-';
                if (memberTokenDisplay) memberTokenDisplay.textContent = '-';
                if (telegramChatId) telegramChatId.textContent = '-';
            } else {
                const telegramUsername = document.getElementById('modal-telegram-username');
                const memberTokenDisplay = document.getElementById('modal-member-token-display');
                const telegramChatId = document.getElementById('modal-telegram-chat-id');
                if (telegramUsername) telegramUsername.textContent = '-';
                if (memberTokenDisplay) memberTokenDisplay.textContent = '-';
                if (telegramChatId) telegramChatId.textContent = '-';
            }
            return;
        }

        // 회원 데이터에서 member_id 우선 검색 (커스텀 자동검색 대응)
        let member = selectedMemberId ? getMemberById_(selectedMemberId) : null;

        // member_id가 없으면 이름(기본명)으로만 "정확 일치"를 시도
        if (!member) {
            const baseName = String(selectedName.split('(')[0] || '').trim();
            const members = getMemberDataSource_();
            if (baseName && members && members.length > 0) {
                member = members.find(m => getMemberName_(m) === baseName) || null;
            }
        }

        if (member) {
            // member_id 설정
            if (formMemberId) {
                formMemberId.value = member.member_id || '';
            }

            // member_token 표시 (하단)
            const tokenField = document.getElementById('item-detail-member-token');
            if (tokenField) {
                tokenField.value = member.member_token || '';
            }

            // ID 정보 표시 (회원명 옆)
            if (displayMemberId) {
                displayMemberId.textContent = member.member_id ? `(ID: ${member.member_id})` : '';
            }

            // 명의 정보 표시 (박스 오른쪽)
            if (displayMemberMyungui) {
                const myunguiList = [];
                if (member.name1 && String(member.name1).trim()) {
                    myunguiList.push(`${member.name1_gubun || ''}-${member.name1}`);
                }
                if (member.name2 && String(member.name2).trim()) {
                    myunguiList.push(`${member.name2_gubun || ''}-${member.name2}`);
                }
                if (member.name3 && String(member.name3).trim()) {
                    myunguiList.push(`${member.name3_gubun || ''}-${member.name3}`);
                }

                if (myunguiList.length > 0) {
                    displayMemberMyungui.textContent = '명의: ' + myunguiList.join(', ');
                } else {
                    displayMemberMyungui.textContent = '';
                }
            }

            // 물건그랩경보 표시 (회원 텔레그램 정보)
            if (targetType === 'main') {
                const telegramUsername = document.getElementById('form-telegram-username');
                const memberTokenDisplay = document.getElementById('form-member-token-display');
                const telegramChatId = document.getElementById('form-telegram-chat-id');

                // telegram_enabled 값 표시 (없으면 N, N=N, Y=Y)
                if (telegramUsername) {
                    const enabled = member.telegram_enabled || '';
                    telegramUsername.textContent = (enabled === 'Y') ? 'Y' : 'N';
                }
                if (memberTokenDisplay) memberTokenDisplay.textContent = member.member_token || '-';
                if (telegramChatId) telegramChatId.textContent = member.telegram_chat_id || '-';
            } else {
                const telegramUsername = document.getElementById('modal-telegram-username');
                const memberTokenDisplay = document.getElementById('modal-member-token-display');
                const telegramChatId = document.getElementById('modal-telegram-chat-id');

                // telegram_enabled 값 표시 (없으면 N, N=N, Y=Y)
                if (telegramUsername) {
                    const enabled = member.telegram_enabled || '';
                    telegramUsername.textContent = (enabled === 'Y') ? 'Y' : 'N';
                }
                if (memberTokenDisplay) memberTokenDisplay.textContent = member.member_token || '-';
                if (telegramChatId) telegramChatId.textContent = member.telegram_chat_id || '-';
            }

            console.log('[회원 선택]', selectedName, '- ID:', member.member_id, '- Token:', member.member_token ? '있음' : '없음');
        } else {
            // 회원을 찾지 못한 경우
            if (formMemberId) formMemberId.value = '';
        }
    }

    function bindMemberAutocomplete_(targetType) {
        const inputEl = targetType === 'modal'
            ? document.getElementById('modal-form-m-name')
            : document.getElementById('form-m-name');
        const memberIdEl = targetType === 'modal'
            ? document.getElementById('modal-form-member-id')
            : document.getElementById('form-member-id');
        if (!inputEl || !memberIdEl) return;

        // [Fix] 브라우저 기본 자동완성/스펠첵 비활성화
        inputEl.setAttribute('autocomplete', 'off');
        inputEl.setAttribute('spellcheck', 'false');

        ensureMemberAcContainer_(targetType);

        const st = MEMBER_AC_STATE[targetType];

        const openWithCurrent = () => {
            st.anchor = inputEl;
            const items = buildMemberAcItems_(inputEl.value);
            st.items = items;
            // 리스트가 열릴 때 기존에 선택된 항목이 있다면 그 위치를 찾을 수도 있겠지만,
            // 보통은 첫 번째 항목(가장 근접한 검색결과)을 가리키는 것이 자연스러움
            st.activeIndex = 0;
            st.open = items.length > 0;
            renderMemberAc_(targetType);
        };

        inputEl.addEventListener('input', () => {
            if (st.programmatic) return;
            // 사용자가 타이핑하면 기존 member_id는 무조건 해제(스테일 방지)
            memberIdEl.value = '';
            openWithCurrent();
        });

        inputEl.addEventListener('focus', () => {
            // 포커스 시에도 자동완성 열기
            openWithCurrent();
        });

        inputEl.addEventListener('blur', () => {
            // 클릭 선택을 위해 살짝 지연 후 닫기
            // 상호작용(mousedown)이 있으면 blur 처리가 무시되거나(전파방지) 순서가 보장되어야 함
            setTimeout(() => {
                closeMemberAc_(targetType);
            }, 200);
        });

        inputEl.addEventListener('keydown', (e) => {
            const st = MEMBER_AC_STATE[targetType];
            const isOpen = st.open && st.items && st.items.length > 0;

            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                if (!isOpen) {
                    // 닫혀있으면 열기
                    openWithCurrent();
                    return;
                }
                e.preventDefault(); // 커서 이동 방지

                if (e.key === 'ArrowDown') st.activeIndex = (st.activeIndex + 1) % st.items.length;
                else st.activeIndex = (st.activeIndex - 1 + st.items.length) % st.items.length;

                st.open = true;
                renderMemberAc_(targetType);
                return;
            }

            if (e.key === 'Tab' && !e.shiftKey) {
                if (isOpen) {
                    // 탭 = 선택 + 다음 필드로
                    e.preventDefault();
                    applyMemberAcSelection_(targetType, { moveFocusNext: true });
                }
                return;
            }

            if (e.key === 'Enter') {
                if (isOpen) {
                    e.preventDefault();
                    // 엔터는 폼 제출 방지하고 선택만 수행
                    applyMemberAcSelection_(targetType, { moveFocusNext: true });
                } else {
                    // 리스트가 없을 때 엔터: 그냥 폼 제출로 넘어가지 않도록(필요시) 방어
                    // 여기선 기본 동작 허용(수동 입력)
                }
                return;
            }

            if (e.key === 'Escape') {
                if (isOpen) {
                    e.preventDefault();
                    closeMemberAc_(targetType);
                }
                return;
            }
        });
    }

    // [UPDATED] 저장 시 DB에 들어갈 m_name은 입력 필드의 전체 값 (명의 정보 포함)
    function getBaseMemberNameForSave_(targetType) {
        const inputEl = targetType === 'modal'
            ? document.getElementById('modal-form-m-name')
            : document.getElementById('form-m-name');

        // 입력 필드에 표시된 전체 문자열을 그대로 반환
        // 예: "이정우 (MJ) 한한한"
        const raw = String(inputEl ? inputEl.value : '').trim();
        return raw;
    }

    function getMemberName2ForSave_(targetType) {
        const el = targetType === 'modal'
            ? document.getElementById('modal-form-m-name2')
            : document.getElementById('form-m-name2');
        return String(el ? el.value : '').trim();
    }

    // 회원이 없을 때 처리 함수
    function handleMemberNotFound(memberName) {
        if (!memberName) return;

        // 회원 정보 초기화
        const formMemberId = document.getElementById('form-member-id');
        if (formMemberId) formMemberId.value = '';

        const tokenField = document.getElementById('item-detail-member-token');
        if (tokenField) tokenField.value = '';

        const displayMemberId = document.getElementById('display-member-id');
        if (displayMemberId) displayMemberId.textContent = '';

        // 확인 팝업 표시
        if (confirm(`"${memberName}"은(는) 등록된 회원이 아닙니다.\n\n회원을 등록하시겠습니까?`)) {
            // 회원 관리 탭으로 이동
            navigateTo('MemberManagement');

            // 약간의 지연 후 회원명 입력 필드에 포커스 및 값 설정
            setTimeout(() => {
                // MemberManagement 폼 필드: showMemberForm('create') 호출 필요 가능성 있음
                // 하지만 이미 목록/폼이 있을 수 있으므로 바로 접근 시도

                // 만약 현재 'create' 모드가 아니라면 전환 필요
                showMemberForm('create');

                // 약간의 지연 후 값 입력
                setTimeout(() => {
                    const memberNameInput = document.getElementById('mem-name'); // MemberManagement의 이름 필드 ID 확인 필요
                    if (memberNameInput) {
                        memberNameInput.value = memberName;
                        memberNameInput.focus();
                        memberNameInput.select();
                    }
                }, 100);
            }, 300);
        } else {
            // 입력 필드 초기화
            const formMName = document.getElementById('form-m-name');
            if (formMName) formMName.value = '';
        }
    }


    // --- [7] 앱 초기 실행 ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof initMemberDOM === 'function') {
            initMemberDOM();
        }

        // 전송 컬럼 제거 (초기화 시 - 여러 번 실행)
        removeSendColumn();
        setTimeout(removeSendColumn, 10);
        setTimeout(removeSendColumn, 50);
        setTimeout(removeSendColumn, 100);
        setTimeout(removeSendColumn, 500);
        setTimeout(removeSendColumn, 1000);

        // MutationObserver로 DOM 변경 감지하여 전송 컬럼 제거
        const observer = new MutationObserver(function (mutations) {
            removeSendColumn();
        });
        const observeTarget = document.getElementById('listPane') || document.body;
        if (observeTarget) observer.observe(observeTarget, { childList: true, subtree: true });
        // 법원명 입력 필드에 동적 필터링 적용 (입력값 포함 항목 계속 표시)
        // 법원명 입력 필드에 커스텀 자동완성 적용
        if (formCourt) {
            bindCourtAutocomplete_('main');
        }
        if (modalFormCourt) {
            bindCourtAutocomplete_('modal');
        }

        // 회원명 입력 시 회원 토큰 자동 표시
        if (formMName) {
            // 커스텀 자동검색 바인딩 (키보드/탭)
            bindMemberAutocomplete_('main');
            formMName.addEventListener('blur', () => updateMemberTokenInfo('main'));
        }

        // 모달 회원명 입력 시 처리
        if (modalFormMName) {
            bindMemberAutocomplete_('modal');
            modalFormMName.addEventListener('blur', () => updateMemberTokenInfo('modal'));
        }

        // 담당자 선택 필드에서 엔터키로 등록
        if (formMNameId) {
            formMNameId.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleFormSubmit();
                }
            });
        }

        // 드롭다운 위치 보정(스크롤/리사이즈)
        window.addEventListener('scroll', () => {
            positionMemberAc_('main');
            positionMemberAc_('modal');
            positionCourtAc_('main');
            positionCourtAc_('modal');
        }, true);
        window.addEventListener('resize', () => {
            positionMemberAc_('main');
            positionMemberAc_('modal');
            positionCourtAc_('main');
            positionCourtAc_('modal');
        });

        // 초기화를 requestAnimationFrame으로 지연하여 DOM이 완전히 준비된 후 실행
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                applyMemberViewUiGuards_();

                // 회원 데이터 자동 로드 (입찰물건 등록 시 회원 자동검색용 - 새 구조 우선)
                if (!IS_MEMBER_VIEW && typeof google !== 'undefined' && google.script && google.script.run) {
                    try {
                        // 새 회원 데이터 구조 우선 로드 (등록된 회원만 자동검색에 표시)
                        google.script.run
                            .withSuccessHandler(data => {
                                allMembersNewData = Array.isArray(data) ? data : [];
                                console.log('[초기화] 신규 회원 데이터 로드 완료:', allMembersNewData.length, '명');
                                // datalist 업데이트 (등록된 회원만 표시 - 신규 포맷)
                                updateMemberNameDatalistNew();
                            })
                            .withFailureHandler(err => {
                                console.error('[초기화] 신규 회원 데이터 로드 실패:', err.message);
                                // 실패 시 기존 함수로 폴백
                                google.script.run
                                    .withSuccessHandler(data => {
                                        allMembersData = Array.isArray(data) ? data : [];
                                        updateMemberNameDatalistNew();
                                    })
                                    .readAllMembers();
                            })
                            .readAllMembersNew();
                    } catch (e) {
                        console.error('[초기화] 회원 데이터 로드 오류:', e);
                    }
                }

                if (IS_MEMBER_VIEW) {
                    // 회원 전용 링크: 이전 세션(관리자) 캐시가 남아있으면 전체 데이터가 보일 수 있어 초기화
                    try {
                        allBiddingData = [];
                        dataCache = { data: null, timestamp: 0 };
                    } catch (e) { }

                    // [추가] 불필요한 버튼 숨기기
                    const hideIds = ['btnFetchResetCalendar', 'btnFetchRefreshCalendar', 'btnFetchResetItems', 'btnFetchRefreshItems'];
                    hideIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('content-hidden');
                    });

                    navigateTo('BiddingSchedule');
                    // 회원은 월별만
                    try { switchCalendarTab('month'); } catch (e) { }
                    // 토큰 기반으로 강제 재로딩
                    try { loadDataAndRenderCalendar(true); } catch (e) { }
                } else {
                    navigateTo('Dashboard');
                }

                // 옥션 설정 로드
                loadAuctionSettings();
            });
        });

        // 입찰일정 > 월별/월별(법원): '대표님(담당자 조회)' 드롭다운과 날짜표시 간격 확보
        syncCalendarMonthNavOffset();
        setTimeout(syncCalendarMonthNavOffset, 50);
        setTimeout(syncCalendarMonthNavOffset, 300);
        window.addEventListener('resize', syncCalendarMonthNavOffset);
    });

    // ================================================================================================
    // [신규 회원관리 / 수업관리 / 수업회차] JavaScript 함수들
    // ================================================================================================

    // --- 전역 변수 ---
    let allMembersNewData = [];
    let allClassesData = [];
    let allClassD1Data = [];
    let classDropdownOptions = { class_types: [], class_names: [], class_grades: [], class_locs: [] };
    let memberSortKey = 'member_id';
    let memberSortAsc = false;
    let classSortKey = 'class_id';
    let classSortAsc = false;
    let selectedClassId = null;
    let selectedClassD1Id = null;
    let d1MembersData = [];

    // --- 회원관리 (신규) 함수들 ---

    function loadMembersNew() {
        const tbody = document.getElementById('memberDataTableBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">데이터를 불러오는 중...</td></tr>';

        google.script.run
            .withSuccessHandler(data => {
                allMembersNewData = Array.isArray(data) ? data : [];
                loadClassDropdownOptions();
                filterMembersNew();
            })
            .withFailureHandler(err => {
                showStatus('회원 데이터 로드 실패: ' + err.message, 'error');
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">로드 실패</td></tr>';
            })
            .readAllMembersNew();
    }

    function loadClassDropdownOptions() {
        google.script.run
            .withSuccessHandler(opts => {
                classDropdownOptions = opts || { class_types: [], class_names: [], class_grades: [], class_locs: [] };
                updateMemberSearchDropdowns();
                updateClassSearchDropdowns();
                updateClassScheduleDropdowns();
                loadClassSelectForMember();
            })
            .withFailureHandler(err => console.error('드롭다운 옵션 로드 실패:', err))
            .getClassDropdownOptions();
    }

    function updateMemberSearchDropdowns() {
        const opts = classDropdownOptions;
        fillSelectOptions('mem-search-class-type', opts.class_types, '수업구분');
        fillSelectOptions('mem-search-class-name', opts.class_names, '수업이름');
        fillSelectOptions('mem-search-class-grade', opts.class_grades, '수업등급');
        fillSelectOptions('mem-search-class-loc', opts.class_locs, '지역');
    }

    function fillSelectOptions(selectId, options, placeholder) {
        const sel = document.getElementById(selectId);
        if (!sel) return;
        sel.innerHTML = '<option value="">' + placeholder + '</option>';
        (options || []).forEach(opt => {
            sel.innerHTML += '<option value="' + escapeHtml(opt) + '">' + escapeHtml(opt) + '</option>';
        });
    }

    function filterMembersNew() {
        const nameKw = (document.getElementById('mem-search-name')?.value || '').toLowerCase();
        const phoneKw = (document.getElementById('mem-search-phone')?.value || '').replace(/[^0-9]/g, '');
        const gubunKw = document.getElementById('mem-search-gubun')?.value || '';
        const classTypeKw = document.getElementById('mem-search-class-type')?.value || '';
        const classNameKw = document.getElementById('mem-search-class-name')?.value || '';
        const classGradeKw = document.getElementById('mem-search-class-grade')?.value || '';
        const classLocKw = document.getElementById('mem-search-class-loc')?.value || '';

        // 수업 정보 매핑
        const classMap = {};
        allClassesData.forEach(c => { classMap[String(c.class_id)] = c; });

        let filtered = allMembersNewData.filter(m => {
            const name = String(m.member_name || '').toLowerCase();
            const name1 = String(m.name1 || '').toLowerCase();
            const name2 = String(m.name2 || '').toLowerCase();
            const name3 = String(m.name3 || '').toLowerCase();
            const phone = String(m.phone || '').replace(/[^0-9]/g, '');
            const gubun = String(m.gubun || '');
            const cls = classMap[String(m.class_id)] || {};

            if (nameKw && !name.includes(nameKw) && !name1.includes(nameKw) && !name2.includes(nameKw) && !name3.includes(nameKw)) return false;
            if (phoneKw && !phone.includes(phoneKw)) return false;
            if (gubunKw && gubun !== gubunKw) return false;
            if (classTypeKw && (cls.class_type || '') !== classTypeKw) return false;
            if (classNameKw && (cls.class_name || '') !== classNameKw) return false;
            if (classGradeKw && (cls.class_grade || '') !== classGradeKw) return false;
            if (classLocKw && (cls.class_loc || '') !== classLocKw) return false;
            return true;
        });

        // 정렬
        filtered.sort((a, b) => {
            let va = a[memberSortKey] || '';
            let vb = b[memberSortKey] || '';
            if (typeof va === 'number' && typeof vb === 'number') {
                return memberSortAsc ? va - vb : vb - va;
            }
            return memberSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });

        renderMemberListNew(filtered, classMap);
    }

    function renderMemberListNew(members, classMap) {
        const tbody = document.getElementById('memberDataTableBody');
        if (!tbody) return;
        if (members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">데이터가 없습니다.</td></tr>';
            return;
        }
        tbody.innerHTML = members.map(m => {
            const cls = classMap[String(m.class_id)] || {};
            return `<tr class="cursor-pointer hover:bg-indigo-50" onclick="selectMemberNew('${m.member_id}')">
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(m.member_id)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(m.gubun)}</td>
                <td class="px-2 py-2 text-center text-xs font-medium">${escapeHtml(m.member_name)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(m.phone)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(cls.class_type || '')}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(cls.class_name || '')}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(cls.class_loc || '')}</td>
            </tr>`;
        }).join('');
    }

    function sortMemberList(key) {
        if (memberSortKey === key) {
            memberSortAsc = !memberSortAsc;
        } else {
            memberSortKey = key;
            memberSortAsc = true;
        }
        filterMembersNew();
    }

    function resetMemberSearch() {
        ['mem-search-name', 'mem-search-phone'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        ['mem-search-gubun', 'mem-search-class-type', 'mem-search-class-name', 'mem-search-class-grade', 'mem-search-class-loc'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        filterMembersNew();
    }

    function loadClassSelectForMember() {
        google.script.run
            .withSuccessHandler(data => {
                allClassesData = Array.isArray(data) ? data : [];
                const sel = document.getElementById('mem-class_id_select');
                if (sel) {
                    sel.innerHTML = '<option value="">수업 선택</option>';
                    allClassesData.forEach(c => {
                        sel.innerHTML += `<option value="${c.class_id}">${escapeHtml(c.class_type)} - ${escapeHtml(c.class_name)} (${escapeHtml(c.class_loc)})</option>`;
                    });
                }
            })
            .withFailureHandler(err => console.error('수업 목록 로드 실패:', err))
            .readAllClasses();
    }

    function onMemberClassSelect() {
        const classId = document.getElementById('mem-class_id_select')?.value || '';
        document.getElementById('mem-class_id').value = classId;

        const cls = allClassesData.find(c => String(c.class_id) === classId) || {};
        document.getElementById('mem-class_type_display').innerHTML = `<option>${escapeHtml(cls.class_type || '-')}</option>`;
        document.getElementById('mem-class_loc_display').value = cls.class_loc || '';
    }

    function selectMemberNew(memberId) {
        const member = allMembersNewData.find(m => String(m.member_id) === String(memberId));
        if (!member) return;
        showMemberFormNew('edit', member);
    }

    function showMemberFormNew(mode, member) {
        const form = document.getElementById('memberForm');
        const title = document.getElementById('memberFormTitle');
        const btnCreate = document.getElementById('btnCreateMember');
        const btnUpdate = document.getElementById('btnUpdateMember');
        const btnDelete = document.getElementById('btnDeleteMember');
        const btnBack = document.getElementById('btnGoBackToCreate');

        if (mode === 'create') {
            title.textContent = '새 회원 등록';
            form.reset();
            document.getElementById('mem-member_id').value = '';
            btnCreate.classList.remove('content-hidden');
            btnUpdate.classList.add('content-hidden');
            btnDelete.classList.add('content-hidden');
            btnBack.classList.add('content-hidden');
            document.getElementById('mem-class_type_display').innerHTML = '<option>수업 선택시 자동</option>';
            document.getElementById('mem-class_loc_display').value = '';
            document.getElementById('mem-class_id_select').value = '';
        } else {
            title.textContent = '회원 수정';
            btnCreate.classList.add('content-hidden');
            btnUpdate.classList.remove('content-hidden');
            btnDelete.classList.remove('content-hidden');
            btnBack.classList.remove('content-hidden');

            // 폼 필드 채우기
            ['member_id', 'class_id', 'gubun', 'member_name', 'name1_gubun', 'name1', 'name2_gubun', 'name2', 'name3_gubun', 'name3', 'phone', 'login_id', 'password', 'account_bank', 'account_no', 'account_name', 'address', 'note1', 'note2', 'member_token', 'telegram_chat_id', 'telegram_username', 'telegram_enabled', 'kaib_date'].forEach(key => {
                const el = document.getElementById('mem-' + key);
                if (el) el.value = member[key] || '';
            });

            // 수업 선택
            const classSelect = document.getElementById('mem-class_id_select');
            if (classSelect) classSelect.value = member.class_id || '';
            onMemberClassSelect();
        }

        // 모바일에서 상세 패널 표시
        const detailPane = document.getElementById('memberDetailPane');
        if (detailPane) detailPane.classList.remove('mobile-hidden');
    }

    function handleMemberFormSubmitNew() {
        const memberId = document.getElementById('mem-member_id')?.value || '';
        const isEdit = !!memberId;

        const data = {};
        ['member_id', 'class_id', 'gubun', 'member_name', 'name1_gubun', 'name1', 'name2_gubun', 'name2', 'name3_gubun', 'name3', 'phone', 'login_id', 'password', 'account_bank', 'account_no', 'account_name', 'address', 'note1', 'note2', 'telegram_enabled', 'kaib_date'].forEach(key => {
            data[key] = document.getElementById('mem-' + key)?.value || '';
        });

        // telegram_enabled 기본값: 값이 없으면 'N'으로 설정
        if (!data.telegram_enabled || data.telegram_enabled === '') {
            data.telegram_enabled = 'N';
        }

        if (!data.member_name || !data.gubun) {
            showStatus('이름과 구분은 필수입니다.', 'error');
            return;
        }

        const handler = result => {
            if (result.success) {
                showStatus(result.message, 'success');
                loadMembersNew();
                showMemberFormNew('create');
            } else {
                showStatus(result.message, 'error');
            }
        };

        if (isEdit) {
            google.script.run.withSuccessHandler(handler).withFailureHandler(e => showStatus(e.message, 'error')).updateMemberNew(data);
        } else {
            google.script.run.withSuccessHandler(handler).withFailureHandler(e => showStatus(e.message, 'error')).createMemberNew(data);
        }
    }

    function handleMemberDeleteNew() {
        const memberId = document.getElementById('mem-member_id')?.value;
        if (!memberId) return;
        if (!confirm('정말 삭제하시겠습니까?')) return;

        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    loadMembersNew();
                    showMemberFormNew('create');
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(e => showStatus(e.message, 'error'))
            .deleteMemberNew(memberId);
    }

    function handleRegenerateMemberTokenNew() {
        const memberId = document.getElementById('mem-member_id')?.value;
        if (!memberId) {
            showStatus('먼저 회원을 저장해주세요.', 'error');
            return;
        }
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    document.getElementById('mem-member_token').value = result.member_token || '';
                    showStatus('토큰이 재발급되었습니다.', 'success');
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(e => showStatus(e.message, 'error'))
            .regenerateMemberToken(memberId);
    }

    function copyMemberTokenNew() {
        const token = document.getElementById('mem-member_token')?.value || '';
        if (!token) { showStatus('토큰이 없습니다.', 'error'); return; }
        navigator.clipboard.writeText(token).then(() => showStatus('토큰이 복사되었습니다.', 'success'));
    }

    // --- 수업관리 함수들 ---

    function loadClasses() {
        const tbody = document.getElementById('classDataTableBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">데이터를 불러오는 중...</td></tr>';

        google.script.run
            .withSuccessHandler(data => {
                allClassesData = Array.isArray(data) ? data : [];
                loadClassDropdownOptions();
                filterClasses();
            })
            .withFailureHandler(err => {
                showStatus('수업 데이터 로드 실패: ' + err.message, 'error');
            })
            .readAllClasses();
    }

    function updateClassSearchDropdowns() {
        const opts = classDropdownOptions;
        fillSelectOptions('cls-search-type', opts.class_types, '수업구분');
        fillSelectOptions('cls-search-name', opts.class_names, '수업이름');
        fillSelectOptions('cls-search-grade', opts.class_grades, '수업등급');
        fillSelectOptions('cls-search-loc', opts.class_locs, '지역');
    }

    function filterClasses() {
        const typeKw = document.getElementById('cls-search-type')?.value || '';
        const nameKw = document.getElementById('cls-search-name')?.value || '';
        const gradeKw = document.getElementById('cls-search-grade')?.value || '';
        const locKw = document.getElementById('cls-search-loc')?.value || '';

        let filtered = allClassesData.filter(c => {
            if (typeKw && c.class_type !== typeKw) return false;
            if (nameKw && c.class_name !== nameKw) return false;
            if (gradeKw && c.class_grade !== gradeKw) return false;
            if (locKw && c.class_loc !== locKw) return false;
            return true;
        });

        filtered.sort((a, b) => {
            let va = a[classSortKey] || '';
            let vb = b[classSortKey] || '';
            return classSortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });

        renderClassList(filtered);
    }

    function renderClassList(classes) {
        const tbody = document.getElementById('classDataTableBody');
        if (!tbody) return;
        if (classes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">데이터가 없습니다.</td></tr>';
            return;
        }
        tbody.innerHTML = classes.map(c => `
            <tr class="cursor-pointer hover:bg-indigo-50" onclick="selectClass('${c.class_id}')">
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_id)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_loop || '-')}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_type)}</td>
                <td class="px-2 py-2 text-center text-xs font-medium">${escapeHtml(c.class_name)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_grade)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_loc)}</td>
            </tr>
        `).join('');
    }

    function sortClassList(key) {
        if (classSortKey === key) { classSortAsc = !classSortAsc; }
        else { classSortKey = key; classSortAsc = true; }
        filterClasses();
    }

    function resetClassSearch() {
        ['cls-search-type', 'cls-search-name', 'cls-search-grade', 'cls-search-loc'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        filterClasses();
    }

    function selectClass(classId) {
        const cls = allClassesData.find(c => String(c.class_id) === String(classId));
        if (!cls) return;
        showClassForm('edit', cls);
    }

    function showClassForm(mode, cls) {
        const title = document.getElementById('classFormTitle');
        const btnCreate = document.getElementById('btnCreateClass');
        const btnUpdate = document.getElementById('btnUpdateClass');
        const btnDelete = document.getElementById('btnDeleteClass');
        const btnBack = document.getElementById('btnGoBackToCreateClass');

        if (mode === 'create') {
            title.textContent = '새 수업 등록';
            document.getElementById('classForm').reset();
            document.getElementById('cls-class_id').value = '';
            btnCreate.classList.remove('content-hidden');
            btnUpdate.classList.add('content-hidden');
            btnDelete.classList.add('content-hidden');
            btnBack.classList.add('content-hidden');
        } else {
            title.textContent = '수업 수정';
            btnCreate.classList.add('content-hidden');
            btnUpdate.classList.remove('content-hidden');
            btnDelete.classList.remove('content-hidden');
            btnBack.classList.remove('content-hidden');

            ['class_id', 'class_type', 'class_name', 'class_grade', 'class_loc', 'class_week', 'class_time_from', 'class_time_to', 'class_loop', 'class_loop_min', 'guaranteed_type', 'guaranteed_details', 'remark'].forEach(key => {
                const el = document.getElementById('cls-' + key);
                if (el) el.value = cls[key] || '';
            });
        }

        const detailPane = document.getElementById('classDetailPane');
        if (detailPane) detailPane.classList.remove('mobile-hidden');
    }

    function handleClassFormSubmit() {
        const classId = document.getElementById('cls-class_id')?.value || '';
        const isEdit = !!classId;

        const data = {};
        ['class_id', 'class_type', 'class_name', 'class_grade', 'class_loc', 'class_week', 'class_time_from', 'class_time_to', 'class_loop', 'class_loop_min', 'guaranteed_type', 'guaranteed_details', 'remark'].forEach(key => {
            data[key] = document.getElementById('cls-' + key)?.value || '';
        });

        if (!data.class_type || !data.class_name) {
            showStatus('수업구분과 수업이름은 필수입니다.', 'error');
            return;
        }

        const handler = result => {
            if (result.success) {
                showStatus(result.message, 'success');
                loadClasses();
                showClassForm('create');
            } else {
                showStatus(result.message, 'error');
            }
        };

        if (isEdit) {
            google.script.run.withSuccessHandler(handler).withFailureHandler(e => showStatus(e.message, 'error')).updateClass(data);
        } else {
            google.script.run.withSuccessHandler(handler).withFailureHandler(e => showStatus(e.message, 'error')).createClass(data);
        }
    }

    function handleClassDelete() {
        const classId = document.getElementById('cls-class_id')?.value;
        if (!classId) return;
        if (!confirm('정말 삭제하시겠습니까?')) return;

        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    loadClasses();
                    showClassForm('create');
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(e => showStatus(e.message, 'error'))
            .deleteClass(classId);
    }

    // --- 수업회차 함수들 ---

    function loadClassScheduleList() {
        google.script.run
            .withSuccessHandler(data => {
                allClassesData = Array.isArray(data) ? data : [];
                loadClassDropdownOptions();
                filterClassScheduleList();
            })
            .withFailureHandler(err => showStatus('수업 목록 로드 실패: ' + err.message, 'error'))
            .readAllClasses();
    }

    function updateClassScheduleDropdowns() {
        const opts = classDropdownOptions;
        fillSelectOptions('csd-search-type', opts.class_types, '수업구분');
        fillSelectOptions('csd-search-name', opts.class_names, '수업이름');
        fillSelectOptions('csd-search-grade', opts.class_grades, '수업등급');
        fillSelectOptions('csd-search-loc', opts.class_locs, '지역');
    }

    function filterClassScheduleList() {
        const memberKw = (document.getElementById('csd-search-member')?.value || '').toLowerCase();
        const typeKw = document.getElementById('csd-search-type')?.value || '';
        const nameKw = document.getElementById('csd-search-name')?.value || '';
        const gradeKw = document.getElementById('csd-search-grade')?.value || '';
        const locKw = document.getElementById('csd-search-loc')?.value || '';

        let filtered = allClassesData.filter(c => {
            if (typeKw && c.class_type !== typeKw) return false;
            if (nameKw && c.class_name !== nameKw) return false;
            if (gradeKw && c.class_grade !== gradeKw) return false;
            if (locKw && c.class_loc !== locKw) return false;
            return true;
        });

        renderClassScheduleList(filtered);
    }

    function renderClassScheduleList(classes) {
        const tbody = document.getElementById('classScheduleListTableBody');
        if (!tbody) return;
        if (classes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">수업이 없습니다.</td></tr>';
            return;
        }
        tbody.innerHTML = classes.map(c => `
            <tr class="cursor-pointer hover:bg-indigo-50 ${selectedClassId === c.class_id ? 'bg-indigo-100' : ''}" onclick="selectClassForSchedule('${c.class_id}')">
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_type)}</td>
                <td class="px-2 py-2 text-center text-xs font-medium">${escapeHtml(c.class_name)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_grade)}</td>
                <td class="px-2 py-2 text-center text-xs">${escapeHtml(c.class_loc)}</td>
            </tr>
        `).join('');
    }

    function selectClassForSchedule(classId) {
        selectedClassId = classId;
        selectedClassD1Id = null;
        filterClassScheduleList();
        loadClassD1Grid(classId);
    }

    function loadClassD1Grid(classId) {
        const grid = document.getElementById('classD1Grid');
        if (!grid) return;
        grid.innerHTML = '<div class="col-span-7 text-gray-400 py-2">회차를 불러오는 중...</div>';

        google.script.run
            .withSuccessHandler(data => {
                allClassD1Data = Array.isArray(data) ? data : [];
                renderClassD1Grid();
            })
            .withFailureHandler(err => {
                grid.innerHTML = '<div class="col-span-7 text-red-400 py-2">로드 실패</div>';
            })
            .readClassD1ByClassId(classId);
    }

    function renderClassD1Grid() {
        const grid = document.getElementById('classD1Grid');
        if (!grid) return;

        if (allClassD1Data.length === 0) {
            grid.innerHTML = '<div class="col-span-7 text-gray-400 py-2">회차가 없습니다. "다음회차 생성" 버튼을 눌러주세요.</div>';
            return;
        }

        grid.innerHTML = allClassD1Data.map(d => {
            const isSelected = selectedClassD1Id === d.class_d1_id;
            const isCompleted = d.completed === 'Y';
            const bgClass = isSelected ? 'bg-indigo-600 text-white' : (isCompleted ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700');
            const dateStr = d.class_date ? d.class_date.substring(4, 6) + '/' + d.class_date.substring(6, 8) : '';

            return `<div class="p-2 rounded cursor-pointer ${bgClass} hover:opacity-80" onclick="selectClassD1('${d.class_d1_id}')">
                <div class="font-bold">${d.class_loop}회</div>
                <div class="text-xs">${dateStr}</div>
                ${isCompleted ? '<div class="text-xs">✓</div>' : ''}
            </div>`;
        }).join('');
    }

    function selectClassD1(classD1Id) {
        selectedClassD1Id = classD1Id;
        renderClassD1Grid();
        loadD1Members(classD1Id);
    }

    function loadD1Members(classD1Id) {
        const tbody = document.getElementById('classD1MemberTableBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500 text-sm">회원을 불러오는 중...</td></tr>';

        google.script.run
            .withSuccessHandler(data => {
                d1MembersData = Array.isArray(data) ? data : [];
                renderD1Members();
            })
            .withFailureHandler(err => {
                if (tbody) tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-red-500 text-sm">로드 실패</td></tr>';
            })
            .readMembersByClassD1Id(classD1Id);
    }

    function renderD1Members() {
        const tbody = document.getElementById('classD1MemberTableBody');
        if (!tbody) return;

        if (d1MembersData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500 text-sm">등록된 회원이 없습니다.</td></tr>';
            return;
        }

        tbody.innerHTML = d1MembersData.map(m => `
            <tr class="cursor-pointer hover:bg-gray-50" onclick="selectD1Member('${m.detail_id}')">
                <td class="px-3 py-2 text-sm">${escapeHtml(m.member_name || '-')}</td>
                <td class="px-2 py-2 text-center text-sm">${m.attended === 'Y' ? '✓' : '-'}</td>
            </tr>
        `).join('');
    }

    function filterD1Members() {
        const kw = (document.getElementById('csd-member-search')?.value || '').toLowerCase();
        const filtered = d1MembersData.filter(m => {
            const name = String(m.member_name || '').toLowerCase();
            return name.includes(kw);
        });

        const tbody = document.getElementById('classD1MemberTableBody');
        if (!tbody) return;
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500 text-sm">검색 결과 없음</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(m => `
            <tr class="cursor-pointer hover:bg-gray-50" onclick="selectD1Member('${m.detail_id}')">
                <td class="px-3 py-2 text-sm">${escapeHtml(m.member_name || '-')}</td>
                <td class="px-2 py-2 text-center text-sm">${m.attended === 'Y' ? '✓' : '-'}</td>
            </tr>
        `).join('');
    }

    function selectD1Member(detailId) {
        const member = d1MembersData.find(m => String(m.detail_id) === String(detailId));
        if (!member) return;

        // 회원 상세 정보 표시를 위해 전체 회원 데이터에서 찾기
        const fullMember = allMembersNewData.find(m => String(m.member_id) === String(member.member_id)) || member;

        const detailPane = document.getElementById('classD1MemberDetail');
        if (detailPane) detailPane.classList.remove('content-hidden');

        ['gubun', 'phone', 'kaib_date', 'name1_gubun', 'name1', 'name2_gubun', 'name2', 'name3_gubun', 'name3'].forEach(key => {
            const el = document.getElementById('d1m-' + key);
            if (el) el.textContent = fullMember[key] || '-';
        });
        document.getElementById('d1m-name').textContent = fullMember.member_name || '-';
    }

    // 회차 생성 모달
    function showGenerateD1Modal() {
        if (!selectedClassId) {
            showStatus('먼저 수업을 선택하세요.', 'error');
            return;
        }
        document.getElementById('generateD1Modal').classList.remove('content-hidden');
        document.getElementById('genD1-startDate').value = new Date().toISOString().split('T')[0];
    }

    function closeGenerateD1Modal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('generateD1Modal').classList.add('content-hidden');
    }

    function handleGenerateD1() {
        const startDate = document.getElementById('genD1-startDate')?.value?.replace(/-/g, '') || '';
        const loopUnit = document.getElementById('genD1-loopUnit')?.value || '1';
        const loopCount = parseInt(document.getElementById('genD1-loopCount')?.value) || 10;

        if (!startDate) {
            showStatus('시작일을 입력하세요.', 'error');
            return;
        }

        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    closeGenerateD1Modal();
                    loadClassD1Grid(selectedClassId);
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(e => showStatus(e.message, 'error'))
            .generateClassD1(selectedClassId, startDate, loopUnit, loopCount);
    }

    // 회원 추가 모달
    function showAddMemberToD1Modal() {
        if (!selectedClassD1Id) {
            showStatus('먼저 회차를 선택하세요.', 'error');
            return;
        }
        document.getElementById('addMemberToD1Modal').classList.remove('content-hidden');
        loadAddMemberList();
    }

    function closeAddMemberToD1Modal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('addMemberToD1Modal').classList.add('content-hidden');
    }

    function loadAddMemberList() {
        const tbody = document.getElementById('addMemberListTableBody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500 text-sm">회원을 불러오는 중...</td></tr>';

        google.script.run
            .withSuccessHandler(data => {
                const members = Array.isArray(data) ? data : [];
                renderAddMemberList(members);
            })
            .withFailureHandler(err => {
                if (tbody) tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500 text-sm">로드 실패</td></tr>';
            })
            .getMembersForClass();
    }

    function renderAddMemberList(members) {
        const tbody = document.getElementById('addMemberListTableBody');
        if (!tbody) return;

        if (members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500 text-sm">등록된 회원이 없습니다.</td></tr>';
            return;
        }

        const kw = (document.getElementById('addD1Member-search')?.value || '').toLowerCase();
        const filtered = members.filter(m => {
            const name = String(m.member_name || '').toLowerCase();
            return name.includes(kw);
        });

        tbody.innerHTML = filtered.map(m => `
            <tr>
                <td class="px-3 py-2 text-sm">${escapeHtml(m.member_name || '-')}</td>
                <td class="px-3 py-2 text-sm text-gray-500">${escapeHtml(m.phone || '-')}</td>
                <td class="px-2 py-2 text-center">
                    <button type="button" onclick="addMemberToD1('${m.member_id}')" class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded">추가</button>
                </td>
            </tr>
        `).join('');
    }

    function filterAddMemberList() {
        loadAddMemberList();
    }

    function addMemberToD1(memberId) {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    showStatus(result.message, 'success');
                    loadD1Members(selectedClassD1Id);
                } else {
                    showStatus(result.message, 'error');
                }
            })
            .withFailureHandler(e => showStatus(e.message, 'error'))
            .addMemberToClassD1(selectedClassD1Id, memberId);
    }

    // 입찰물건관리에서 등록된 회원만 자동검색 (기존 함수 확장: 명의별 옵션 생성)
    function updateMemberNameDatalistNew() {
        const datalist = document.getElementById('member-name-with-myungui-datalist');
        if (!datalist) return;
        datalist.innerHTML = '';

        let members = [];
        if (typeof allMembersNewData !== 'undefined' && Array.isArray(allMembersNewData)) {
            members = allMembersNewData;
        } else if (typeof allMembersData !== 'undefined' && Array.isArray(allMembersData)) {
            members = allMembersData;
        }

        members.forEach(m => {
            if (m.member_name) {
                let hasMyungui = false;

                // 명의 1
                if (m.name1) {
                    hasMyungui = true;
                    const opt1 = document.createElement('option');
                    opt1.value = `${m.member_name} (${m.name1_gubun || ''}) ${m.name1}`;
                    datalist.appendChild(opt1);
                }
                // 명의 2
                if (m.name2) {
                    hasMyungui = true;
                    const opt2 = document.createElement('option');
                    opt2.value = `${m.member_name} (${m.name2_gubun || ''}) ${m.name2}`;
                    datalist.appendChild(opt2);
                }
                // 명의 3
                if (m.name3) {
                    hasMyungui = true;
                    const opt3 = document.createElement('option');
                    opt3.value = `${m.member_name} (${m.name3_gubun || ''}) ${m.name3}`;
                    datalist.appendChild(opt3);
                }

                // 명의가 하나도 없으면 기본 이름만 표시
                if (!hasMyungui) {
                    const opt = document.createElement('option');
                    opt.value = m.member_name;
                    datalist.appendChild(opt);
                }
            }
        });
    }

    // 회원 선택 시 로직 (기존 체크박스 로직 제거 및 Datalist 활용 강화)
    function setupMemberSelectLogic() {
        const formMName = document.getElementById('form-m-name');
        if (formMName) {
            formMName.addEventListener('change', function () {
                handleMemberNameChange(this.value);
            });
            formMName.addEventListener('input', function () {
                // handleMemberNameChange(this.value); 
            });
        }
    }

    function handleMemberNameChange(value) {
        if (!value) return;

        let member = null;
        let memberList = [];
        if (typeof allMembersNewData !== 'undefined' && Array.isArray(allMembersNewData)) {
            memberList = allMembersNewData;
        } else if (typeof allMembersData !== 'undefined' && Array.isArray(allMembersData)) {
            memberList = allMembersData;
        }

        // 1. 단순 이름 매칭
        member = memberList.find(m => m.member_name === value.trim());

        if (!member) {
            // 2. 명의 포함 형식 매칭
            const parts = value.split('(');
            if (parts.length > 1) {
                const namePart = parts[0].trim();
                const candidates = memberList.filter(m => m.member_name === namePart);

                member = candidates.find(m => {
                    const myunguis = [
                        m.name1 ? `(${m.name1_gubun || ''}) ${m.name1}` : null,
                        m.name2 ? `(${m.name2_gubun || ''}) ${m.name2}` : null,
                        m.name3 ? `(${m.name3_gubun || ''}) ${m.name3}` : null
                    ];
                    return myunguis.some(suffix => suffix && `${m.member_name} ${suffix}` === value);
                });
            }
        }

        if (member) {
            const formMemberId = document.getElementById('form-member-id');
            if (formMemberId) formMemberId.value = member.member_id || '';

            if (typeof updateMemberTokenInfo === 'function') {
                updateMemberTokenInfo('main');
            }
        }
    }

    // 초기화 이벤트 연결
    document.addEventListener('DOMContentLoaded', function () {
        setupMemberSelectLogic();
        if (typeof allMembersNewData !== 'undefined' && allMembersNewData.length > 0) {
            updateMemberNameDatalistNew();
        }
    });

    // 탭 전환 등 동적 로드 고려하여 window load 시에도 실행
    window.addEventListener('load', function () {
        setupMemberSelectLogic();
    });

    // ================================================================================================
    // 옥션 원문 링크 이동 기능
    // ================================================================================================

    /**
     * 현재 활성화된 물건(메인 상세 혹은 모달 상세)의 원문 옥션 페이지를 새 탭으로 엶
     */
    function openAuctionUrl() {
        // 활성 창(모달 vs 메인 상세)에 따라 데이터 소스 결정
        const modal = document.getElementById('itemDetailModal');
        const isModalOpen = modal && !modal.classList.contains('content-hidden');
        const item = isModalOpen ? currentModalItemData : currentDetailItem;

        if (!item || !item.auction_id || !String(item.auction_id).trim()) {
            // 경매 ID 정보가 없으면 로그인 페이지로 이동하여 편의성 제공
            window.open('https://www.auction1.co.kr/common/login_box.php', '_blank');
            return;
        }

        const aid = String(item.auction_id).trim();
        const isGongmae = (item.court === '공매' || (item.sakun_no && item.sakun_no.includes('-')));

        // 설정값 확인
        const settings = (typeof auctionSettingsCache !== 'undefined') ? auctionSettingsCache : {};
        const pattern = isGongmae ? (settings.gongmae_pattern || '') : (settings.auction_pattern || '');

        let finalUrl = '';
        if (pattern && pattern.includes('[ID]')) {
            finalUrl = pattern.replace('[ID]', aid);
        } else if (pattern) {
            finalUrl = pattern + aid;
        } else {
            // 기본값 (설정이 없는 경우)
            const defaultBase = isGongmae ?
                'https://www.auction1.co.kr/auction/ca_view.php?product_id=' :
                'https://www.auction1.co.kr/auction/ca_view.php?product_id=';
            finalUrl = defaultBase + aid;
        }

        if (finalUrl) {
            window.open(finalUrl, '_blank');
        } else {
            // 경매 ID가 없는 경우 로그인 페이지로 이동하여 편의성 제공
            window.open('https://www.auction1.co.kr/common/login_box.php', '_blank');
        }
    }

    /**
     * 물건 데이터의 auction_id 존재 여부에 따라 이동 버튼 노출/숨김
     */
    function updateAuctionUrlButtonVisibility() {
        const btnMain = document.getElementById('btnAuctionGo');
        const btnDetailMain = document.getElementById('btnDetailAuctionGo');
        const btnModal = document.getElementById('btnModalAuctionGo');
        const btnModalDetail = document.getElementById('btnModalDetailAuctionGo');

        // 등록 모드인지 확인 (formId가 없으면 등록 모드)
        const isCreateMode = !formId || !formId.value;

        // 메인 상세판 버튼 처리
        const hasAidMain = currentDetailItem && currentDetailItem.auction_id && String(currentDetailItem.auction_id).trim();
        if (btnMain) {
            if (hasAidMain) btnMain.classList.remove('content-hidden');
            else btnMain.classList.add('content-hidden');
        }
        if (btnDetailMain) {
            // 상세 탭 버튼은 상시 노출 (ID 없으면 로그인 페이지로 자동 연결)
            btnDetailMain.classList.remove('content-hidden', 'hidden');
        }

        // 모달 버튼 처리
        const hasAidModal = currentModalItemData && currentModalItemData.auction_id && String(currentModalItemData.auction_id).trim();
        if (btnModal) {
            if (hasAidModal) btnModal.classList.remove('content-hidden');
            else btnModal.classList.add('content-hidden');
        }
        if (btnModalDetail) {
            // 모달 전용 버튼도 상시 노출 처리
            btnModalDetail.classList.remove('content-hidden', 'hidden');
        }
    }

    // ================================================================================================
    // 모달 탭 전환 및 조사 기능
    // ================================================================================================

    let currentModalTab = 'detail';

    function switchModalTab(tab) {
        currentModalTab = tab;
        const detailTab = document.getElementById('modal-tab-detail');
        const investigationTab = document.getElementById('modal-tab-investigation');
        const detailContent = document.getElementById('modal-detail-content');
        const investigationContent = document.getElementById('modal-investigation-content');
        const telegramToolbar = document.getElementById('modal-telegram-toolbar');
        const investigationToolbar = document.getElementById('modal-investigation-toolbar');
        const updateBtn = document.getElementById('modal-update-btn');
        const deleteBtn = document.querySelector('#itemDetailModal button[onclick*="handleModalDelete"]');

        if (tab === 'detail') {
            // 상세 탭 활성화
            if (detailTab) {
                detailTab.classList.add('text-indigo-700', 'border-indigo-700', 'bg-indigo-50', 'font-bold');
                detailTab.classList.remove('text-gray-500', 'border-transparent', 'font-medium');
            }
            if (investigationTab) {
                investigationTab.classList.remove('text-indigo-700', 'border-indigo-700', 'bg-indigo-50', 'font-bold');
                investigationTab.classList.add('text-gray-500', 'border-transparent', 'font-medium');
            }
            if (detailContent) detailContent.classList.remove('content-hidden');
            if (investigationContent) investigationContent.classList.add('content-hidden');

            // 툴바 가시성 통합 제어
            if (IS_MEMBER_VIEW) {
                if (telegramToolbar) telegramToolbar.classList.add('content-hidden');
                if (updateBtn) updateBtn.classList.add('content-hidden');
                if (deleteBtn) deleteBtn.classList.add('content-hidden');
                if (investigationToolbar) investigationToolbar.classList.add('content-hidden');
                // [삭제] 상시 노출을 위해 수동 숨김 제거
                // if (document.getElementById('btnModalDetailAuctionGo')) document.getElementById('btnModalDetailAuctionGo').classList.add('content-hidden');
            } else {
                if (telegramToolbar) telegramToolbar.classList.remove('content-hidden');
                if (updateBtn) updateBtn.classList.remove('content-hidden');
                if (deleteBtn) deleteBtn.classList.remove('content-hidden');
                if (investigationToolbar) investigationToolbar.classList.add('content-hidden');

                // 상세탭 전용 옥션원 가기 표시 및 유형 선택 표시
                const detailTelegramStyleSelect = document.getElementById('detail-telegram-style-select');
                if (detailTelegramStyleSelect) detailTelegramStyleSelect.classList.remove('hidden');

                updateAuctionUrlButtonVisibility();
            }
        } else {
            // 조사 탭 활성화
            if (detailTab) {
                detailTab.classList.remove('text-indigo-700', 'border-indigo-700', 'bg-indigo-50', 'font-bold');
                detailTab.classList.add('text-gray-500', 'border-transparent', 'font-medium');
            }
            if (investigationTab) {
                investigationTab.classList.add('text-indigo-700', 'border-indigo-700', 'bg-indigo-50', 'font-bold');
                investigationTab.classList.remove('text-gray-500', 'border-transparent', 'font-medium');
            }
            if (detailContent) detailContent.classList.add('content-hidden');
            if (investigationContent) investigationContent.classList.remove('content-hidden');

            if (telegramToolbar) telegramToolbar.classList.add('content-hidden');
            if (updateBtn) updateBtn.classList.add('content-hidden');
            if (deleteBtn) deleteBtn.classList.add('content-hidden');
            // [삭제] 상시 노출을 위해 수동 숨김 제거
            // if (document.getElementById('btnModalDetailAuctionGo')) document.getElementById('btnModalDetailAuctionGo').classList.add('content-hidden');

            if (investigationToolbar) {
                investigationToolbar.classList.remove('content-hidden');
                if (IS_MEMBER_VIEW) {
                    investigationToolbar.classList.add('content-hidden');
                }
            }

            // 조사탭 이미지 로드
            loadModalInvestigationImages();
        }

        // [NEW] 옥션원 이동 버튼 가시성 업데이트
        updateAuctionUrlButtonVisibility();
    }

    function openDetailModalWithTab(id, openInvestigation = false) {
        const item = allBiddingData.find(i => String(i.id) === String(id));
        if (item) {
            openDetailModal(item);
            if (openInvestigation) {
                setTimeout(() => {
                    switchModalTab('investigation');
                }, 100);
            } else {
                switchModalTab('detail');
            }
        } else {
            showStatus("데이터를 찾을 수 없습니다.", "error");
        }
    }

    function loadModalInvestigationImages() {
        const imageList = document.getElementById('modal-investigation-image-list');
        const placeholder = document.getElementById('modal-investigation-placeholder');
        const footer = document.getElementById('modal-investigation-image-ids-footer');

        if (!imageList || !placeholder) return;

        imageList.innerHTML = '';
        imageList.classList.add('content-hidden');
        placeholder.classList.remove('content-hidden');
        placeholder.textContent = '이미지 로딩 중...';

        if (!currentModalItemData || !currentModalItemData.id) {
            placeholder.textContent = '매칭된 이미지 없음';
            if (footer) footer.textContent = '';
            return;
        }

        google.script.run
            .withSuccessHandler(function (rows) {
                if (!rows || rows.length === 0) {
                    placeholder.textContent = '매칭된 이미지 없음';
                    if (footer) footer.textContent = '';
                    return;
                }
                placeholder.classList.add('content-hidden');
                imageList.classList.remove('content-hidden');
                const ids = rows.map(function (r) { return r.image_id; });
                if (footer) footer.textContent = 'Image ID: ' + ids.join(', ');

                rows.forEach(function (r) {
                    const wrap = document.createElement('div');
                    wrap.className = 'w-full border border-gray-200 rounded-lg overflow-hidden bg-white capture-target'; // capture-target 추가
                    const img = document.createElement('img');
                    img.className = 'investigation-image-max w-full cursor-pointer';
                    img.alt = r.file_name || '이미지';
                    img.dataset.id = r.image_id; // dataset.imageId -> dataset.id로 통일
                    img.dataset.uploader = r.uploader || '';

                    if (r.image_id) {
                        // Base64로 이미지 가져오기 시도 (로그인 권한 문제 해결)
                        img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; // placeholder
                        google.script.run
                            .withSuccessHandler(function (dataUrl) {
                                if (dataUrl) {
                                    img.src = dataUrl;
                                } else {
                                    // 실패 시 기존 썸네일이라도 시도
                                    img.src = 'https://drive.google.com/thumbnail?sz=w1600&id=' + encodeURIComponent(r.image_id);
                                }
                            })
                            .getImageDataUrl(r.image_id);

                        const auctionId = currentModalItemData ? currentModalItemData.auction_id : null;
                        let originalUrl = 'https://drive.google.com/uc?export=view&id=' + encodeURIComponent(r.image_id);

                        if (auctionId && String(auctionId).trim()) {
                            const pid = String(auctionId).trim();
                            const isGongmae = (currentModalItemData.court === '공매' || currentModalItemData.sakun_no.includes('-'));
                            const pattern = isGongmae ? auctionSettingsCache.gongmae_pattern : auctionSettingsCache.auction_pattern;

                            if (pattern && pattern.includes('[ID]')) {
                                originalUrl = pattern.replace('[ID]', pid);
                            } else if (pattern) {
                                // [ID]가 명시되지 않았으면 기본 예시처럼 뒤에 붙임 (보험용)
                                originalUrl = pattern + pid;
                            } else {
                                // 설정이 없으면 기본값 사용
                                const defaultBase = isGongmae ? 'https://www.auction1.co.kr/auction/ca_view.php?product_id=' : 'https://www.auction1.co.kr/auction/ca_view.php?product_id=';
                                originalUrl = defaultBase + pid;
                            }
                        }

                        img.onclick = (function (url) { return function () { window.open(url, '_blank'); }; })(originalUrl);
                    }
                    wrap.appendChild(img);

                    // 삭제 버튼 (Member View에서는 숨김)
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'mt-2 mx-2 mb-2 text-red-600 hover:text-red-800 text-sm font-medium';
                    if (IS_MEMBER_VIEW) btn.classList.add('content-hidden');
                    btn.textContent = '삭제(X)';
                    btn.onclick = function (ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        handleModalDeleteItemImage(currentModalItemData.id, r.image_id);
                    };
                    wrap.appendChild(btn);
                    imageList.appendChild(wrap);
                });
            })
            .withFailureHandler(function () {
                placeholder.textContent = '이미지를 불러올 수 없습니다.';
                if (footer) footer.textContent = '';
            })
            .getItemImages(currentModalItemData.id);
    }

    function handleModalDeleteItemImage(itemId, imageId) {
        if (!itemId || !imageId) return;
        if (!confirm('이 이미지를 삭제하시겠습니까?\n(구글 드라이브 휴지통으로 이동됩니다)')) return;

        google.script.run
            .withSuccessHandler(function (res) {
                if (res && res.success) {
                    showStatus('이미지를 삭제했습니다.', 'success');
                    loadModalInvestigationImages();
                } else {
                    showStatus(res && res.message ? res.message : '삭제 실패', 'error');
                }
            })
            .withFailureHandler(function (err) {
                showStatus('삭제 실패: ' + (err.message || err), 'error');
            })
            .deleteItemImage(itemId, imageId);
    }

    function handleModalInvestigationDelete() {
        // 개별 이미지 삭제는 각 이미지의 삭제 버튼 사용
        showStatus('각 이미지 아래의 "삭제(X)" 버튼을 사용하세요.', 'info');
    }

    function handleModalInvestigationPrint() {
        if (!currentModalItemData) return;

        const imageList = document.getElementById('modal-investigation-image-list');
        if (!imageList) return;

        const firstImg = imageList.querySelector('img');
        if (!firstImg || !firstImg.src) {
            showStatus('인쇄할 이미지가 없습니다.', 'error');
            return;
        }

        const printArea = document.getElementById('printInvestigationArea');
        const printImg = document.getElementById('printInvestigationImg');
        const printNoImage = document.getElementById('printInvestigationNoImage');

        if (!printArea || !printImg || !printNoImage) return;

        printNoImage.style.display = 'none';
        printImg.src = firstImg.src;
        printImg.style.display = 'block';
        printImg.onload = () => { window.print(); };
        printImg.onerror = () => {
            printImg.style.display = 'none';
            printNoImage.style.display = 'block';
            window.print();
        };
    }

    function handleModalInvestigationCopy() {
        // 모달에서도 상세 페이지와 동일한 로직(이미지 우선 복사)을 사용하도록 일원화
        handleInvestigationCopy();
    }

    function idsFromCbs(cbs) {
        return Array.from(cbs).map(cb => cb.getAttribute('data-id'));
    }

    function handleBulkAction() {
        const type = document.getElementById('bulk-action-type').value;
        const cbs = dataTableBody ? dataTableBody.querySelectorAll('input.item-row-cb:checked') : [];

        if (cbs.length === 0) {
            if (typeof showStatusMessage === 'function') showStatusMessage('항목을 먼저 선택해 주세요.', 'warning');
            return;
        }

        if (type === 'status') {
            openBulkStatusModal(cbs);
        } else if (type === 'delete') {
            handleBulkDelete(idsFromCbs(cbs));
        } else {
            if (typeof showStatusMessage === 'function') showStatusMessage('작업 유형을 선택해 주세요.', 'warning');
        }
    }

    function openBulkStatusModal(selectedCbs) {
        const countSpan = document.getElementById('bulk-status-count');
        const listDiv = document.getElementById('bulk-status-list');
        const modal = document.getElementById('bulkStatusModal');

        if (countSpan) countSpan.textContent = selectedCbs.length;
        if (listDiv) {
            listDiv.innerHTML = '';
            selectedCbs.forEach(cb => {
                const sakunNo = cb.getAttribute('data-sakun-no');
                const status = cb.getAttribute('data-status');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between py-1 border-b border-gray-100 last:border-0';
                itemDiv.innerHTML = `<span>${sakunNo}</span><span class="font-medium text-indigo-500">${status}</span>`;
                listDiv.appendChild(itemDiv);
            });
        }

        if (modal) modal.classList.remove('content-hidden');
    }

    function closeBulkStatusModal() {
        const modal = document.getElementById('bulkStatusModal');
        if (modal) modal.classList.add('content-hidden');
    }

    function applyBulkStatusUpdate() {
        const newStatus = document.getElementById('bulk-new-status').value;
        const cbs = dataTableBody.querySelectorAll('input.item-row-cb:checked');
        const ids = idsFromCbs(cbs);

        if (ids.length === 0 || !newStatus) return;

        if (typeof showStatusMessage === 'function') showStatusMessage(`${ids.length}건의 상태를 '${newStatus}'(으)로 변경 중...`, 'info');

        google.script.run
            .withSuccessHandler(res => {
                if (res && res.success) {
                    if (typeof showStatusMessage === 'function') showStatusMessage(res.message || '일괄 변경이 완료되었습니다.', 'success');
                } else {
                    if (typeof showStatusMessage === 'function') showStatusMessage((res && res.message) ? res.message : '변경 중 일부 오류가 발생했습니다.', 'warning');
                }
                closeBulkStatusModal();
                loadData(true);
            })
            .withFailureHandler(err => {
                console.error('Bulk update error:', err);
                if (typeof showStatusMessage === 'function') showStatusMessage('서버 통신 중 오류가 발생했습니다.', 'error');
                loadData(true);
            })
            .updateBulkStatus(ids, newStatus);
    }

    function handleBulkDelete(ids) {
        if (!confirm(`선택한 ${ids.length}개의 물건을 정말 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
            return;
        }

        if (typeof showStatusMessage === 'function') showStatusMessage(`${ids.length}건 삭제 중...`, 'info');

        Promise.all(ids.map(id => {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .deleteData(id);
            });
        }))
            .then(() => {
                if (typeof showStatusMessage === 'function') showStatusMessage('일괄 삭제가 완료되었습니다.', 'success');
                loadData(true);
            })
            .catch(err => {
                console.error('Bulk delete error:', err);
                if (typeof showStatusMessage === 'function') showStatusMessage('삭제 중 일부 오류가 발생했습니다.', 'error');
                loadData(true);
            });
    }
    // ================================================================================================
    // 회원 대시보드 (MemberDashboard) - 상태필터 + 월별캘린더(동그라미) + 물건목록
    // ================================================================================================

    let memberDashCalDate = new Date(); // 현재 표시 중인 월
    let memberDashSelectedDate = null; // 선택된 날짜 (YYMMDD)

    // 상태 → 동그라미 색상 매핑 (상단 카드 활성 색상과 동기화 - 더 진하게)
    const MEMBER_DASH_STATUS_COLORS = {
        '입찰': '#818cf8',   // Vivid Indigo
        '추천': '#fb923c',   // Vivid Orange
        '변경': '#6b7280',   // Gray (기존 유지)
        '미정': '#e5e7eb',
        '상품': '#fef9c3'
    };

    /**
     * 현재 선택된 상태 필터 목록 반환
     */
    function getSelectedMemberDashStatuses() {
        const cards = document.querySelectorAll('#memberDashSummary .member-dash-card.active');
        return Array.from(cards).map(c => c.getAttribute('data-status'));
    }

    /**
     * 상태 카드 필터 토글
     */

    /* =============================================
       오퍼스(Opus) 멤버 대시보드 v2 엔진
       ============================================= */
    var mD = new Date(); // 현재 캘린더 월
    var mS = [];         // [수정] 다중 선택을 위해 배열로 변경
    var fS = ['입찰', '추천', '변경']; // 활성 필터
    var tR = 'today';    // 범위: 'today'(오늘부터) 또는 'all'(전체)

    // [전역 변수] 오늘 날짜 문자열 (YYMMDD) - rCal과 selD 공용
    var now_init = new Date();
    var tS = String(now_init.getFullYear()).slice(-2) + String(now_init.getMonth() + 1).padStart(2, '0') + String(now_init.getDate()).padStart(2, '0');

    /**
     * 초기화 및 데이터 로드 후 호출
     */
    function renderMemberDashboard() {
        rCal(); // 캘린더 렌더링
        rLst(); // 리스트 렌더링
    }

    /**
     * 월 변경
     */
    function chMo(d) {
        mD.setMonth(mD.getMonth() + d);
        mS = []; // [수정] 월 변경 시 모든 선택 해제
        rCal();
        rLst();
    }

    /**
     * 범위 설정 (오늘부터 / 전체)
     */
    function setR(r) {
        tR = r;
        // UI 버튼 업데이트
        ['tT', 'tA', 'rT', 'rA'].forEach(function (id) {
            var el = document.getElementById(id);
            if (!el) return;
            var isOn = (id.slice(-1) === (r === 'today' ? 'T' : 'A'));
            el.classList.toggle('on', isOn);
        });
        rCal();
        rLst();
    }

    /**
     * 상태 필터 토글
     */
    function togF(f) {
        var idx = fS.indexOf(f);
        if (idx > -1) fS.splice(idx, 1);
        else fS.push(f);

        // 상단바 버튼 투명도 조절로 선택 상태 표시
        var btnMap = { '입찰': 'btn-top-bid', '추천': 'btn-top-rec', '변경': 'btn-top-chg' };
        if (btnMap[f]) {
            var el = document.getElementById(btnMap[f]);
            if (el) {
                // 필터에서 빠지면 투명하게(off), 포함되면 선명하게
                el.style.opacity = (idx > -1) ? '0.3' : '1';
                el.style.filter = (idx > -1) ? 'grayscale(1)' : 'none';
            }
        }
        rCal();
        rLst();
    }

    /**
     * 캘린더 렌더링 (동그라미 방식)
     */
    function rCal() {
        var grid = document.getElementById('cG');
        var title = document.getElementById('cT');
        if (!grid || !title) return;

        var y = mD.getFullYear();
        var m = mD.getMonth();
        title.textContent = y + '년 ' + (m + 1) + '월';

        var yS = String(y).slice(-2);
        var mS_str = String(m + 1).padStart(2, '0');
        // tS는 이제 전역 변수를 사용함

        // 데이터 요약: 숫자는 오늘부터/전체(tR)에만 반응하고 필터(fS)에는 반응하지 않음
        var counts = {};
        var counts_month = { '입찰': 0, '추천': 0, '변경': 0 };

        allBiddingData.forEach(function (item) {
            var dt = String(item['in-date'] || '');
            if (dt.length < 6) return;
            var s = String(item.stu_member || '미정');

            // 1. 해당 월 통계 계산 (tR 범위 적용)
            if (dt.substring(0, 4) === (yS + mS_str)) {
                var inRange = true;
                if (tR === 'today' && dt < tS) inRange = false;

                if (inRange && counts_month.hasOwnProperty(s)) {
                    counts_month[s]++;
                }

                if (!counts[dt]) counts[dt] = { '입찰': 0, '추천': 0, '변경': 0 };
                counts[dt][s]++;
            }
        });

        // 월별 요약 업데이트 (네비게이션 연월 아래 - 컬러 텍스트, 괄호 추가, 밀착)
        var msEl = document.getElementById('cMS');
        if (msEl) {
            msEl.innerHTML =
                '(' +
                '<span class="ms-it bid">입찰 ' + (counts_month['입찰'] || 0) + '</span>' +
                ' <span class="ms-it rec">추천 ' + (counts_month['추천'] || 0) + '</span>' +
                ' <span class="ms-it chg">변경 ' + (counts_month['변경'] || 0) + '</span>' +
                ')';
        }

        // 이전/다음달 힌트
        rHint(y, m);

        grid.innerHTML = '';
        var fD = new Date(y, m, 1).getDay(); // 0(일)~6(토)
        if (fD === 0) fD = 7; fD--; // 월(0)~금(4) 기준으로 조정

        var lD = new Date(y, m + 1, 0).getDate();

        // 빈 칸 (평일만 표시하므로 5열 기준)
        for (var i = 0; i < fD && i < 5; i++) {
            grid.insertAdjacentHTML('beforeend', '<div class="cd e"></div>');
        }

        for (var d = 1; d <= lD; d++) {
            var curr = new Date(y, m, d);
            var wk = curr.getDay();
            if (wk === 0 || wk === 6) continue;

            var dS = yS + mS_str + String(d).padStart(2, '0');

            // [수정] 과거 날짜도 박스와 숫자는 항상 보이게 함. 다만 지시대로 테두리/바탕색/점만 숨김.
            var isPastToday = (tR === 'today' && dS < tS);

            var items = counts[dS] || {};
            var has = (items['입찰'] > 0 || items['추천'] > 0 || items['변경'] > 0);
            var isT = (dS === tS);
            var isS = (mS.indexOf(dS) > -1);

            // [지시사항] 지표 형태 다변화 및 겹침 로직
            var dotH = '';
            if (!isPastToday) {
                var sOrder = ['입찰', '추천', '변경'];
                var colors = { '입찰': '#4f46e5', '추천': '#fb923c', '변경': '#1f2937' };
                var shapes = { '입찰': '', '추천': 'tri', '변경': 'sq' };

                var lastS = '';
                sOrder.forEach(function (s) {
                    if (fS.indexOf(s) === -1) return;
                    var c = items[s] || 0;
                    for (var j = 0; j < c; j++) {
                        var style = (s === '추천') ? 'color:' + colors[s] : 'background:' + colors[s];
                        var ovlCls = (s === lastS) ? 'ovl' : '';
                        dotH += '<div class="dc ' + shapes[s] + ' ' + ovlCls + '" style="' + style + '"></div>';
                        lastS = s;
                    }
                });
            }

            var cls = 'cd';
            if (isT) cls += ' t';
            if (has && !isPastToday) {
                if (dS >= tS) cls += ' fh';
                else cls += ' ph';
            }
            if (isS) cls += ' sel';

            var checkH = isS ? '<span style="color:#ef4444; font-weight:bold; margin-right:2px;">✓</span>' : '';

            var h3 = '<div class="' + cls + '" onclick="selD(\'' + dS + '\')">' +
                '<div class="dn">' + checkH + d + '</div>' +
                '<div class="dcs">' + dotH + '</div>' +
                '</div>';
            grid.insertAdjacentHTML('beforeend', h3);
        }
    }

    /**
     * 이전/다음달 힌트 (상태별 건수)
     */
    function rHint(y, m) {
        var pEl = document.getElementById('dP');
        var nEl = document.getElementById('dN');
        if (!pEl || !nEl) return;

        var pM = new Date(y, m - 1, 1);
        var nM = new Date(y, m + 1, 1);
        var pY = String(pM.getFullYear()).slice(-2);
        var pM_s = String(pM.getMonth() + 1).padStart(2, '0');
        var nY = String(nM.getFullYear()).slice(-2);
        var nM_s = String(nM.getMonth() + 1).padStart(2, '0');

        var pC = { '입찰': 0, '추천': 0, '변경': 0 };
        var nC = { '입찰': 0, '추천': 0, '변경': 0 };

        allBiddingData.forEach(function (item) {
            var dt = String(item['in-date'] || '');
            var s = String(item.stu_member || '');
            if (dt.substring(0, 4) === (pY + pM_s)) {
                if (pC.hasOwnProperty(s)) pC[s]++;
            } else if (dt.substring(0, 4) === (nY + nM_s)) {
                if (nC.hasOwnProperty(s)) nC[s]++;
            }
        });

        pEl.innerHTML = '';
        nEl.innerHTML = '';
        var sOrder = ['입찰', '추천', '변경'];
        var colors = { '입찰': '#4f46e5', '추천': '#fb923c', '변경': '#1f2937' };
        var shapes = { '입찰': 'cir', '추천': 'tri', '변경': 'sq' };

        sOrder.forEach(function (s) {
            if (pC[s] > 0) {
                var itH = '<div class="hi-it">' +
                    '<div class="cdot ' + shapes[s] + '" data-val="' + pC[s] + '" style="' + (s === '추천' ? 'color:' + colors[s] : 'background:' + colors[s]) + '">' + (s === '추천' ? '' : pC[s]) + '</div>' +
                    '</div>';
                pEl.innerHTML += itH;
            }
            if (nC[s] > 0) {
                var itH = '<div class="hi-it">' +
                    '<div class="cdot ' + shapes[s] + '" data-val="' + nC[s] + '" style="' + (s === '추천' ? 'color:' + colors[s] : 'background:' + colors[s]) + '">' + (s === '추천' ? '' : nC[s]) + '</div>' +
                    '</div>';
                nEl.innerHTML += itH;
            }
        });
    }

    /**
     * 날짜 선택 (리스트 앵커로 스크롤)
     */
    function selD(d) {
        // [지시사항] 물건이 없는 빈 칸은 체크(✓) 되지 않게 함
        var items = allBiddingData.filter(function (it) {
            return String(it['in-date'] || '').substring(0, 6) === d;
        });

        // 필터링된 데이터 중 실제 '입찰', '추천', '변경' 상태인 것이 하나라도 있어야 함
        var hasTrueItems = items.some(function (it) {
            var s = it.stu_member || '';
            return s === '입찰' || s === '추천' || s === '변경';
        });

        if (!hasTrueItems) {
            console.log('Selection blocked: No bidding items on', d);
            return;
        }

        console.log('Selected Date:', d, 'Today String:', tS, 'Mode:', tR);
        // [긴급 복구] 오늘부터 모드에서 진짜 과거인 경우만 차단
        if (tR === 'today' && d < tS) {
            console.log('Blocked: Past date selection in Today mode');
            return;
        }

        var idx = mS.indexOf(d);
        if (idx > -1) {
            mS.splice(idx, 1);
        } else {
            mS.push(d);
        }
        rCal(); // 화면 갱신
        rLst(); // 리스트 연동
    }

    /**
     * 리스트 렌더링
     */
    function rLst() {
        var el = document.getElementById('iL');
        if (!el) return;

        var now = new Date();
        var tS = String(now.getFullYear()).slice(-2) + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');

        // 필터링 적용
        var filtered = allBiddingData.filter(function (item) {
            var dt = String(item['in-date'] || '');
            var s = String(item.stu_member || '미정');

            // [지시사항 3] 상단바 상태(fS) 필터에 부합하는 물건만
            if (fS.indexOf(s) === -1) return false;

            // [지시사항 1] 날짜 다중 선택된 일자(mS)에 해당하는 물건만
            if (mS.indexOf(dt) === -1) return false;

            return true;
        });

        if (filtered.length === 0) {
            el.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#94a3b8; font-size:0.95rem; font-weight:500;">' +
                '날짜를 선택하시면 물건카드가 보입니다.</div>';
            return;
        }

        // 정렬: 날짜순 -> 사건번호순
        filtered.sort(function (a, b) {
            var da = String(a['in-date'] || '');
            var db = String(b['in-date'] || '');
            if (da !== db) return da.localeCompare(db);
            return String(a['sakun-no'] || '').localeCompare(String(b['sakun-no'] || ''));
        });

        var html = '';
        var lastD = '';

        filtered.forEach(function (item) {
            html += cItem(item);
        });

        el.innerHTML = html;
    }

    /**
     * 물건 카드 HTML 생성
     */
    var N_MAP = { '대표님': 'MJ', '전제혁': '전부쌤' };
    function mapN(n) { return N_MAP[n] || n; }
    function fmtP(n) { return n ? new Intl.NumberFormat('ko-KR').format(parseInt(n)) : '0'; }

    function cItem(i) {
        var s = String(i.stu_member || '미정');
        var cls = 'ic';
        var borderCol = '#e2e8f0'; // 기본 색상

        if (s === '입찰') { cls += ' sb'; borderCol = '#4f46e5'; }
        else if (s === '추천') { cls += ' sr'; borderCol = '#fb923c'; }
        else if (s === '변경') { cls += ' sc'; borderCol = '#1f2937'; }

        var bCls = 'badge';
        var bTxt = s;
        if (s === '입찰') bCls += ' bb';
        else if (s === '추천') bCls += ' br';
        else if (s === '변경') bCls += ' bc';

        // 서버 헤더와 일치하도록 키 수정
        var sk = String(i.sakun_no || '');
        var ct = String(i.court || '');
        var pr = i.bidprice ? fmtP(i.bidprice) : '0';
        var m_nm = mapN(String(i.m_name_id || ''));
        var tm = String(i.reg_date || '').substring(11, 16); // 시간 추출

        // [수정] 입찰일자 배지: 카드 상단에 딱 붙임 (Flush with top-left)
        var dt = String(i['in-date'] || '');
        var dtLabel = dt.substring(2, 4) + '월 ' + dt.substring(4, 6) + '일';
        var dtStyle = 'background-color:' + borderCol + '; color:#fff; font-size:0.75rem; padding:2px 10px; border-radius:10px 0 10px 0; font-weight:800; position:absolute; top:0; left:0; z-index:10;';

        var h = '<div class="' + cls + '" style="position:relative; padding-top:24px; margin-top:4px;">' +
            '<div class="ic-in-date" style="' + dtStyle + '">' + dtLabel + '</div>' +
            '<div class="ic-l" onclick="showInvestigationDetail(\'' + i.id + '\')">' +
            '<div class="ic-copy-row">' +
            '<div class="ic-sakun">' + sk + '</div>' +
            '<button class="copy-btn" onclick="event.stopPropagation();copyT(\'' + sk + '\', event)">' +
            '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>' +
            '</button>' +
            '</div>' +
            '<div class="ic-court">' + ct + ' / ' + m_nm + '</div>' +
            '<div class="ic-copy-row">' +
            '<div class="ic-price">' + (pr === '0' ? '가격미정' : pr + ' 원') + '</div>' +
            '<button class="copy-btn" onclick="event.stopPropagation();copyT(\'' + pr + '\', event)">' +
            '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>' +
            '</button>' +
            '</div>' +
            '</div>' +
            '<div class="ic-r">' +
            '<div class="ic-r-row">' +
            '<button class="' + bCls + '" onclick="setB(\'' + i.id + '\', \'' + s + '\', \'' + sk + '\')">' + bTxt + '</button>' +
            '<button class="img-btn" onclick="openImgPopup(\'' + i.id + '\')">🖼️</button>' +
            '</div>' +
            '<div class="ic-time">' + tm + '</div>' +
            '</div>' +
            '</div>';
        return h;
    }

    /**
     * 클립보드 복사
     */
    function copyT(t, e) {
        if (e) e.stopPropagation();
        var tmp = document.createElement('textarea');
        tmp.value = t;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);

        var toast = document.getElementById('copyToast');
        if (toast) {
            toast.classList.add('show');
            setTimeout(function () { toast.classList.remove('show'); }, 1500);
        }
    }

    /**
     * 이미지 팝업 열기 (실제 조사 상세와 연동)
     */
    function openImgPopup(id) {
        // [수정] 팝업만 띄우는 대신 조사 상세 모달을 활용하거나 연동
        showInvestigationDetail(id);
    }
    function closeImgPopup() {
        var p = document.getElementById('imgPopup');
        if (p) p.classList.remove('open');
    }

    /**
     * 모달 제천
     */
    function cm(id) {
        var m = document.getElementById(id);
        if (m) m.classList.remove('open');
    }

    /**
     * 입찰 액션 처리
     */
    var curI = null; // 현재 타겟 ID
    function setB(id, s, sk) {
        curI = id;
        if (s === '입찰') {
            document.getElementById('mBD').textContent = '[' + sk + ']';
            document.getElementById('mBC').classList.add('open');
        } else if (s === '추천') {
            document.getElementById('mRT').textContent = '[' + sk + ']';
            document.getElementById('mRA').classList.add('open');
        }
    }

    /**
     * 서버 통신 (google.script.run 연동)
     */
    function doBC() { // 입찰 취소
        if (!curI) return;
        cm('mBC');
        showLoading(true);
        google.script.run
            .withSuccessHandler(function () {
                showLoading(false);
                loadDataAndRenderMemberDashboard(true); // 데이터 갱신
            })
            .cancelBidding(curI);
    }

    function doRC() { // 추천 -> 입찰 확정
        if (!curI) return;
        cm('mRA');
        showLoading(true);
        google.script.run
            .withSuccessHandler(function () {
                showLoading(false);
                loadDataAndRenderMemberDashboard(true);
            })
            .applyBidding(curI);
    }

    function doRX() { // 추천 거절
        if (!curI) return;
        cm('mRA');
        showLoading(true);
        google.script.run
            .withSuccessHandler(function () {
                showLoading(false);
                loadDataAndRenderMemberDashboard(true);
            })
            .rejectBidding(curI);
    }

</script>