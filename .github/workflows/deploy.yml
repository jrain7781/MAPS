name: Deploy to Google Apps Script

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create clasprc.json
        env:
          CLASP_SETTING: ${{ secrets.CLASP_SETTING }}
        run: |
          node -e "
          const fs = require('fs');
          const os = require('os');
          const path = require('path');
          const raw = JSON.parse(process.env.CLASP_SETTING);

          let output;
          if (raw.token) {
            output = raw;
          } else if (raw.tokens && raw.tokens.default) {
            const t = raw.tokens.default;
            output = {
              token: {
                access_token: t.access_token,
                refresh_token: t.refresh_token,
                scope: 'https://www.googleapis.com/auth/script.deployments https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/cloud-platform',
                token_type: t.token_type || 'Bearer',
                expiry_date: t.expiry_date
              },
              oauth2ClientSettings: {
                clientId: t.client_id,
                clientSecret: t.client_secret,
                redirectUri: 'http://localhost'
              },
              isLocalCreds: false
            };
          }

          fs.writeFileSync(path.join(os.homedir(), '.clasprc.json'), JSON.stringify(output));
          console.log('clasprc.json created successfully.');
          "

      - name: Update Deploy Info
        run: |
          cat > _DeployInfo.js << 'DEPLOY_EOF'
          /**
           * === 배포 정보 (GitHub Actions 자동 업데이트) ===
           * GAS에서 이 파일을 열면 마지막 배포 시간을 확인할 수 있습니다.
           */
          var DEPLOY_INFO = {
            version: '${{ github.run_number }}',
            commit: '${{ github.sha }}',
            deployedAt: '$(date -u +"%Y-%m-%d %H:%M:%S UTC")',
            branch: '${{ github.ref_name }}',
            message: $(git log -1 --pretty=format:'"%s"')
          };
          DEPLOY_EOF

      - name: Deploy to GAS
        run: npx @google/clasp push --force
